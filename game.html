<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Game</title>
    <link rel="icon" type="image/x-icon" href="images/logo.png">
    <link rel="stylesheet" href="styles.css" />

    <!-- ‚úÖ Page Guard + Premium Timer UI (only what game.html needs) -->
    <style>
        body {
            visibility: hidden;
        }
        /* ===== Tabs ===== */
        
        .wg-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }
        
        .wg-tab {
            padding: 10px 14px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(255, 255, 255, .04);
            color: var(--text);
            cursor: pointer;
            font-weight: 800;
            flex: 0 0 auto;
        }
        
        .wg-tab.active {
            background: linear-gradient(135deg, var(--brand), var(--brand2));
            border: 0
        }
        /* ===== Premium Timer Topbar ===== */
        
        .wg-topbar {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap
        }
        
        .wg-top-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap
        }
        
        .wg-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(255, 255, 255, .04);
            font-weight: 900;
            font-size: 12px;
            color: rgba(255, 255, 255, .92);
            white-space: nowrap;
        }
        
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            display: inline-block
        }
        
        .dot-live {
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, .12)
        }
        
        .dot-lock {
            background: #f59e0b;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, .12)
        }
        
        .dot-end {
            background: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, .12)
        }
        
        .wg-meta {
            padding: 10px 12px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(0, 0, 0, .15);
            min-width: 180px;
        }
        
        .wg-meta-label {
            font-size: 12px;
            color: rgba(255, 255, 255, .65)
        }
        
        .wg-meta-value {
            margin-top: 4px;
            font-size: 16px;
            font-weight: 1000;
            letter-spacing: .6px;
            color: #e8efff;
            word-break: break-word;
        }
        
        .wg-top-right {
            margin-left: auto;
            min-width: 320px;
            flex: 1;
            display: flex;
            justify-content: flex-end
        }
        
        .wg-timer-card {
            width: min(420px, 100%);
            padding: 12px 14px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(0, 0, 0, .16));
            box-shadow: 0 12px 50px rgba(0, 0, 0, .25);
        }
        
        .wg-timer-title {
            font-size: 12px;
            color: rgba(255, 255, 255, .70);
            font-weight: 900
        }
        
        .wg-timer-time {
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px
        }
        
        .wg-t {
            width: 44px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(0, 0, 0, .18);
            font-weight: 1100;
            font-size: 26px;
        }
        
        .wg-colon {
            font-weight: 1100;
            font-size: 24px;
            opacity: .9;
            margin: 0 2px
        }
        
        .wg-timer-sub {
            margin-top: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, .70);
            text-align: right
        }
        
        .wg-progress {
            margin-top: 10px;
            height: 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(0, 0, 0, .18);
            overflow: hidden;
        }
        
        .wg-progress-bar {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(34, 197, 94, .95), rgba(255, 59, 59, .95));
            transition: width .25s ease;
            width: 0%;
        }
        
        @media (max-width:700px) {
            .wg-top-right {
                min-width: 100%;
                justify-content: stretch;
                margin-left: 0
            }
            .wg-meta {
                min-width: 100%
            }
            .wg-timer-card {
                width: 100%
            }
            .wg-timer-time {
                justify-content: space-between
            }
            .wg-tab {
                flex: 1;
                text-align: center
            }
        }
        
        @media (max-width:420px) {
            .wg-t {
                width: 38px;
                height: 46px;
                font-size: 22px;
                border-radius: 12px
            }
            .wg-meta-value {
                font-size: 15px
            }
        }
        /* ===== Other small UI from your page ===== */
        
        .wg-colors {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }
        
        .wg-color {
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .04);
            color: #fff;
            cursor: pointer;
            font-weight: 900;
            flex: 1;
            min-width: 160px;
        }
        
        .wg-color.green {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            border: 0
        }
        
        .wg-color.red {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            border: 0
        }
        
        .wg-color.violet {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border: 0
        }
        
        .wg-color.active,
        .wg-num.active,
        .wg-bs-btn.active {
            outline: 3px solid rgba(255, 255, 255, .35)
        }
        
        .wg-numbers {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px
        }
        
        .wg-num {
            height: 44px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .04);
            color: #fff;
            font-weight: 900;
            cursor: pointer;
        }
        
        .wg-bs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }
        
        .wg-bs-btn {
            padding: 12px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .04);
            color: #fff;
            font-weight: 900;
            cursor: pointer;
        }
        
        .wg-bs-btn.big {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            border: 0;
            color: #111827
        }
        
        .wg-bs-btn.small {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            border: 0
        }
        
        .bet-lock {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .03);
            color: var(--muted);
            font-size: 12px
        }
        
        .bet-open {
            color: #86efac
        }
        
        .bet-closed {
            color: #fca5a5
        }
        
        .chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px
        }
        
        .chipbtn {
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .04);
            color: #fff;
            font-weight: 900;
            cursor: pointer;
            min-width: 72px;
            text-align: center;
        }
        
        .chipbtn:hover {
            background: rgba(255, 255, 255, .08)
        }
        
        @media (max-width:520px) {
            .wg-numbers {
                grid-template-columns: repeat(4, 1fr)
            }
            .wg-color {
                min-width: 100%
            }
        }
        
        @media (max-width:380px) {
            .wg-numbers {
                grid-template-columns: repeat(3, 1fr)
            }
        }
        /* Popup */
        
        .pop-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 18px;
            z-index: 999
        }
        
        .pop {
            width: min(420px, 100%);
            border-radius: 22px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, .12);
            background: linear-gradient(180deg, rgba(255, 72, 72, .95), rgba(255, 190, 120, .20));
            box-shadow: 0 30px 80px rgba(0, 0, 0, .55)
        }
        
        .pop-top {
            padding: 18px 16px 14px;
            text-align: center;
            background: linear-gradient(180deg, rgba(255, 120, 80, .95), rgba(255, 60, 60, .95))
        }
        
        .pop-title {
            font-size: 20px;
            font-weight: 1000;
            color: #fff
        }
        
        .pop-sub {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap
        }
        
        .chip {
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(0, 0, 0, .20);
            color: #fff;
            font-weight: 800;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, .22)
        }
        
        .pop-body {
            background: rgba(11, 18, 32, .65);
            padding: 16px
        }
        
        .ticket {
            border-radius: 20px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .10), rgba(255, 255, 255, .03));
            border: 1px solid rgba(255, 255, 255, .12);
            padding: 14px
        }
        
        .bonus {
            font-size: 28px;
            font-weight: 1000;
            color: #fff;
            text-align: center;
            margin: 6px 0
        }
        
        .bonus.lose {
            color: #fecaca
        }
        
        .periodline {
            color: rgba(255, 255, 255, .85);
            font-size: 12px;
            text-align: center
        }
        
        .pop-actions {
            display: flex;
            justify-content: center;
            padding: 14px
        }
        
        .pop-actions .btn {
            min-width: 140px
        }
    </style>
</head>

<body>
    <!-- ===== Header ===== -->
    <div class="nav">
        <div class="container">
            <div class="row header-row">
                <div class="brand">
                    <a href="index.html"><img src="logo.png" alt="Logo" class="logo"></a>
                </div>
                <div class="row-actions">
                    <button class="btn secondary small" id="btnLogout" type="button">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- ===== Wallet ===== -->
        <div class="card">
            <div class="h2">My Wallet</div>
            <div class="kpi">
                <div class="box">
                    <div class="label">Client ID</div>
                    <div class="val" id="cid">-</div>
                </div>
                <div class="box">
                    <div class="label">Name</div>
                    <div class="val" id="nm">-</div>
                </div>
                <div class="box">
                    <div class="label">Balance</div>
                    <div class="val" id="pts">0</div>
                    <div class="small" id="ptsInr" style="margin-top:6px;">‚Çπ0.00</div>
                </div>
            </div>

            <div class="small" style="margin-top:10px;">
                Min Bet: <b>50</b> | Max Bet: <b>Wallet Balance</b> |
                <span class="bet-lock" id="betWindow">Betting: <b class="bet-open">OPEN</b> (first 30 sec)</span>
            </div>
        </div>

        <!-- ===== Game ===== -->
        <div class="card" style="margin-top:14px;">
            <!-- Premium topbar -->
            <div class="wg-topbar">
                <div class="wg-top-left">
                    <div class="wg-chip" aria-live="polite">
                        <span class="dot dot-live" id="wgDot"></span>
                        <span id="wgStatusText">LIVE</span>
                    </div>

                    <div>
                        <div class="h2" style="margin:0;">Win Go</div>
                        <div class="small">Choose Color / Number / Big-Small. Result at round end.</div>
                    </div>

                    <div class="wg-meta">
                        <div class="wg-meta-label">Period</div>
                        <div class="wg-meta-value" id="periodId">-</div>
                    </div>
                </div>

                <div class="wg-top-right">
                    <div class="wg-timer-card">
                        <div class="wg-timer-title">Remaining</div>

                        <div class="wg-timer-time" role="timer" aria-live="polite">
                            <span class="wg-t" id="tm_m1">0</span>
                            <span class="wg-t" id="tm_m2">0</span>
                            <span class="wg-colon">:</span>
                            <span class="wg-t" id="tm_s1">0</span>
                            <span class="wg-t" id="tm_s2">0</span>
                        </div>

                        <div class="wg-timer-sub" id="wgTimerHint">Place bets before time ends</div>

                        <div class="wg-progress">
                            <div class="wg-progress-bar" id="wgProgressBar"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="hr"></div>

            <!-- Tabs -->
            <div class="wg-tabs">
                <button class="wg-tab active" id="tab1m" type="button">1 Min</button>
                <button class="wg-tab" id="tab3m" type="button">3 Min</button>
            </div>

            <div class="grid two" style="margin-top:12px;">
                <!-- LEFT -->
                <div class="card" style="padding:12px;">
                    <div class="h2" style="margin-top:0;">Select Bet</div>

                    <div class="small" style="margin-bottom:8px;">Color</div>
                    <div class="wg-colors">
                        <button class="wg-color green" id="btnGreen" type="button">Green</button>
                        <button class="wg-color violet" id="btnViolet" type="button">Violet</button>
                        <button class="wg-color red" id="btnRed" type="button">Red</button>
                    </div>

                    <div class="hr"></div>

                    <div class="small" style="margin-bottom:8px;">Number (0-9)</div>
                    <div class="wg-numbers" id="numGrid"></div>

                    <div class="hr"></div>

                    <div class="small" style="margin-bottom:8px;">Big / Small</div>
                    <div class="wg-bs">
                        <button class="wg-bs-btn big" id="btnBig" type="button">Big</button>
                        <button class="wg-bs-btn small" id="btnSmall" type="button">Small</button>
                    </div>
                </div>

                <!-- RIGHT -->
                <div class="card" style="padding:12px;">
                    <div class="h2" style="margin-top:0;">Place Bet</div>

                    <div class="input">
                        <label>Selected Bet</label>
                        <input id="selBet" readonly placeholder="Choose any one option" />
                    </div>

                    <div class="input">
                        <label>Bet Amount (min 50)</label>
                        <input id="betAmt" type="number" min="50" placeholder="Enter points" />
                        <div class="small" id="betAmtInr">‚Çπ0.00</div>

                        <div class="chips" id="chipsRow">
                            <button class="chipbtn" type="button" data-chip="50">50</button>
                            <button class="chipbtn" type="button" data-chip="100">100</button>
                            <button class="chipbtn" type="button" data-chip="200">200</button>
                            <button class="chipbtn" type="button" data-chip="500">500</button>
                            <button class="chipbtn" type="button" data-chip="1000">1000</button>
                        </div>
                    </div>

                    <div class="row-actions">
                        <button class="btn" id="btnBet" type="button">Confirm Bet</button>
                        <button class="btn secondary" id="btnClear" type="button">Clear</button>
                    </div>

                    <div class="notice" id="betMsg" style="display:none;margin-top:10px;"></div>

                    <div class="hr"></div>

                    <div class="h2" style="margin-top:0;">Latest Result</div>
                    <div class="kpi">
                        <div class="box">
                            <div class="label">Number</div>
                            <div class="val" id="resNum">-</div>
                        </div>
                        <div class="box">
                            <div class="label">Color</div>
                            <div class="val" id="resColor">-</div>
                        </div>
                        <div class="box">
                            <div class="label">Big/Small</div>
                            <div class="val" id="resBS">-</div>
                        </div>
                    </div>

                    <div class="notice" id="roundMsg" style="display:none;margin-top:10px;"></div>

                    <div class="hr"></div>
                    <div class="small">Rule: Bet place hote hi amount minus hota hai. Win pe <b>+2x</b> add hota hai.</div>
                </div>
            </div>
        </div>

        <!-- ===== History ===== -->
        <div class="card" style="margin-top:14px;">
            <div class="row-actions" style="justify-content:space-between;">
                <div>
                    <div class="h2" style="margin:0;">Game History</div>
                    <div class="small">Last 30 records</div>
                </div>
                <button class="btn secondary small" id="btnRefresh" type="button">Refresh</button>
            </div>

            <div style="overflow:auto;margin-top:10px;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Period</th>
                            <th>Mode</th>
                            <th>Bet</th>
                            <th>Result</th>
                            <th>Before</th>
                            <th>After</th>
                        </tr>
                    </thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- ===== Result Popup ===== -->
    <div class="pop-backdrop" id="popBack">
        <div class="pop" role="dialog" aria-modal="true">
            <div class="pop-top">
                <div class="pop-title" id="popTitle">Congratulations</div>
                <div class="pop-sub" id="popChips"></div>
            </div>
            <div class="pop-body">
                <div class="ticket">
                    <div class="small" style="text-align:center;color:rgba(255,255,255,.85)">Bonus</div>
                    <div class="bonus" id="popBonus">‚Çπ0.00</div>
                    <div class="periodline" id="popPeriod">Period: -</div>
                </div>
            </div>
            <div class="pop-actions">
                <button class="btn" id="popOk" type="button">OK</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <script>


        const firebaseConfig = {
  // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBZFAk80TlzESxnFNlG0uonVyLj3bQ3PRo",
  authDomain: "wingo-app-f68dd.firebaseapp.com",
  projectId: "wingo-app-f68dd",
  storageBucket: "wingo-app-f68dd.firebasestorage.app",
  messagingSenderId: "533037771285",
  appId: "1:533037771285:web:d72372f86108a8379dbc1c",
  measurementId: "G-RJ1XX4FX3W"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
};
firebase.initializeApp(firebaseConfig);
        /* =========================
                                       Helpers
                                    ========================= */
        function fmtINR(n) {
            n = Number(n || 0);
            return "‚Çπ" + n.toLocaleString("en-IN", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function setText(id, text) {
            var el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        function showMsg(id, text) {
            var el = document.getElementById(id);
            if (!el) return;
            el.style.display = "block";
            el.textContent = text;
        }

        function hideMsg(id) {
            var el = document.getElementById(id);
            if (!el) return;
            el.style.display = "none";
            el.textContent = "";
        }

        function pad2(n) {
            return (n < 10 ? "0" : "") + n;
        }

        function makePeriodId() {
            var d = new Date();
            return "" + d.getFullYear() + pad2(d.getMonth() + 1) + pad2(d.getDate()) + pad2(d.getHours()) + pad2(d.getMinutes()) + pad2(d.getSeconds());
        }

        // 0,5 => Violet | 1,3,7,9 => Green | 2,4,6,8 => Red
        function numberToColor(n) {
            if (n === 0 || n === 5) return "Violet";
            if (n === 1 || n === 3 || n === 7 || n === 9) return "Green";
            return "Red";
        }

        function numberToBigSmall(n) {
            return (n >= 5) ? "Big" : "Small";
        }

        /* =========================
           State
        ========================= */
        var USER = null;
        var MODE_SEC = 60;
        var timer = null;
        var remain = 60;

        var BET_OPEN_SEC = 30; // first 30 sec only
        var activeBet = null;
        var selectedBet = null;

        function bettingAllowed() {
            // ‚úÖ first 30 sec open => remain > (MODE_SEC - 30)
            return remain > (MODE_SEC - BET_OPEN_SEC);
        }

        function updateBetWindowUI() {
            var el = document.getElementById("betWindow");
            if (!el) return;
            if (bettingAllowed()) el.innerHTML = 'Betting: <b class="bet-open">OPEN</b> (first 30 sec)';
            else el.innerHTML = 'Betting: <b class="bet-closed">CLOSED</b> (wait next round)';
        }

        function clearSelectionUI() {
            var all = document.querySelectorAll(".wg-num, .wg-bs-btn, .wg-color");
            for (var i = 0; i < all.length; i++) all[i].classList.remove("active");
        }

        function setSelectedBet(bet) {
            selectedBet = bet;
            var inp = document.getElementById("selBet");
            if (inp) inp.value = bet ? bet.label : "";
            hideMsg("betMsg");
        }

        /* =========================
           Premium Timer UI
           - digits show remain time
           - progress bar shows round progress (0 -> 100)
           - dot/status changes: LIVE / LOCKED / ENDED
        ========================= */
        function setTimerUI(remainSec, totalSec) {
            remainSec = Math.max(0, Number(remainSec) || 0);
            totalSec = Math.max(1, Number(totalSec) || 1);

            var mm = pad2(Math.floor(remainSec / 60));
            var ss = pad2(remainSec % 60);

            var m1 = document.getElementById("tm_m1"),
                m2 = document.getElementById("tm_m2");
            var s1 = document.getElementById("tm_s1"),
                s2 = document.getElementById("tm_s2");
            if (m1) m1.textContent = mm[0];
            if (m2) m2.textContent = mm[1];
            if (s1) s1.textContent = ss[0];
            if (s2) s2.textContent = ss[1];

            // Progress: 0% at start, 100% at end
            var done = totalSec - remainSec;
            var pct = Math.min(100, Math.max(0, (done / totalSec) * 100));
            var bar = document.getElementById("wgProgressBar");
            if (bar) bar.style.width = pct + "%";

            // Status
            var dot = document.getElementById("wgDot");
            var hint = document.getElementById("wgTimerHint");
            var status = document.getElementById("wgStatusText");

            if (remainSec <= 0) {
                if (dot) dot.className = "dot dot-end";
                if (status) status.textContent = "ENDED";
                if (hint) hint.textContent = "Result generating‚Ä¶";
                return;
            }

            if (bettingAllowed()) {
                if (dot) dot.className = "dot dot-live";
                if (status) status.textContent = "LIVE";
                if (hint) hint.textContent = "Place bets before time ends";
            } else {
                if (dot) dot.className = "dot dot-lock";
                if (status) status.textContent = "LOCKED";
                if (hint) hint.textContent = "Bet locked (wait next round)";
            }
        }

        /* =========================
           Wallet + History
        ========================= */
        function renderWallet() {
            var me = currentUser();
            if (!me) return;
            setText("cid", me.id || "-");
            setText("nm", me.name || "-");
            var pts = (typeof me.points === "number") ? me.points : 0;
            setText("pts", String(pts));
            setText("ptsInr", fmtINR(pts));
        }

        // ‚úÖ Latest Result should show latest play (not reset each round)
        function renderLatestResultFromHistory() {
            var me = currentUser();
            if (!me) return;

            var rows = (typeof playsForUser === "function") ? (playsForUser(me.id) || []) : [];
            if (!rows.length) {
                setText("resNum", "-");
                setText("resColor", "-");
                setText("resBS", "-");
                return;
            }

            // Sort by createdAt desc
            rows.sort(function(a, b) {
                var ta = new Date(a.createdAt || 0).getTime();
                var tb = new Date(b.createdAt || 0).getTime();
                return tb - ta;
            });

            var r = rows[0];
            var rn = (r.resultNumber === 0 || r.resultNumber) ? String(r.resultNumber) : "-";
            setText("resNum", rn);
            setText("resColor", r.resultColor || "-");
            setText("resBS", r.resultBigSmall || "-");
        }

        function renderHistory() {
            var me = currentUser();
            if (!me) return;

            var rows = (typeof playsForUser === "function") ? (playsForUser(me.id) || []) : [];
            // latest first
            rows.sort(function(a, b) {
                var ta = new Date(a.createdAt || 0).getTime();
                var tb = new Date(b.createdAt || 0).getTime();
                return tb - ta;
            });
            rows = rows.slice(0, 30);

            var tb = document.getElementById("histBody");
            if (!tb) return;

            if (rows.length === 0) {
                tb.innerHTML = '<tr><td colspan="7" class="small">No history yet.</td></tr>';
                return;
            }

            var html = "";
            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                var resNum = (r.resultNumber === 0 || r.resultNumber) ? r.resultNumber : "-";
                var resCol = r.resultColor || "-";
                var resBS = r.resultBigSmall || "-";

                html += "<tr>" +
                    "<td>" + fmtDate(r.createdAt) + "</td>" +
                    "<td>" + (r.period || "-") + "</td>" +
                    "<td>" + (r.modeLabel || "-") + "</td>" +
                    "<td>" + (r.betLabel || "-") + " (" + (r.betAmount || 0) + ")</td>" +
                    "<td>" + (resNum + " / " + resCol + " / " + resBS) + "</td>" +
                    "<td>" + (r.before || 0) + "</td>" +
                    "<td>" + (r.after || 0) + "</td>" +
                    "</tr>";
            }
            tb.innerHTML = html;
        }

        /* =========================
           Mode / Round
        ========================= */
        function setMode(sec) {
            MODE_SEC = sec;
            remain = MODE_SEC;

            var t1 = document.getElementById("tab1m");
            var t3 = document.getElementById("tab3m");
            if (t1 && t3) {
                if (sec === 60) {
                    t1.classList.add("active");
                    t3.classList.remove("active");
                } else {
                    t3.classList.add("active");
                    t1.classList.remove("active");
                }
            }
            startNewRound();
        }

        function startNewRound() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }

            activeBet = null;
            selectedBet = null;
            clearSelectionUI();

            var selBet = document.getElementById("selBet");
            var amt = document.getElementById("betAmt");
            if (selBet) selBet.value = "";
            if (amt) amt.value = "";
            setText("betAmtInr", fmtINR(0));
            hideMsg("betMsg");
            hideMsg("roundMsg");

            // period
            var period = makePeriodId();
            setText("periodId", period);

            // show latest result from history (not reset)
            renderLatestResultFromHistory();

            remain = MODE_SEC;
            setTimerUI(remain, MODE_SEC);
            updateBetWindowUI();

            timer = setInterval(function() {
                remain -= 1;
                if (remain < 0) remain = 0;

                setTimerUI(remain, MODE_SEC);
                updateBetWindowUI();

                if (remain === 0) {
                    finishRound();
                    startNewRound();
                }
            }, 1000);
        }

        /* =========================
           Popup
        ========================= */
        function showResultPopup(o) {
            var back = document.getElementById("popBack");
            var title = document.getElementById("popTitle");
            var chips = document.getElementById("popChips");
            var bonus = document.getElementById("popBonus");
            var per = document.getElementById("popPeriod");

            if (title) title.textContent = o.win ? "Congratulations" : "Better Luck Next Time";
            if (chips) {
                chips.innerHTML =
                    '<span class="chip">Lottery results</span>' +
                    '<span class="chip">' + o.color + '</span>' +
                    '<span class="chip">' + o.num + '</span>' +
                    '<span class="chip">' + o.bs + '</span>';
            }
            if (bonus) {
                bonus.textContent = o.bonusText || "‚Çπ0.00";
                bonus.classList.toggle("lose", !o.win);
            }
            if (per) per.textContent = "Period: " + (o.period || "-");
            if (back) back.style.display = "flex";
        }

        function hideResultPopup() {
            var back = document.getElementById("popBack");
            if (back) back.style.display = "none";
        }

        /* =========================
           Game Logic
        ========================= */
        function finishRound() {
            var n = Math.floor(Math.random() * 10);
            var col = numberToColor(n);
            var bs = numberToBigSmall(n);

            // show on Latest Result immediately
            setText("resNum", String(n));
            setText("resColor", col);
            setText("resBS", bs);

            var period = (document.getElementById("periodId") ? document.getElementById("periodId").textContent : "-");

            if (!activeBet) {
                showMsg("roundMsg", "Round ended. No bet placed.");
                showResultPopup({
                    win: false,
                    period: period,
                    num: n,
                    color: col,
                    bs: bs,
                    bonusText: fmtINR(0)
                });
                return;
            }

            var isWin = false;
            if (activeBet.type === "color") isWin = (String(activeBet.value).toLowerCase() === String(col).toLowerCase());
            if (activeBet.type === "number") isWin = (Number(activeBet.value) === Number(n));
            if (activeBet.type === "bs") isWin = (String(activeBet.value).toLowerCase() === String(bs).toLowerCase());

            if (isWin) {
                // reward +2x
                adjustPoints(USER.id, activeBet.amount * 2, "Win reward (2x)", null);
            }

            var after = currentUser().points;

            if (typeof addPlayRow === "function") {
                addPlayRow({
                    id: "P" + Math.random().toString(36).slice(2, 9).toUpperCase(),
                    userId: USER.id,
                    createdAt: new Date().toISOString(),
                    period: activeBet.period,
                    modeSec: activeBet.modeSec,
                    modeLabel: (activeBet.modeSec === 60 ? "1 Min" : "3 Min"),
                    betType: activeBet.type,
                    betValue: activeBet.value,
                    betLabel: activeBet.label,
                    betAmount: activeBet.amount,
                    resultNumber: n,
                    resultColor: col,
                    resultBigSmall: bs,
                    result: isWin ? "WIN" : "LOSE",
                    before: activeBet.beforePoints,
                    after: after
                });
            }

            showMsg("roundMsg", isWin ? "üéâ WIN! Reward added (2x)." : "‚ùå LOSE! Bet deducted.");
            renderWallet();
            renderHistory();

            // popup bonus text
            var bonusVal = isWin ? (activeBet.amount * 2) : (-activeBet.amount);
            showResultPopup({
                win: isWin,
                period: activeBet.period,
                num: n,
                color: col,
                bs: bs,
                bonusText: (bonusVal < 0 ? ("-" + fmtINR(Math.abs(bonusVal))) : fmtINR(bonusVal))
            });

            activeBet = null;
        }

        function confirmBet() {
            var me = currentUser();
            if (!me) return;

            if (!bettingAllowed()) {
                showMsg("betMsg", "Betting closed for this round. Wait next round.");
                return;
            }

            var period = (document.getElementById("periodId") ? document.getElementById("periodId").textContent : "-");
            var amt = Number(document.getElementById("betAmt").value);

            if (!selectedBet) return showMsg("betMsg", "Please select Color / Number / Big-Small.");
            if (!amt || amt < 50) return showMsg("betMsg", "Minimum bet is 50.");
            if (amt > me.points) return showMsg("betMsg", "Insufficient wallet points.");
            if (activeBet) return showMsg("betMsg", "You already placed bet in this round.");

            var before = me.points;
            var r = adjustPoints(me.id, -amt, "Bet entry (" + selectedBet.label + ")", null);
            if (!r || !r.ok) return showMsg("betMsg", (r && r.msg) ? r.msg : "Bet failed");

            activeBet = {
                type: selectedBet.type,
                value: selectedBet.value,
                label: selectedBet.label,
                amount: amt,
                period: period,
                modeSec: MODE_SEC,
                beforePoints: before
            };

            showMsg("betMsg", "Bet placed: " + selectedBet.label + " (" + amt + "). Wait for result.");
            renderWallet();
        }

        /* =========================
           Init
        ========================= */
        document.addEventListener("DOMContentLoaded", function() {
            USER = requireLogin();
            if (!USER) return;

            // ‚úÖ show page after login ok
            document.body.style.visibility = "visible";

            // redirect admin
            if (USER.role === "admin") {
                window.location.replace("admin.html");
                return;
            }

            // logout
            var lo = document.getElementById("btnLogout");
            if (lo) lo.onclick = logout;

            // popup close
            var ok = document.getElementById("popOk");
            if (ok) ok.onclick = hideResultPopup;
            var back = document.getElementById("popBack");
            if (back) {
                back.addEventListener("click", function(e) {
                    if (e.target === back) hideResultPopup();
                });
            }

            // tabs
            var t1 = document.getElementById("tab1m");
            var t3 = document.getElementById("tab3m");
            if (t1) t1.onclick = function() {
                setMode(60);
            };
            if (t3) t3.onclick = function() {
                setMode(180);
            };

            // colors
            var g = document.getElementById("btnGreen");
            var v = document.getElementById("btnViolet");
            var rr = document.getElementById("btnRed");

            if (g) g.onclick = function() {
                if (activeBet) return showMsg("betMsg", "Bet already placed. Wait result.");
                clearSelectionUI();
                this.classList.add("active");
                setSelectedBet({
                    type: "color",
                    value: "Green",
                    label: "Color: Green"
                });
            };
            if (v) v.onclick = function() {
                if (activeBet) return showMsg("betMsg", "Bet already placed. Wait result.");
                clearSelectionUI();
                this.classList.add("active");
                setSelectedBet({
                    type: "color",
                    value: "Violet",
                    label: "Color: Violet"
                });
            };
            if (rr) rr.onclick = function() {
                if (activeBet) return showMsg("betMsg", "Bet already placed. Wait result.");
                clearSelectionUI();
                this.classList.add("active");
                setSelectedBet({
                    type: "color",
                    value: "Red",
                    label: "Color: Red"
                });
            };

            // numbers grid
            var grid = document.getElementById("numGrid");
            if (grid) {
                var html = "";
                for (var i = 0; i <= 9; i++) {
                    html += '<button class="wg-num" type="button" data-num="' + i + '">' + i + '</button>';
                }
                grid.innerHTML = html;

                grid.addEventListener("click", function(e) {
                    var b = e.target.closest(".wg-num");
                    if (!b) return;
                    if (activeBet) return showMsg("betMsg", "Bet already placed. Wait result.");
                    var n = Number(b.getAttribute("data-num"));
                    clearSelectionUI();
                    b.classList.add("active");
                    setSelectedBet({
                        type: "number",
                        value: n,
                        label: "Number: " + n
                    });
                });
            }

            // big/small
            var bb = document.getElementById("btnBig");
            var bs = document.getElementById("btnSmall");
            if (bb) bb.onclick = function() {
                if (activeBet) return showMsg("betMsg", "Bet already placed. Wait result.");
                clearSelectionUI();
                this.classList.add("active");
                setSelectedBet({
                    type: "bs",
                    value: "Big",
                    label: "Big"
                });
            };
            if (bs) bs.onclick = function() {
                if (activeBet) return showMsg("betMsg", "Bet already placed. Wait result.");
                clearSelectionUI();
                this.classList.add("active");
                setSelectedBet({
                    type: "bs",
                    value: "Small",
                    label: "Small"
                });
            };

            // bet amount -> inr
            var betAmt = document.getElementById("betAmt");
            if (betAmt) {
                betAmt.addEventListener("input", function() {
                    var val = Number(this.value || 0);
                    setText("betAmtInr", fmtINR(val));
                });
            }

            // chips
            var chipsRow = document.getElementById("chipsRow");
            if (chipsRow) {
                chipsRow.addEventListener("click", function(e) {
                    var b = e.target.closest(".chipbtn");
                    if (!b) return;
                    var val = Number(b.getAttribute("data-chip") || 0);
                    if (betAmt) {
                        betAmt.value = String(val);
                        setText("betAmtInr", fmtINR(val));
                    }
                });
            }

            // buttons
            var btnBet = document.getElementById("btnBet");
            var btnClear = document.getElementById("btnClear");
            var btnRefresh = document.getElementById("btnRefresh");

            if (btnBet) btnBet.onclick = confirmBet;

            if (btnClear) btnClear.onclick = function() {
                if (activeBet) return showMsg("betMsg", "Bet already placed. Wait result.");
                clearSelectionUI();
                setSelectedBet(null);
                if (betAmt) betAmt.value = "";
                setText("betAmtInr", fmtINR(0));
                hideMsg("betMsg");
            };

            if (btnRefresh) btnRefresh.onclick = function() {
                renderWallet();
                renderHistory();
                renderLatestResultFromHistory();
            };

            // start
            renderWallet();
            renderHistory();
            renderLatestResultFromHistory();
            setMode(60);

            // live wallet refresh
            setInterval(renderWallet, 1000);
        });
    </script>
</body>

</html>

