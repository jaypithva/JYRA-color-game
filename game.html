<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game</title>
  <link rel="icon" type="image/x-icon" href="images/logo.png">
  <link rel="stylesheet" href="styles.css" />

  <style>
    body { visibility: hidden; }
    /* (Tumhara existing CSS same rakha hai) */
  </style>
</head>

<body>
  <!-- ===== Header ===== -->
  <div class="nav">
    <div class="container">
      <div class="row header-row">
        <div class="brand">
          <!-- ✅ FIXED logo path -->
          <a href="index.html"><img src="logo.png" alt="Logo" class="logo"></a>
        </div>
        <div class="row-actions">
          <button class="btn secondary small" id="btnLogout" type="button">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- ===== Wallet ===== -->
    <div class="card">
      <div class="h2">My Wallet</div>
      <div class="kpi">
        <div class="box">
          <div class="label">Client ID</div>
          <div class="val" id="cid">-</div>
        </div>
        <div class="box">
          <div class="label">Name</div>
          <div class="val" id="nm">-</div>
        </div>
        <div class="box">
          <div class="label">Balance</div>
          <div class="val" id="pts">0</div>
          <div class="small" id="ptsInr" style="margin-top:6px;">₹0.00</div>
        </div>
      </div>

      <div class="small" style="margin-top:10px;">
        Min Bet: <b>50</b> | Max Bet: <b>Wallet Balance</b> |
        <span class="bet-lock" id="betWindow">Betting: <b class="bet-open">OPEN</b> (first 30 sec)</span>
      </div>
    </div>

    <!-- ===== Game ===== -->
    <div class="card" style="margin-top:14px;">
      <!-- (Tumhara same UI) -->
      <div class="wg-topbar">
        <div class="wg-top-left">
          <div class="wg-chip" aria-live="polite">
            <span class="dot dot-live" id="wgDot"></span>
            <span id="wgStatusText">LIVE</span>
          </div>

          <div>
            <div class="h2" style="margin:0;">Win Go</div>
            <div class="small">Choose Color / Number / Big-Small. Result at round end.</div>
          </div>

          <div class="wg-meta">
            <div class="wg-meta-label">Period</div>
            <div class="wg-meta-value" id="periodId">-</div>
          </div>
        </div>

        <div class="wg-top-right">
          <div class="wg-timer-card">
            <div class="wg-timer-title">Remaining</div>

            <div class="wg-timer-time" role="timer" aria-live="polite">
              <span class="wg-t" id="tm_m1">0</span>
              <span class="wg-t" id="tm_m2">0</span>
              <span class="wg-colon">:</span>
              <span class="wg-t" id="tm_s1">0</span>
              <span class="wg-t" id="tm_s2">0</span>
            </div>

            <div class="wg-timer-sub" id="wgTimerHint">Place bets before time ends</div>

            <div class="wg-progress">
              <div class="wg-progress-bar" id="wgProgressBar"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="wg-tabs">
        <button class="wg-tab active" id="tab1m" type="button">1 Min</button>
        <button class="wg-tab" id="tab3m" type="button">3 Min</button>
      </div>

      <div class="grid two" style="margin-top:12px;">
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Select Bet</div>

          <div class="small" style="margin-bottom:8px;">Color</div>
          <div class="wg-colors">
            <button class="wg-color green" id="btnGreen" type="button">Green</button>
            <button class="wg-color violet" id="btnViolet" type="button">Violet</button>
            <button class="wg-color red" id="btnRed" type="button">Red</button>
          </div>

          <div class="hr"></div>

          <div class="small" style="margin-bottom:8px;">Number (0-9)</div>
          <div class="wg-numbers" id="numGrid"></div>

          <div class="hr"></div>

          <div class="small" style="margin-bottom:8px;">Big / Small</div>
          <div class="wg-bs">
            <button class="wg-bs-btn big" id="btnBig" type="button">Big</button>
            <button class="wg-bs-btn small" id="btnSmall" type="button">Small</button>
          </div>
        </div>

        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Place Bet</div>

          <div class="input">
            <label>Selected Bet</label>
            <input id="selBet" readonly placeholder="Choose any one option" />
          </div>

          <div class="input">
            <label>Bet Amount (min 50)</label>
            <input id="betAmt" type="number" min="50" placeholder="Enter points" />
            <div class="small" id="betAmtInr">₹0.00</div>

            <div class="chips" id="chipsRow">
              <button class="chipbtn" type="button" data-chip="50">50</button>
              <button class="chipbtn" type="button" data-chip="100">100</button>
              <button class="chipbtn" type="button" data-chip="200">200</button>
              <button class="chipbtn" type="button" data-chip="500">500</button>
              <button class="chipbtn" type="button" data-chip="1000">1000</button>
            </div>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnBet" type="button">Confirm Bet</button>
            <button class="btn secondary" id="btnClear" type="button">Clear</button>
          </div>

          <div class="notice" id="betMsg" style="display:none;margin-top:10px;"></div>

          <div class="hr"></div>

          <div class="h2" style="margin-top:0;">Latest Result</div>
          <div class="kpi">
            <div class="box">
              <div class="label">Status</div>
              <div class="val" id="resStatus">-</div>
            </div>
            <div class="box">
              <div class="label">Result</div>
              <div class="val" id="resResult">-</div>
            </div>
            <div class="box">
              <div class="label">Bonus</div>
              <div class="val" id="resBonus">-</div>
            </div>
          </div>

          <div class="notice" id="roundMsg" style="display:none;margin-top:10px;"></div>

          <div class="hr"></div>
          <div class="small">
            ✅ Secure mode: User points/result **client-side change nahi hoga**. Admin / server result update karega.
          </div>
        </div>
      </div>
    </div>

    <!-- ===== History ===== -->
    <div class="card" style="margin-top:14px;">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">Game History</div>
          <div class="small">Last 30 bets</div>
        </div>
        <button class="btn secondary small" id="btnRefresh" type="button">Refresh</button>
      </div>

      <div style="overflow:auto;margin-top:10px;">
        <table class="table">
          <thead>
          <tr>
            <th>Date</th>
            <th>Period</th>
            <th>Mode</th>
            <th>Bet</th>
            <th>Status</th>
            <th>Result</th>
            <th>Bonus</th>
          </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script src="app.js"></script>

  <script>
    // =========================
    // Helpers (UI)
    // =========================
    function fmtINR(n) {
      n = Number(n || 0);
      return "₹" + n.toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function setText(id, text) { var el = document.getElementById(id); if (el) el.textContent = text; }
    function showMsg(id, text) { var el = document.getElementById(id); if (!el) return; el.style.display = "block"; el.textContent = text; }
    function hideMsg(id) { var el = document.getElementById(id); if (!el) return; el.style.display = "none"; el.textContent = ""; }
    function pad2(n) { return (n < 10 ? "0" : "") + n; }
    function makePeriodId() {
      var d = new Date();
      return "" + d.getFullYear() + pad2(d.getMonth() + 1) + pad2(d.getDate()) + pad2(d.getHours()) + pad2(d.getMinutes()) + pad2(d.getSeconds());
    }

    // =========================
    // State
    // =========================
    var USER = null;        // Firestore profile {uid, clientId, name, points, role...}
    var MODE_SEC = 60;
    var timer = null;
    var remain = 60;
    var BET_OPEN_SEC = 30;
    var selectedBet = null;
    var unsubBets = null;
    var latestRows = [];

    function bettingAllowed() {
      return remain > (MODE_SEC - BET_OPEN_SEC);
    }
    function updateBetWindowUI() {
      var el = document.getElementById("betWindow");
      if (!el) return;
      if (bettingAllowed()) el.innerHTML = 'Betting: <b class="bet-open">OPEN</b> (first 30 sec)';
      else el.innerHTML = 'Betting: <b class="bet-closed">CLOSED</b> (wait next round)';
    }
    function clearSelectionUI() {
      var all = document.querySelectorAll(".wg-num, .wg-bs-btn, .wg-color");
      for (var i = 0; i < all.length; i++) all[i].classList.remove("active");
    }
    function setSelectedBet(bet) {
      selectedBet = bet;
      var inp = document.getElementById("selBet");
      if (inp) inp.value = bet ? bet.label : "";
      hideMsg("betMsg");
    }

    function setTimerUI(remainSec, totalSec) {
      remainSec = Math.max(0, Number(remainSec) || 0);
      totalSec = Math.max(1, Number(totalSec) || 1);

      var mm = pad2(Math.floor(remainSec / 60));
      var ss = pad2(remainSec % 60);

      var m1 = document.getElementById("tm_m1"), m2 = document.getElementById("tm_m2");
      var s1 = document.getElementById("tm_s1"), s2 = document.getElementById("tm_s2");
      if (m1) m1.textContent = mm[0];
      if (m2) m2.textContent = mm[1];
      if (s1) s1.textContent = ss[0];
      if (s2) s2.textContent = ss[1];

      var done = totalSec - remainSec;
      var pct = Math.min(100, Math.max(0, (done / totalSec) * 100));
      var bar = document.getElementById("wgProgressBar");
      if (bar) bar.style.width = pct + "%";

      var dot = document.getElementById("wgDot");
      var hint = document.getElementById("wgTimerHint");
      var status = document.getElementById("wgStatusText");

      if (remainSec <= 0) {
        if (status) status.textContent = "ENDED";
        if (hint) hint.textContent = "Round ended. Waiting next…";
        return;
      }
      if (bettingAllowed()) {
        if (status) status.textContent = "LIVE";
        if (hint) hint.textContent = "Place bets before time ends";
      } else {
        if (status) status.textContent = "LOCKED";
        if (hint) hint.textContent = "Bet locked (wait next round)";
      }
    }

    function renderWallet() {
      if (!USER) return;
      setText("cid", USER.clientId || "-");
      setText("nm", USER.name || "-");
      var pts = (typeof USER.points === "number") ? USER.points : 0;
      setText("pts", String(pts));
      setText("ptsInr", fmtINR(pts));
    }

    function renderLatestFromRows(rows) {
      if (!rows || !rows.length) {
        setText("resStatus", "-");
        setText("resResult", "-");
        setText("resBonus", "-");
        return;
      }
      // newest first already
      var r = rows[0];
      setText("resStatus", r.status || "PENDING");
      setText("resResult", r.resultText || "-");
      setText("resBonus", (r.bonus != null ? fmtINR(r.bonus) : "-"));
    }

    function renderHistoryFromRows(rows) {
      var tb = document.getElementById("histBody");
      if (!tb) return;

      if (!rows || rows.length === 0) {
        tb.innerHTML = '<tr><td colspan="7" class="small">No history yet.</td></tr>';
        return;
      }

      var html = "";
      for (var i = 0; i < rows.length; i++) {
        var r = rows[i];
        html += "<tr>" +
          "<td>" + fmtDate(r.createdAt) + "</td>" +
          "<td>" + (r.period || "-") + "</td>" +
          "<td>" + (r.modeLabel || "-") + "</td>" +
          "<td>" + (r.betLabel || "-") + " (" + (r.betAmount || 0) + ")</td>" +
          "<td>" + (r.status || "PENDING") + "</td>" +
          "<td>" + (r.resultText || "-") + "</td>" +
          "<td>" + (r.bonus != null ? fmtINR(r.bonus) : "-") + "</td>" +
        "</tr>";
      }
      tb.innerHTML = html;
    }

    function setMode(sec) {
      MODE_SEC = sec;
      remain = MODE_SEC;

      var t1 = document.getElementById("tab1m");
      var t3 = document.getElementById("tab3m");
      if (t1 && t3) {
        if (sec === 60) { t1.classList.add("active"); t3.classList.remove("active"); }
        else { t3.classList.add("active"); t1.classList.remove("active"); }
      }
      startNewRound();
    }

    function startNewRound() {
      if (timer) { clearInterval(timer); timer = null; }

      selectedBet = null;
      clearSelectionUI();
      var selBet = document.getElementById("selBet");
      var amt = document.getElementById("betAmt");
      if (selBet) selBet.value = "";
      if (amt) amt.value = "";
      setText("betAmtInr", fmtINR(0));
      hideMsg("betMsg");
      hideMsg("roundMsg");

      var period = makePeriodId();
      setText("periodId", period);

      remain = MODE_SEC;
      setTimerUI(remain, MODE_SEC);
      updateBetWindowUI();

      timer = setInterval(function() {
        remain -= 1;
        if (remain < 0) remain = 0;

        setTimerUI(remain, MODE_SEC);
        updateBetWindowUI();

        if (remain === 0) {
          showMsg("roundMsg", "Round ended. (Secure mode) Result admin side se aayega.");
          // next round auto start
          startNewRound();
        }
      }, 1000);
    }

    async function confirmBet() {
      if (!USER) return;

      if (!bettingAllowed()) {
        showMsg("betMsg", "Betting closed for this round. Wait next round.");
        return;
      }

      var period = (document.getElementById("periodId") ? document.getElementById("periodId").textContent : "-");
      var amt = Number(document.getElementById("betAmt").value);

      if (!selectedBet) return showMsg("betMsg", "Please select Color / Number / Big-Small.");
      if (!amt || amt < 50) return showMsg("betMsg", "Minimum bet is 50.");

      // ✅ Secure: client does NOT change points here
      try {
        await createBet({
          uid: USER.uid,
          clientId: USER.clientId,
          betType: selectedBet.type,
          betValue: selectedBet.value,
          betLabel: selectedBet.label,
          betAmount: amt,
          period: period,
          modeSec: MODE_SEC
        });
        showMsg("betMsg", "✅ Bet saved! (PENDING) Admin/result system update karega.");
      } catch (e) {
        showMsg("betMsg", "Bet failed: " + (e.message || e));
      }
    }

    document.addEventListener("DOMContentLoaded", async function() {
      // ✅ LOGIN REQUIRED (Firebase)
      USER = await requireLoginAsync();
      if (!USER) return;

      // show page
      document.body.style.visibility = "visible";

      // redirect admin
      if (USER.role === "admin") {
        window.location.replace("admin.html");
        return;
      }

      // logout
      var lo = document.getElementById("btnLogout");
      if (lo) lo.onclick = logout;

      // tabs
      var t1 = document.getElementById("tab1m");
      var t3 = document.getElementById("tab3m");
      if (t1) t1.onclick = function() { setMode(60); };
      if (t3) t3.onclick = function() { setMode(180); };

      // colors
      var g = document.getElementById("btnGreen");
      var v = document.getElementById("btnViolet");
      var rr = document.getElementById("btnRed");

      if (g) g.onclick = function() {
        clearSelectionUI(); this.classList.add("active");
        setSelectedBet({ type: "color", value: "Green", label: "Color: Green" });
      };
      if (v) v.onclick = function() {
        clearSelectionUI(); this.classList.add("active");
        setSelectedBet({ type: "color", value: "Violet", label: "Color: Violet" });
      };
      if (rr) rr.onclick = function() {
        clearSelectionUI(); this.classList.add("active");
        setSelectedBet({ type: "color", value: "Red", label: "Color: Red" });
      };

      // numbers grid
      var grid = document.getElementById("numGrid");
      if (grid) {
        var html = "";
        for (var i = 0; i <= 9; i++) html += '<button class="wg-num" type="button" data-num="' + i + '">' + i + '</button>';
        grid.innerHTML = html;

        grid.addEventListener("click", function(e) {
          var b = e.target.closest(".wg-num");
          if (!b) return;
          var n = Number(b.getAttribute("data-num"));
          clearSelectionUI();
          b.classList.add("active");
          setSelectedBet({ type: "number", value: n, label: "Number: " + n });
        });
      }

      // big/small
      var bb = document.getElementById("btnBig");
      var bs = document.getElementById("btnSmall");
      if (bb) bb.onclick = function() {
        clearSelectionUI(); this.classList.add("active");
        setSelectedBet({ type: "bs", value: "Big", label: "Big" });
      };
      if (bs) bs.onclick = function() {
        clearSelectionUI(); this.classList.add("active");
        setSelectedBet({ type: "bs", value: "Small", label: "Small" });
      };

      // bet amount -> inr
      var betAmt = document.getElementById("betAmt");
      if (betAmt) {
        betAmt.addEventListener("input", function() {
          var val = Number(this.value || 0);
          setText("betAmtInr", fmtINR(val));
        });
      }

      // chips
      var chipsRow = document.getElementById("chipsRow");
      if (chipsRow) {
        chipsRow.addEventListener("click", function(e) {
          var b = e.target.closest(".chipbtn");
          if (!b) return;
          var val = Number(b.getAttribute("data-chip") || 0);
          if (betAmt) { betAmt.value = String(val); setText("betAmtInr", fmtINR(val)); }
        });
      }

      // buttons
      var btnBet = document.getElementById("btnBet");
      var btnClear = document.getElementById("btnClear");
      var btnRefresh = document.getElementById("btnRefresh");

      if (btnBet) btnBet.onclick = confirmBet;

      if (btnClear) btnClear.onclick = function() {
        clearSelectionUI();
        setSelectedBet(null);
        if (betAmt) betAmt.value = "";
        setText("betAmtInr", fmtINR(0));
        hideMsg("betMsg");
      };

      if (btnRefresh) btnRefresh.onclick = async function() {
        const rows = await getMyBets(USER.uid, 30);
        latestRows = rows;
        renderLatestFromRows(rows);
        renderHistoryFromRows(rows);
      };

      // first render
      renderWallet();

      // ✅ Live Bets Listener (so second/third device me instantly update)
      if (unsubBets) unsubBets();
      unsubBets = listenMyBets(USER.uid, function(rows) {
        latestRows = rows;
        renderLatestFromRows(rows);
        renderHistoryFromRows(rows);
      });

      // start
      setMode(60);
    });
  </script>
</body>
</html>
