<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <link rel="icon" type="image/x-icon" href="images/logo.png">
  <link rel="stylesheet" href="styles.css" />

  <style>
    body{ visibility:hidden; }

    .errbar{
      display:none;margin:12px 0 0;padding:12px 14px;border-radius:14px;
      border:1px solid rgba(255,90,90,.35);background:rgba(255,60,60,.12);
      color:#ffd6d6;font-weight:800;
    }

    .pw-wrap{ position:relative; }
    .pw-toggle{
      position:absolute;right:10px;top:34px;border:0;background:transparent;cursor:pointer;
      font-size:18px;line-height:1;padding:6px;opacity:.9;user-select:none;
    }

    select{
      width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);color:#fff;font-size:16px;outline:none;
      -webkit-appearance:none;appearance:none;
    }
    select option{ color:#111; }

    /* tables: keep table, only horizontal scroll on small */
    .table-wrap{
      width:100%;overflow:auto;-webkit-overflow-scrolling:touch;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);touch-action:pan-x pan-y;
    }
    .table-wrap .table{ width:100%; border-collapse:collapse; min-width:980px; }
    @media (max-width:720px){
      .table-wrap{ overflow-x:auto; overflow-y:hidden; }
      .table-wrap .table{ min-width:1100px; }
      table.table th, table.table td{ white-space:nowrap; }
    }

    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    @media (max-width:900px){ .grid3{ grid-template-columns:1fr 1fr; } }
    @media (max-width:620px){ .grid3{ grid-template-columns:1fr; } }

    .row-actions{ gap:10px; flex-wrap:wrap; }
    .mini{ font-size:12px; opacity:.75; }

    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);
      font-weight:800;font-size:12px;white-space:nowrap;
    }

    .pill.ok{ border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10); }
    .pill.warn{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); }

    .hide{ display:none !important; }
  </style>
</head>

<body>
  <div class="nav">
    <div class="container">
      <div class="row header-row">
        <div class="brand">
          <a href="index.html"><img src="logo.png" alt="Logo" class="logo"></a>
        </div>
        <div class="row-actions">
          <div class="pill">User: <span id="adminName">-</span></div>
          <div class="pill warn" id="adminWalletPill" style="display:none;">Admin Wallet: <span id="adminWalletText">0</span></div>
          <button class="btn secondary small" id="btnLogout" type="button">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="errbar" id="errBar"></div>

    <div class="card">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">Admin Panel</div>
          <div class="small">SuperAdmin ‚Üí Admin Wallet ‚Üí Client system (Firestore)</div>
        </div>
        <button class="btn secondary small" id="btnReload" type="button">Reload</button>
      </div>

      <div class="hr"></div>

      <div class="grid3">
        <!-- Update Profile -->
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Update Profile</div>

          <div class="input">
            <label>Name</label>
            <input id="admNewName" placeholder="New name" />
          </div>

          <div class="input pw-wrap">
            <label>New Password (min 4)</label>
            <input id="admNewPass" type="password" placeholder="New password" />
            <button type="button" class="pw-toggle" data-target="admNewPass" aria-label="Toggle password">üëÅÔ∏è</button>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnSaveAdmin" type="button">Save</button>
          </div>

          <div class="notice" id="admMsg" style="display:none;margin-top:10px;"></div>
        </div>

        <!-- Create User (Client/Admin) -->
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Create User</div>

          <div class="input">
            <label>Create As</label>
            <select id="createRole">
              <option value="user">Client</option>
              <option value="admin">Admin (Only SuperAdmin)</option>
            </select>
            <div class="mini" style="margin-top:6px;">If you are not SuperAdmin, Admin create will be blocked.</div>
          </div>

          <div class="input">
            <label>Name</label>
            <input id="cName" placeholder="Name" />
          </div>

          <div class="input">
            <label>Phone (10 digit)</label>
            <input id="cPhone" placeholder="98xxxxxxxx" inputmode="numeric" />
          </div>

          <div class="input pw-wrap">
            <label>Password</label>
            <input id="cPass" type="password" placeholder="Password" />
            <button type="button" class="pw-toggle" data-target="cPass" aria-label="Toggle password">üëÅÔ∏è</button>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnCreateUser" type="button">Create</button>
          </div>

          <div class="notice" id="createMsg" style="display:none;margin-top:10px;"></div>
        </div>

        <!-- Quick Actions (Client Points) -->
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Client Wallet Actions</div>

          <div class="input">
            <label>Select Client</label>
            <select id="selClient"></select>
            <div class="mini" style="margin-top:6px;">Selected: <b id="selClientInfo">-</b></div>
          </div>

          <div class="input">
            <label>Amount</label>
            <input id="amt" type="number" min="1" placeholder="Enter points" />
          </div>

          <div class="row-actions">
            <button class="btn" id="btnCredit" type="button">Credit</button>
            <button class="btn secondary" id="btnDebit" type="button">Debit</button>
          </div>

          <div class="hr"></div>

          <div class="input pw-wrap" style="margin-bottom:0;">
            <label>Reset Client Password</label>
            <input id="resetPass" type="password" placeholder="New password" />
            <button type="button" class="pw-toggle" data-target="resetPass" aria-label="Toggle password">üëÅÔ∏è</button>
          </div>

          <div class="row-actions" style="margin-top:10px;">
            <button class="btn secondary" id="btnResetPass" type="button">Reset</button>
            <button class="btn secondary" id="btnClearHistory" type="button">Clear History</button>
            <button class="btn secondary" id="btnClearAll" type="button">Clear + Reset Wallet</button>
          </div>

          <div class="row-actions" style="margin-top:10px;">
            <button class="btn danger" id="btnDeleteClient" type="button">Delete Client</button>
          </div>

          <div class="notice" id="actMsg" style="display:none;margin-top:10px;"></div>
        </div>
      </div>

      <!-- ‚úÖ SuperAdmin Panel -->
      <div class="hr"></div>
      <div class="card hide" id="superPanel" style="padding:12px;">
        <div class="row-actions" style="justify-content:space-between;">
          <div>
            <div class="h2" style="margin:0;">Super Admin Panel</div>
            <div class="small">Topup Admin Wallet (Admin can only credit clients up to this limit)</div>
          </div>
          <div class="pill ok">Role: SUPERADMIN</div>
        </div>

        <div class="hr"></div>

        <div class="grid3" style="grid-template-columns: 1.2fr 1fr 1fr;">
          <div class="input">
            <label>Select Admin</label>
            <select id="selAdmin"></select>
            <div class="mini" style="margin-top:6px;">Selected: <b id="selAdminInfo">-</b></div>
          </div>

          <div class="input">
            <label>Topup Amount</label>
            <input id="admTopAmt" type="number" min="1" placeholder="Enter points" />
          </div>

          <div class="row-actions" style="align-items:flex-end;">
            <button class="btn" id="btnTopupAdmin" type="button">Topup Admin Wallet</button>
          </div>
        </div>

        <div class="notice" id="superMsg" style="display:none;margin-top:10px;"></div>
      </div>
    </div>

    <!-- Users List -->
    <div class="card" style="margin-top:14px;">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">Users</div>
          <div class="small">Admins + Clients list</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Role</th>
              <th>Client Points</th>
              <th>Admin Wallet</th>
              <th>Admin Used</th>
              <th>Admin Remaining</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Client Bet History -->
    <div class="card" style="margin-top:14px;">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">Client Bet History</div>
          <div class="small">Last 30 plays of selected client</div>
        </div>
        <button class="btn secondary small" id="btnRefreshHistory" type="button">Refresh</button>
      </div>

      <div class="hr"></div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Period</th>
              <th>Mode</th>
              <th>Bet</th>
              <th>Result</th>
              <th>Before</th>
              <th>After</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Firebase compat FIRST -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyBZFAk80TlzESxnFNlG0uonVyLj3bQ3PRo",
      authDomain: "wingo-app-f68dd.firebaseapp.com",
      projectId: "wingo-app-f68dd",
      storageBucket: "wingo-app-f68dd.firebasestorage.app",
      messagingSenderId: "533037771285",
      appId: "1:533037771285:web:d72372f86108a8379dbc1c",
      measurementId: "G-RJ1XX4FX3W"
    };
  </script>

  <script src="app.js"></script>

  <script>
    function errBar(msg){
      var el=document.getElementById("errBar");
      if(!el) return;
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block"; el.textContent=msg;
    }
    function showBox(id,text){
      var el=document.getElementById(id); if(!el) return;
      el.style.display="block"; el.textContent=text;
    }
    function hideBox(id){
      var el=document.getElementById(id); if(!el) return;
      el.style.display="none"; el.textContent="";
    }
    function fmtINR(n){
      n=Number(n||0);
      return "‚Çπ" + n.toLocaleString("en-IN",{minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function selectedClientId(){
      var s=document.getElementById("selClient");
      return s ? String(s.value||"") : "";
    }

    async function getUserSafe(id){
      if(typeof getUserByIdFS==="function") return await getUserByIdFS(id);
      if(typeof getUserById==="function") return await getUserById(id);
      return null;
    }

    async function loadAllUsers(){
      if(typeof listUsers==="function") return await listUsers();
      if(typeof listAllUsers==="function") return await listAllUsers();
      throw new Error("listUsers/listAllUsers missing");
    }

    function setAdminWalletPill(me){
      var pill=document.getElementById("adminWalletPill");
      var text=document.getElementById("adminWalletText");
      if(!pill || !text) return;

      if(!me || me.role!=="admin"){ pill.style.display="none"; return; }
      const wallet = Number(me.adminWallet||0);
      const used = Number(me.adminUsed||0);
      const rem = Math.max(0, wallet-used);
      text.textContent = rem + " (Remaining)";
      pill.style.display="inline-flex";
    }

    async function updateSelectedClientInfo(){
      const cid = selectedClientId();
      var out = document.getElementById("selClientInfo");
      if(!out) return;
      if(!cid){ out.textContent="-"; return; }
      const u = await getUserSafe(cid);
      out.textContent = u ? `${u.name} (${u.clientId||u.id||cid}) ‚Ä¢ ${u.phone} ‚Ä¢ Points: ${u.points||0}` : cid;
    }

    async function renderHistory(){
      const cid = selectedClientId();
      const tb = document.getElementById("histBody");
      if(!tb) return;

      if(!cid){
        tb.innerHTML = `<tr><td colspan="7" class="small">Select a client to view history.</td></tr>`;
        return;
      }
      if(typeof playsForUser!=="function"){
        tb.innerHTML = `<tr><td colspan="7" class="small">Error: playsForUser missing in app.js</td></tr>`;
        return;
      }
      const rows = await playsForUser(cid, 30);
      if(!rows.length){
        tb.innerHTML = `<tr><td colspan="7" class="small">No bet history yet.</td></tr>`;
        return;
      }
      tb.innerHTML = rows.map(r=>{
        const resNum = (r.resultNumber===0 || r.resultNumber) ? r.resultNumber : "-";
        const resCol = r.resultColor || "-";
        const resBS  = r.resultBigSmall || "-";
        return `<tr>
          <td>${(typeof fmtDate==="function") ? fmtDate(r.createdAt) : (r.createdAt||"-")}</td>
          <td>${r.period || "-"}</td>
          <td>${r.modeLabel || "-"}</td>
          <td>${(r.betLabel||"-")} (${r.betAmount||0})</td>
          <td>${resNum} / ${resCol} / ${resBS} ‚Ä¢ <b>${(r.result||"-")}</b></td>
          <td>${r.before || 0}</td>
          <td>${r.after || 0}</td>
        </tr>`;
      }).join("");
    }

    async function loadUI(){
      const users = await loadAllUsers();

      // dropdown clients
      const sel = document.getElementById("selClient");
      sel.innerHTML = "";
      const clients = users.filter(u => u.role === "user");
      if(!clients.length){
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="No clients";
        sel.appendChild(opt);
      }else{
        clients
          .sort((a,b)=> String(a.clientId||a.id).localeCompare(String(b.clientId||b.id)))
          .forEach(u=>{
            const opt=document.createElement("option");
            opt.value = u.clientId || u.id;
            opt.textContent = `${u.clientId || u.id} ‚Ä¢ ${u.name} ‚Ä¢ ${u.phone}`;
            sel.appendChild(opt);
          });
      }

      // superadmin admin list
      const selAdmin = document.getElementById("selAdmin");
      selAdmin.innerHTML = "";
      const admins = users.filter(u => u.role === "admin");
      if(!admins.length){
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="No admins";
        selAdmin.appendChild(opt);
      }else{
        admins
          .sort((a,b)=> String(a.clientId||a.id).localeCompare(String(b.clientId||b.id)))
          .forEach(u=>{
            const opt=document.createElement("option");
            opt.value = u.clientId || u.id;
            const wallet = Number(u.adminWallet||0), used=Number(u.adminUsed||0), rem=Math.max(0, wallet-used);
            opt.textContent = `${u.clientId||u.id} ‚Ä¢ ${u.name} ‚Ä¢ Rem:${rem}`;
            selAdmin.appendChild(opt);
          });
      }

      // users table
      const tb = document.getElementById("usersBody");
      if(!tb) return;
      if(!users.length){
        tb.innerHTML = `<tr><td colspan="9" class="small">No users found.</td></tr>`;
        return;
      }

      users.sort((a,b)=>{
        const ar=a.role||"", br=b.role||"";
        const pr = (x)=> x==="superadmin" ? 0 : (x==="admin" ? 1 : 2);
        if(pr(ar)!==pr(br)) return pr(ar)-pr(br);
        return String(a.clientId||a.id||"").localeCompare(String(b.clientId||b.id||""));
      });

      tb.innerHTML = users.map(u=>{
        const id = u.clientId || u.id || "-";
        const pts = Number(u.points||0);
        const wallet = Number(u.adminWallet||0);
        const used = Number(u.adminUsed||0);
        const rem = Math.max(0, wallet-used);
        const created = (typeof fmtDate==="function") ? fmtDate(u.createdAt) : (u.createdAt||"-");
        return `<tr>
          <td>${id}</td>
          <td>${u.name || "-"}</td>
          <td>${u.phone || "-"}</td>
          <td>${u.role || "-"}</td>
          <td>${pts} <span class="mini">(${fmtINR(pts)})</span></td>
          <td>${wallet}</td>
          <td>${used}</td>
          <td><b>${rem}</b></td>
          <td>${created}</td>
        </tr>`;
      }).join("");

      await updateSelectedClientInfo();
      await renderHistory();
      await updateSelectedAdminInfo(users);
    }

    async function updateSelectedAdminInfo(usersCached){
      const el = document.getElementById("selAdminInfo");
      const selAdmin = document.getElementById("selAdmin");
      if(!el || !selAdmin) return;

      const id = String(selAdmin.value||"");
      if(!id){ el.textContent="-"; return; }

      let u = null;
      if(Array.isArray(usersCached)){
        u = usersCached.find(x => (x.clientId||x.id) === id) || null;
      }
      if(!u) u = await getUserSafe(id);

      if(!u){ el.textContent=id; return; }
      const wallet = Number(u.adminWallet||0);
      const used = Number(u.adminUsed||0);
      const rem = Math.max(0, wallet-used);
      el.textContent = `${u.name} (${id}) ‚Ä¢ Wallet:${wallet} ‚Ä¢ Used:${used} ‚Ä¢ Rem:${rem}`;
    }

    // password toggle
    document.addEventListener("click", function(e){
      var btn = e.target.closest(".pw-toggle");
      if(!btn) return;
      var id = btn.getAttribute("data-target");
      var inp = document.getElementById(id);
      if(!inp) return;
      if(inp.type==="password"){ inp.type="text"; btn.textContent="üôà"; }
      else { inp.type="password"; btn.textContent="üëÅÔ∏è"; }
    });

    document.addEventListener("DOMContentLoaded", async function(){
      try{
        if(typeof requireAdminAsync!=="function"){
          errBar("Error: app.js not loaded OR requireAdminAsync missing. Hard refresh (Ctrl+Shift+R).");
          document.body.style.visibility="visible";
          return;
        }

        const ME = await requireAdminAsync(); // admin or superadmin
        if(!ME) return;

        document.body.style.visibility="visible";
        document.getElementById("adminName").textContent = (ME.name||"User") + " ("+(ME.role||"-")+")";
        setAdminWalletPill(ME);

        // show super panel only for superadmin
        const superPanel = document.getElementById("superPanel");
        if(superPanel){
          if(ME.role==="superadmin") superPanel.classList.remove("hide");
          else superPanel.classList.add("hide");
        }

        // logout
        document.getElementById("btnLogout").onclick = (typeof logout==="function") ? logout : function(){ location.replace("login.html"); };

        // reload
        document.getElementById("btnReload").onclick = async function(){
          errBar("");
          hideBox("admMsg"); hideBox("createMsg"); hideBox("actMsg"); hideBox("superMsg");
          await loadUI();
          // refresh wallet badge
          const fresh = await getUserSafe(ME.clientId||ME.id);
          setAdminWalletPill(fresh);
        };

        // dropdown changes
        document.getElementById("selClient").addEventListener("change", async function(){
          await updateSelectedClientInfo();
          await renderHistory();
        });

        document.getElementById("selAdmin").addEventListener("change", async function(){
          const all = await loadAllUsers();
          await updateSelectedAdminInfo(all);
        });

        // save profile
        document.getElementById("btnSaveAdmin").onclick = async function(){
          hideBox("admMsg");
          if(typeof updateAdminProfile!=="function") return showBox("admMsg","Error: updateAdminProfile missing in app.js");
          const nm = (document.getElementById("admNewName").value||"").trim();
          const pw = (document.getElementById("admNewPass").value||"").trim();
          const id = ME.clientId || ME.id;
          const r = await updateAdminProfile(id, nm, pw);
          if(!r || !r.ok) return showBox("admMsg", r?.msg || "Failed");
          showBox("admMsg","Saved.");
          document.getElementById("admNewPass").value="";
          const fresh = await getUserSafe(id);
          document.getElementById("adminName").textContent = (fresh?.name||"User") + " ("+(fresh?.role||"-")+")";
        };

        // create user (client/admin)
        document.getElementById("btnCreateUser").onclick = async function(){
          hideBox("createMsg");
          if(typeof createUserAsRole!=="function") return showBox("createMsg","Error: createUserAsRole missing in app.js");

          const role = String(document.getElementById("createRole").value||"user");
          const name = (document.getElementById("cName").value||"").trim();
          const phone = (document.getElementById("cPhone").value||"").trim();
          const pass = (document.getElementById("cPass").value||"").trim();

          const id = ME.clientId || ME.id;
          const r = await createUserAsRole({ role, name, phone, password: pass }, id);
          if(!r || !r.ok) return showBox("createMsg", r?.msg || "Failed");

          showBox("createMsg", `${role==="admin" ? "Admin" : "Client"} created: ${r.user.clientId||r.user.id}`);
          document.getElementById("cName").value="";
          document.getElementById("cPhone").value="";
          document.getElementById("cPass").value="";
          await loadUI();
        };

        // credit client
        document.getElementById("btnCredit").onclick = async function(){
          hideBox("actMsg");
          if(typeof adjustPoints!=="function") return showBox("actMsg","Error: adjustPoints missing in app.js");
          const cid = selectedClientId();
          const amt = Number(document.getElementById("amt").value||0);
          if(!cid) return showBox("actMsg","Select client first.");
          if(!amt || amt<=0) return showBox("actMsg","Enter amount.");

          const by = ME.clientId || ME.id;
          const r = await adjustPoints(cid, +amt, "Admin Credit", by);
          if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");

          showBox("actMsg", `Credited. New points: ${r.points}`);
          await loadUI();

          // refresh wallet badge (admin only)
          const fresh = await getUserSafe(by);
          setAdminWalletPill(fresh);
        };

        // debit client
        document.getElementById("btnDebit").onclick = async function(){
          hideBox("actMsg");
          if(typeof adjustPoints!=="function") return showBox("actMsg","Error: adjustPoints missing in app.js");
          const cid = selectedClientId();
          const amt = Number(document.getElementById("amt").value||0);
          if(!cid) return showBox("actMsg","Select client first.");
          if(!amt || amt<=0) return showBox("actMsg","Enter amount.");

          const by = ME.clientId || ME.id;
          const r = await adjustPoints(cid, -amt, "Admin Debit", by);
          if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");

          showBox("actMsg", `Debited. New points: ${r.points}`);
          await loadUI();
        };

        // reset password
        document.getElementById("btnResetPass").onclick = async function(){
          hideBox("actMsg");
          if(typeof adminResetClientPassword!=="function") return showBox("actMsg","Error: adminResetClientPassword missing in app.js");
          const cid = selectedClientId();
          const np = (document.getElementById("resetPass").value||"").trim();
          if(!cid) return showBox("actMsg","Select client first.");
          if(!np || np.length<4) return showBox("actMsg","Password min 4 chars.");
          const by = ME.clientId || ME.id;
          const r = await adminResetClientPassword(cid, np, by);
          if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
          showBox("actMsg","Password reset done.");
          document.getElementById("resetPass").value="";
        };

        // clear history
        document.getElementById("btnClearHistory").onclick = async function(){
          hideBox("actMsg");
          if(typeof clearClientHistory!=="function") return showBox("actMsg","Error: clearClientHistory missing in app.js");
          const cid = selectedClientId();
          if(!cid) return showBox("actMsg","Select client first.");
          if(!confirm("Clear selected client history?")) return;
          const r = await clearClientHistory(cid, false);
          if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
          showBox("actMsg","History cleared.");
          await renderHistory();
        };

        // clear + reset
        document.getElementById("btnClearAll").onclick = async function(){
          hideBox("actMsg");
          if(typeof clearClientHistory!=="function") return showBox("actMsg","Error: clearClientHistory missing in app.js");
          const cid = selectedClientId();
          if(!cid) return showBox("actMsg","Select client first.");
          if(!confirm("Clear history AND reset wallet to 0?")) return;
          const r = await clearClientHistory(cid, true);
          if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
          showBox("actMsg","Cleared + Wallet reset.");
          await loadUI();
        };

        // delete client
        document.getElementById("btnDeleteClient").onclick = async function(){
          hideBox("actMsg");
          if(typeof deleteClient!=="function") return showBox("actMsg","Error: deleteClient missing in app.js");
          const cid = selectedClientId();
          if(!cid) return showBox("actMsg","Select client first.");
          if(!confirm("Delete client permanently?")) return;
          const by = ME.clientId || ME.id;
          const r = await deleteClient(cid, by);
          if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
          showBox("actMsg","Client deleted.");
          await loadUI();
        };

        // refresh history
        document.getElementById("btnRefreshHistory").onclick = async function(){
          await updateSelectedClientInfo();
          await renderHistory();
        };

        // superadmin topup admin wallet
        document.getElementById("btnTopupAdmin").onclick = async function(){
          hideBox("superMsg");
          if(ME.role!=="superadmin") return showBox("superMsg","Only SuperAdmin can topup admin wallet.");
          if(typeof superAdminGiveAdminWallet!=="function") return showBox("superMsg","Error: superAdminGiveAdminWallet missing in app.js");

          const aid = String(document.getElementById("selAdmin").value||"");
          const amt = Number(document.getElementById("admTopAmt").value||0);
          if(!aid) return showBox("superMsg","Select admin first.");
          if(!amt || amt<=0) return showBox("superMsg","Enter amount.");

          const r = await superAdminGiveAdminWallet(aid, amt, (ME.clientId||ME.id), "Admin Wallet Topup");
          if(!r || !r.ok) return showBox("superMsg", r?.msg || "Failed");

          showBox("superMsg", `Topup done. Admin wallet: ${r.adminWallet}`);
          document.getElementById("admTopAmt").value="";
          await loadUI();
        };

        // initial load
        await loadUI();

      }catch(e){
        document.body.style.visibility="visible";
        errBar("Error: " + (e?.message || String(e)));
      }
    });
  </script>
</body>
</html>
