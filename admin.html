<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <link rel="icon" type="image/x-icon" href="images/logo.png">
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Never keep page hidden forever */
    body { visibility: visible; }

    /* ===== Small utilities ===== */
    .mini{ font-size:12px; opacity:.75; }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      font-weight:800;font-size:12px;white-space:nowrap;
    }

    /* ===== Make selects mobile-friendly ===== */
    select, input{
      -webkit-appearance: none;
      appearance: auto;
    }
    select{
      width:100%;
      min-height:44px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      pointer-events: auto;
      touch-action: manipulation;
    }

    .row-actions{ gap:10px; flex-wrap:wrap; }

    /* ===== Password toggle ===== */
    .pw-wrap{ position:relative; }
    .pw-toggle{
      position:absolute;
      right:10px;
      top:34px;
      border:0;
      background:transparent;
      cursor:pointer;
      font-size:18px;
      line-height:1;
      padding:6px;
      opacity:.9;
      color: inherit;
    }

    /* ===== Layout ===== */
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width:900px){ .grid3{ grid-template-columns:1fr 1fr; } }
    @media (max-width:620px){ .grid3{ grid-template-columns:1fr; } }

    /* ===== Responsive tables ===== */
    .table-wrap{
      width:100%;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
    }
    .table-wrap .table{ min-width: 920px; } /* desktop */

    /* Mobile: convert table to cards */
    @media (max-width:720px){
      .table-wrap{ border:0; overflow:visible; }
      table.table, table.table thead, table.table tbody, table.table th, table.table td, table.table tr{
        display:block;
        width:100%;
      }
      table.table thead{ display:none; }
      table.table{ min-width:0; }
      table.table tr{
        border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.03);
        border-radius:16px;
        padding:10px;
        margin-bottom:10px;
      }
      table.table td{
        border:0 !important;
        padding:8px 8px;
      }
      table.table td::before{
        content: attr(data-label);
        display:block;
        font-size:12px;
        opacity:.7;
        margin-bottom:4px;
      }
    }

    /* Error banner */
    .errbar{
      display:none;
      margin:14px 0 0;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,120,120,.35);
      background: rgba(255,80,80,.12);
      color: rgba(255,255,255,.92);
      font-weight:700;
    }
  </style>
</head>

<body>
  <!-- ===== Header ===== -->
  <div class="nav">
    <div class="container">
      <div class="row header-row">
        <div class="brand">
          <a href="index.html"><img src="logo.png" alt="Logo" class="logo"></a>
        </div>
        <div class="row-actions">
          <div class="pill">Admin: <span id="adminName">-</span></div>
          <button class="btn secondary small" id="btnLogout" type="button">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- Global error (never blank) -->
    <div class="errbar" id="globalErr"></div>

    <!-- ===== Admin Panel ===== -->
    <div class="card">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">Admin Panel</div>
          <div class="small">Manage clients, wallet, and bet history</div>
        </div>
        <button class="btn secondary small" id="btnReload" type="button">Reload</button>
      </div>

      <div class="hr"></div>

      <div class="grid3">
        <!-- Update Admin -->
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Update Profile</div>

          <div class="input">
            <label>Admin Name</label>
            <input id="admNewName" placeholder="New name" />
          </div>

          <div class="input pw-wrap">
            <label>New Password (min 4)</label>
            <input id="admNewPass" type="password" placeholder="New password" />
            <button type="button" class="pw-toggle" data-target="admNewPass" aria-label="Toggle password">üëÅÔ∏è</button>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnSaveAdmin" type="button">Save</button>
          </div>

          <div class="notice" id="admMsg" style="display:none;margin-top:10px;"></div>
        </div>

        <!-- Create Client -->
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Create Client</div>

          <div class="input">
            <label>Client Name</label>
            <input id="cName" placeholder="Client name" />
          </div>
          <div class="input">
            <label>Phone (10 digit)</label>
            <input id="cPhone" placeholder="98xxxxxxxx" inputmode="numeric" />
          </div>
          <div class="input pw-wrap">
            <label>Password</label>
            <input id="cPass" type="password" placeholder="Client password" />
            <button type="button" class="pw-toggle" data-target="cPass" aria-label="Toggle password">üëÅÔ∏è</button>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnCreateClient" type="button">Create</button>
          </div>

          <div class="notice" id="createMsg" style="display:none;margin-top:10px;"></div>
        </div>

        <!-- Quick Actions -->
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Quick Actions</div>

          <div class="input">
            <label>Select Client</label>
            <select id="selClient">
              <option value="">Loading‚Ä¶</option>
            </select>
            <div class="mini" style="margin-top:6px;">
              Selected: <b id="selClientInfo">-</b>
            </div>
          </div>

          <div class="input">
            <label>Wallet Amount</label>
            <input id="amt" type="number" min="1" placeholder="Enter points" />
          </div>

          <div class="row-actions">
            <button class="btn" id="btnCredit" type="button">Credit</button>
            <button class="btn secondary" id="btnDebit" type="button">Debit</button>
          </div>

          <div class="hr"></div>

          <div class="input pw-wrap" style="margin-bottom:0;">
            <label>Reset Client Password</label>
            <input id="resetPass" type="password" placeholder="New password" />
            <button type="button" class="pw-toggle" data-target="resetPass" aria-label="Toggle password">üëÅÔ∏è</button>
          </div>

          <div class="row-actions" style="margin-top:10px;">
            <button class="btn secondary" id="btnResetPass" type="button">Reset</button>
            <button class="btn secondary" id="btnClearHistory" type="button">Clear History</button>
            <button class="btn secondary" id="btnClearAll" type="button">Clear + Reset Wallet</button>
          </div>

          <div class="row-actions" style="margin-top:10px;">
            <button class="btn danger" id="btnDeleteClient" type="button">Delete Client</button>
          </div>

          <div class="notice" id="actMsg" style="display:none;margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <!-- ===== Clients List ===== -->
    <div class="card" style="margin-top:14px;">
      <div>
        <div class="h2" style="margin:0;">Clients</div>
        <div class="small">All users list</div>
      </div>

      <div class="hr"></div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Client ID</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Role</th>
              <th>Points</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="clientsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ===== Client Bet History ===== -->
    <div class="card" style="margin-top:14px;">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">Client Bet History</div>
          <div class="small">Last 30 plays of selected client</div>
        </div>
        <button class="btn secondary small" id="btnRefreshHistory" type="button">Refresh</button>
      </div>

      <div class="hr"></div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Period</th>
              <th>Mode</th>
              <th>Bet</th>
              <th>Result</th>
              <th>Before</th>
              <th>After</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Firebase compat FIRST -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyBZFAk80TlzESxnFNlG0uonVyLj3bQ3PRo",
      authDomain: "wingo-app-f68dd.firebaseapp.com",
      projectId: "wingo-app-f68dd",
      storageBucket: "wingo-app-f68dd.firebasestorage.app",
      messagingSenderId: "533037771285",
      appId: "1:533037771285:web:d72372f86108a8379dbc1c",
      measurementId: "G-RJ1XX4FX3W"
    };
  </script>

  <!-- Your app functions -->
  <script src="app.js"></script>

  <script>
    /* ======================
       Safe UI helpers
    ====================== */
    function $(id){ return document.getElementById(id); }

    function showGlobalErr(msg){
      var el = $("globalErr");
      if(!el) return;
      el.style.display = "block";
      el.textContent = msg;
    }
    function clearGlobalErr(){
      var el = $("globalErr");
      if(!el) return;
      el.style.display = "none";
      el.textContent = "";
    }

    function showBox(id, text){
      var el=$(id);
      if(!el) return;
      el.style.display="block";
      el.textContent=text;
    }
    function hideBox(id){
      var el=$(id);
      if(!el) return;
      el.style.display="none";
      el.textContent="";
    }
    function fmtINR(n){
      n = Number(n||0);
      return "‚Çπ" + n.toLocaleString("en-IN",{minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function pickPointsFromResponse(r){
      // handles: {points}, {data:{points}}, {user:{points}}
      if(!r) return null;
      if(typeof r.points === "number") return r.points;
      if(r.data && typeof r.data.points === "number") return r.data.points;
      if(r.user && typeof r.user.points === "number") return r.user.points;
      return null;
    }

    function selectedClientId(){
      var s=$("selClient");
      return s ? String(s.value||"") : "";
    }

    function requireFn(name){
      if(typeof window[name] !== "function"){
        throw new Error("Missing function in app.js: " + name + "()");
      }
      return window[name];
    }

    /* ======================
       Page-level error guard
    ====================== */
    window.addEventListener("error", function(ev){
      showGlobalErr("JS Error: " + (ev.message || "Unknown error"));
    });
    window.addEventListener("unhandledrejection", function(ev){
      var m = (ev && ev.reason && ev.reason.message) ? ev.reason.message : String(ev.reason || "Promise error");
      showGlobalErr("Error: " + m);
    });

    /* Password toggle */
    document.addEventListener("click", function(e){
      var btn = e.target.closest(".pw-toggle");
      if(!btn) return;
      var id = btn.getAttribute("data-target");
      var inp = $(id);
      if(!inp) return;
      if(inp.type==="password"){ inp.type="text"; btn.textContent="üôà"; }
      else { inp.type="password"; btn.textContent="üëÅÔ∏è"; }
    });

    /* ======================
       UI renderers
    ====================== */
    async function updateSelectedClientInfo(){
      const cid = selectedClientId();
      if(!cid){
        $("selClientInfo").textContent = "-";
        return;
      }

      // try Firestore getter
      if(typeof window.getUserByIdFS === "function"){
        const u = await window.getUserByIdFS(cid);
        $("selClientInfo").textContent = u ? `${u.name} (${u.id}) ‚Ä¢ ${u.phone} ‚Ä¢ Points: ${u.points||0}` : cid;
        return;
      }

      // fallback: maybe getUserById exists (localStorage version)
      if(typeof window.getUserById === "function"){
        const u = window.getUserById(cid);
        $("selClientInfo").textContent = u ? `${u.name} (${u.id}) ‚Ä¢ ${u.phone} ‚Ä¢ Points: ${u.points||0}` : cid;
        return;
      }

      $("selClientInfo").textContent = cid;
    }

    async function loadClientsUI(keepSelected=true){
      clearGlobalErr();

      const listUsers = requireFn("listUsers"); // must exist for admin panel
      const users = await listUsers();

      users.sort((a,b)=>{
        const ar = a.role||"", br = b.role||"";
        if(ar !== br) return (ar==="admin" ? -1 : 1);
        return String(a.id||"").localeCompare(String(b.id||""));
      });

      // dropdown
      const sel = $("selClient");
      const prev = keepSelected ? selectedClientId() : "";
      sel.innerHTML = "";

      const clients = users.filter(u => (u.role||"") === "user");
      if(!clients.length){
        sel.innerHTML = `<option value="">No clients</option>`;
      }else{
        sel.innerHTML = `<option value="">-- Select client --</option>` + clients.map(u=>{
          const label = `${u.id} ‚Ä¢ ${u.name} ‚Ä¢ ${u.phone}`;
          return `<option value="${String(u.id||"").replace(/"/g,'&quot;')}">${label}</option>`;
        }).join("");
      }

      // restore selection
      if(prev){
        sel.value = prev;
        if(sel.value !== prev){
          // prev not found, select first client if exists
          if(clients.length) sel.value = clients[0].id;
        }
      }else{
        if(clients.length) sel.value = clients[0].id;
      }

      // clients table
      const tb = $("clientsBody");
      if(!users.length){
        tb.innerHTML = `<tr><td colspan="6" class="small">No users found.</td></tr>`;
      }else{
        tb.innerHTML = users.map(u=>{
          const pts = (typeof u.points==="number") ? u.points : 0;
          return `<tr>
            <td data-label="Client ID">${u.id || "-"}</td>
            <td data-label="Name">${u.name || "-"}</td>
            <td data-label="Phone">${u.phone || "-"}</td>
            <td data-label="Role">${u.role || "-"}</td>
            <td data-label="Points">${pts} <span class="mini">(${fmtINR(pts)})</span></td>
            <td data-label="Created">${(typeof window.fmtDate==="function") ? window.fmtDate(u.createdAt) : (u.createdAt||"-")}</td>
          </tr>`;
        }).join("");
      }

      await updateSelectedClientInfo();
    }

    async function renderHistory(){
      const cid = selectedClientId();
      const tb = $("histBody");
      if(!cid){
        tb.innerHTML = `<tr><td colspan="7" class="small">Select a client to view history.</td></tr>`;
        return;
      }

      if(typeof window.playsForUser !== "function"){
        tb.innerHTML = `<tr><td colspan="7" class="small">Error: playsForUser() not found in app.js</td></tr>`;
        return;
      }

      const rows = await window.playsForUser(cid, 30); // your Firestore version uses (userId, limit)
      const list = Array.isArray(rows) ? rows : [];

      if(!list.length){
        tb.innerHTML = `<tr><td colspan="7" class="small">No bet history yet.</td></tr>`;
        return;
      }

      tb.innerHTML = list.map(r=>{
        const resNum = (r.resultNumber===0 || r.resultNumber) ? r.resultNumber : "-";
        const resCol = r.resultColor || "-";
        const resBS  = r.resultBigSmall || "-";
        const fdate = (typeof window.fmtDate==="function") ? window.fmtDate(r.createdAt) : (r.createdAt||"-");
        return `<tr>
          <td data-label="Date">${fdate}</td>
          <td data-label="Period">${r.period || "-"}</td>
          <td data-label="Mode">${r.modeLabel || "-"}</td>
          <td data-label="Bet">${(r.betLabel||"-")} (${r.betAmount||0})</td>
          <td data-label="Result">${resNum} / ${resCol} / ${resBS} ‚Ä¢ <b>${(r.result||"-")}</b></td>
          <td data-label="Before">${r.before ?? 0}</td>
          <td data-label="After">${r.after ?? 0}</td>
        </tr>`;
      }).join("");
    }

    /* ======================
       Actions
    ====================== */
    async function doCreditDebit(delta){
      hideBox("actMsg");
      const cid = selectedClientId();
      const amt = Number($("amt").value||0);

      if(!cid) return showBox("actMsg","Select client first.");
      if(!amt || amt<=0) return showBox("actMsg","Enter amount.");

      if(typeof window.adjustPoints !== "function"){
        return showBox("actMsg","Error: adjustPoints() not found in app.js");
      }

      const ADMIN = window.__ADMIN__;
      const note = (delta>0) ? "Admin Credit" : "Admin Debit";

      const r = await window.adjustPoints(cid, delta*amt, note, (ADMIN ? ADMIN.id : null));
      if(!r || r.ok === false){
        return showBox("actMsg", (r && r.msg) ? r.msg : "Failed");
      }

      const pts = pickPointsFromResponse(r);
      showBox("actMsg", (delta>0 ? "Credited" : "Debited") + (pts!=null ? (". New points: " + pts) : ". Done."));

      await loadClientsUI(true);
      await renderHistory();
    }

    /* ======================
       Init
    ====================== */
    document.addEventListener("DOMContentLoaded", async function(){
      try{
        clearGlobalErr();

        // Must exist
        const requireAdminAsync = requireFn("requireAdminAsync");
        const logout = requireFn("logout");

        // get admin
        const ADMIN = await requireAdminAsync();
        if(!ADMIN) return;

        window.__ADMIN__ = ADMIN;
        $("adminName").textContent = ADMIN.name || "Admin";

        $("btnLogout").onclick = logout;

        // Select change (mobile reliable)
        $("selClient").addEventListener("change", async function(){
          await updateSelectedClientInfo();
          await renderHistory();
        });

        // Reload
        $("btnReload").onclick = async function(){
          hideBox("admMsg"); hideBox("createMsg"); hideBox("actMsg");
          await loadClientsUI(true);
          await renderHistory();
        };

        // Update admin profile
        $("btnSaveAdmin").onclick = async function(){
          hideBox("admMsg");
          if(typeof window.updateAdminProfile !== "function"){
            return showBox("admMsg","Error: updateAdminProfile() not found in app.js");
          }
          const nm = ($("admNewName").value||"").trim();
          const pw = ($("admNewPass").value||"").trim();

          const r = await window.updateAdminProfile(ADMIN.id, nm, pw);
          if(!r || r.ok === false){
            return showBox("admMsg", (r && r.msg) ? r.msg : "Failed");
          }
          showBox("admMsg","Saved.");
          $("admNewPass").value = "";
          await loadClientsUI(true);
        };

        // Create client
        $("btnCreateClient").onclick = async function(){
          hideBox("createMsg");

          // Your firestore admin function name
          if(typeof window.adminCreateClient !== "function" && typeof window.registerUserSecure !== "function"){
            return showBox("createMsg","Error: adminCreateClient() / registerUserSecure() not found in app.js");
          }

          const name = ($("cName").value||"").trim();
          const phone = ($("cPhone").value||"").trim();
          const pass = ($("cPass").value||"").trim();

          let r;
          if(typeof window.adminCreateClient === "function"){
            r = await window.adminCreateClient({name, phone, password: pass}, ADMIN.id);
          }else{
            // fallback old localStorage register
            r = await window.registerUserSecure({name, phone, password: pass});
          }

          if(!r || r.ok === false){
            return showBox("createMsg", (r && r.msg) ? r.msg : "Failed");
          }

          const uid = (r.user && r.user.id) ? r.user.id : "Created";
          showBox("createMsg","Client created: " + uid);

          $("cName").value=""; $("cPhone").value=""; $("cPass").value="";
          await loadClientsUI(true);
          await renderHistory();
        };

        // Credit / Debit
        $("btnCredit").onclick = () => doCreditDebit(+1);
        $("btnDebit").onclick  = () => doCreditDebit(-1);

        // Reset client password
        $("btnResetPass").onclick = async function(){
          hideBox("actMsg");
          const cid = selectedClientId();
          const np = ($("resetPass").value||"").trim();
          if(!cid) return showBox("actMsg","Select client first.");
          if(!np || np.length < 4) return showBox("actMsg","Password min 4 chars.");

          if(typeof window.adminResetClientPassword !== "function"){
            return showBox("actMsg","Error: adminResetClientPassword() not found in app.js");
          }

          const r = await window.adminResetClientPassword(cid, np, ADMIN.id);
          if(!r || r.ok === false) return showBox("actMsg", (r && r.msg) ? r.msg : "Failed");

          showBox("actMsg","Password reset done.");
          $("resetPass").value="";
        };

        // Clear history
        $("btnClearHistory").onclick = async function(){
          hideBox("actMsg");
          const cid = selectedClientId();
          if(!cid) return showBox("actMsg","Select client first.");
          if(!confirm("Clear selected client history?")) return;

          if(typeof window.clearClientHistory !== "function"){
            return showBox("actMsg","Error: clearClientHistory() not found in app.js");
          }

          const r = await window.clearClientHistory(cid, false, ADMIN.id);
          if(!r || r.ok === false) return showBox("actMsg", (r && r.msg) ? r.msg : "Failed");

          showBox("actMsg","History cleared.");
          await renderHistory();
        };

        // Clear + reset wallet
        $("btnClearAll").onclick = async function(){
          hideBox("actMsg");
          const cid = selectedClientId();
          if(!cid) return showBox("actMsg","Select client first.");
          if(!confirm("Clear history AND reset wallet to 0?")) return;

          if(typeof window.clearClientHistory !== "function"){
            return showBox("actMsg","Error: clearClientHistory() not found in app.js");
          }

          const r = await window.clearClientHistory(cid, true, ADMIN.id);
          if(!r || r.ok === false) return showBox("actMsg", (r && r.msg) ? r.msg : "Failed");

          showBox("actMsg","Cleared + Wallet reset.");
          await loadClientsUI(true);
          await renderHistory();
        };

        // Delete client
        $("btnDeleteClient").onclick = async function(){
          hideBox("actMsg");
          const cid = selectedClientId();
          if(!cid) return showBox("actMsg","Select client first.");
          if(!confirm("Delete client permanently?")) return;

          if(typeof window.deleteClient !== "function"){
            return showBox("actMsg","Error: deleteClient() not found in app.js");
          }

          const r = await window.deleteClient(cid, ADMIN.id);
          if(!r || r.ok === false) return showBox("actMsg", (r && r.msg) ? r.msg : "Failed");

          showBox("actMsg","Client deleted.");
          await loadClientsUI(false);
          await renderHistory();
        };

        // Refresh history
        $("btnRefreshHistory").onclick = async function(){
          await updateSelectedClientInfo();
          await renderHistory();
        };

        // initial
        await loadClientsUI(false);
        await renderHistory();

      }catch(err){
        showGlobalErr(err && err.message ? err.message : String(err));
      }
    });
  </script>
</body>
</html>
