<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <link rel="icon" type="image/x-icon" href="images/logo.png">
  <link rel="stylesheet" href="styles.css" />

  <style>
    body{ visibility:hidden; }

    .errbar{
      display:none; margin:12px 0 0; padding:12px 14px; border-radius:14px;
      border:1px solid rgba(255,90,90,.35);
      background:rgba(255,60,60,.12); color:#ffd6d6; font-weight:800;
    }
    .pw-wrap{ position:relative; }
    .pw-toggle{
      position:absolute; right:10px; top:34px; border:0; background:transparent;
      cursor:pointer; font-size:18px; line-height:1; padding:6px; opacity:.9;
      user-select:none;
    }

    select{
      width:100%; padding:12px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04); color:#fff; font-size:16px;
      outline:none; -webkit-appearance:none; appearance:none;
    }
    select option{ color:#111; }

    /* ‚úÖ Single table everywhere, mobile = horizontal scroll */
    .table-wrap{
      width:100%;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      touch-action: pan-x pan-y;
    }
    table.table{
      width:100%;
      border-collapse:collapse;
      min-width:980px;
    }
    @media (max-width:720px){
      table.table{ min-width:1100px; }
      table.table th, table.table td{ white-space:nowrap; }
    }

    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    @media (max-width:900px){ .grid3{ grid-template-columns:1fr 1fr; } }
    @media (max-width:620px){ .grid3{ grid-template-columns:1fr; } }

    .row{ display:flex; gap:10px; align-items:center; }
    .row-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .mini{ font-size:12px; opacity:.75; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      font-weight:800; font-size:12px; white-space:nowrap;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="nav">
    <div class="container">
      <div class="row header-row">
        <div class="brand">
          <a href="index.html"><img src="logo.png" alt="Logo" class="logo"></a>
        </div>
        <div class="row-actions">
          <div class="pill">Admin: <span id="adminName">-</span></div>
          <button class="btn secondary small" id="btnLogout" type="button">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="errbar" id="errBar"></div>

    <!-- Admin Panel -->
    <div class="card">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">Admin Panel</div>
          <div class="small">Manage clients, wallet, and bet history</div>
          <div class="mini" id="adminHint" style="margin-top:6px;"></div>
        </div>
        <button class="btn secondary small" id="btnReload" type="button">Reload</button>
      </div>

      <div class="hr"></div>

      <div class="grid3">
        <!-- Update Admin -->
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Update Profile</div>

          <div class="input">
            <label>Admin Name</label>
            <input id="admNewName" placeholder="New name" />
          </div>

          <div class="input pw-wrap">
            <label>New Password (min 4)</label>
            <input id="admNewPass" type="password" placeholder="New password" />
            <button type="button" class="pw-toggle" data-target="admNewPass">üëÅÔ∏è</button>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnSaveAdmin" type="button">Save</button>
          </div>

          <div class="notice" id="admMsg" style="display:none;margin-top:10px;"></div>
        </div>

        <!-- Create Client -->
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Create Client</div>

          <div class="input">
            <label>Client Name</label>
            <input id="cName" placeholder="Client name" />
          </div>
          <div class="input">
            <label>Phone (10 digit)</label>
            <input id="cPhone" placeholder="98xxxxxxxx" inputmode="numeric" />
          </div>
          <div class="input pw-wrap">
            <label>Password</label>
            <input id="cPass" type="password" placeholder="Client password" />
            <button type="button" class="pw-toggle" data-target="cPass">üëÅÔ∏è</button>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnCreateClient" type="button">Create</button>
          </div>

          <div class="notice" id="createMsg" style="display:none;margin-top:10px;"></div>
        </div>

        <!-- Quick Actions -->
        <div class="card" style="padding:12px;">
          <div class="h2" style="margin-top:0;">Quick Actions</div>

          <div class="input">
            <label>Select Client</label>
            <select id="selClient"></select>
            <div class="mini" style="margin-top:6px;">Selected: <b id="selClientInfo">-</b></div>
          </div>

          <div class="input">
            <label>Wallet Amount</label>
            <input id="amt" type="number" min="1" placeholder="Enter points" />
          </div>

          <div class="row-actions">
            <button class="btn" id="btnCredit" type="button">Credit</button>
            <button class="btn secondary" id="btnDebit" type="button">Debit</button>
          </div>

          <div class="hr"></div>

          <div class="input pw-wrap" style="margin-bottom:0;">
            <label>Reset Client Password</label>
            <input id="resetPass" type="password" placeholder="New password" />
            <button type="button" class="pw-toggle" data-target="resetPass">üëÅÔ∏è</button>
          </div>

          <div class="row-actions" style="margin-top:10px;">
            <button class="btn secondary" id="btnResetPass" type="button">Reset</button>
            <button class="btn secondary" id="btnClearHistory" type="button">Clear History</button>
            <button class="btn secondary" id="btnClearAll" type="button">Clear + Reset Wallet</button>
          </div>

          <div class="row-actions" style="margin-top:10px;">
            <button class="btn danger" id="btnDeleteClient" type="button">Delete Client</button>
          </div>

          <div class="notice" id="actMsg" style="display:none;margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <!-- Clients List (Admin + Users only, no SuperAdmin) -->
    <div class="card" style="margin-top:14px;">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">Clients</div>
          <div class="small">Users list (SuperAdmin hidden)</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Client ID</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Role</th>
              <th>Points</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="clientsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Bet History (single table) -->
    <div class="card" style="margin-top:14px;">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">Client Bet History</div>
          <div class="small">Last 30 plays of selected client</div>
        </div>
        <button class="btn secondary small" id="btnRefreshHistory" type="button">Refresh</button>
      </div>

      <div class="hr"></div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Period</th>
              <th>Mode</th>
              <th>Bet</th>
              <th>Result</th>
              <th>Before</th>
              <th>After</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyBZFAk80TlzESxnFNlG0uonVyLj3bQ3PRo",
      authDomain: "wingo-app-f68dd.firebaseapp.com",
      projectId: "wingo-app-f68dd",
      storageBucket: "wingo-app-f68dd.firebasestorage.app",
      messagingSenderId: "533037771285",
      appId: "1:533037771285:web:d72372f86108a8379dbc1c",
      measurementId: "G-RJ1XX4FX3W"
    };
  </script>

  <script src="app.js"></script>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);

      function errBar(msg){
        const el = $("errBar");
        if(!el) return;
        if(!msg){ el.style.display="none"; el.textContent=""; return; }
        el.style.display="block"; el.textContent = msg;
      }

      function showBox(id, text){
        const el = $(id);
        if(!el) return;
        el.style.display="block";
        el.textContent = text;
      }
      function hideBox(id){
        const el = $(id);
        if(!el) return;
        el.style.display="none";
        el.textContent = "";
      }

      function safeRole(u){ return String(u?.role||"").toLowerCase(); }

      function selectedClientId(){
        const s = $("selClient");
        return s ? String(s.value||"") : "";
      }

      async function _listUsersSafe(){
        if(typeof window.listUsers === "function") return await window.listUsers();
        if(typeof window.listAllUsers === "function") return await window.listAllUsers();
        throw new Error("listUsers/listAllUsers missing in app.js");
      }

      async function _getUserSafe(id){
        if(typeof window.getUserByIdFS === "function") return await window.getUserByIdFS(id);
        return null;
      }

      function fmtINR(n){
        n = Number(n||0);
        return "‚Çπ" + n.toLocaleString("en-IN",{minimumFractionDigits:2, maximumFractionDigits:2});
      }

      async function updateSelectedClientInfo(){
        const cid = selectedClientId();
        const out = $("selClientInfo");
        if(!out) return;
        if(!cid){ out.textContent = "-"; return; }

        const u = await _getUserSafe(cid);
        out.textContent = u ? `${u.name} (${u.clientId||cid}) ‚Ä¢ ${u.phone||"-"} ‚Ä¢ Points: ${u.points||0}` : cid;
      }

      async function renderHistory(){
        const cid = selectedClientId();
        const tb = $("histBody");
        if(!tb) return;

        if(!cid){
          tb.innerHTML = `<tr><td colspan="7" class="small">Select a client to view history.</td></tr>`;
          return;
        }
        if(typeof window.playsForUser !== "function"){
          tb.innerHTML = `<tr><td colspan="7" class="small">Error: playsForUser missing in app.js</td></tr>`;
          return;
        }

        const rows = await window.playsForUser(cid, 30);
        if(!rows.length){
          tb.innerHTML = `<tr><td colspan="7" class="small">No bet history yet.</td></tr>`;
          return;
        }

        const fd = (typeof window.fmtDate==="function") ? window.fmtDate : (x)=>String(x||"-");

        tb.innerHTML = rows.map(r=>{
          const resNum = (r.resultNumber===0 || r.resultNumber) ? r.resultNumber : "-";
          const resCol = r.resultColor || "-";
          const resBS  = r.resultBigSmall || "-";
          return `<tr>
            <td>${fd(r.createdAt)}</td>
            <td>${r.period || "-"}</td>
            <td>${r.modeLabel || "-"}</td>
            <td>${(r.betLabel||"-")} (${r.betAmount||0})</td>
            <td>${resNum} / ${resCol} / ${resBS} ‚Ä¢ <b>${(r.result||"-")}</b></td>
            <td>${r.before || 0}</td>
            <td>${r.after || 0}</td>
          </tr>`;
        }).join("");
      }

      async function loadClientsUI(ADMIN){
        const all = await _listUsersSafe();

        // ‚úÖ SECURITY: hide superadmin completely
        const users = all.filter(u => safeRole(u) !== "superadmin");

        // ‚úÖ dropdown only CLIENTS (role user)
        const sel = $("selClient");
        sel.innerHTML = "";
        const clients = users.filter(u => safeRole(u) === "user");

        if(!clients.length){
          const opt = document.createElement("option");
          opt.value=""; opt.textContent="No clients";
          sel.appendChild(opt);
        }else{
          clients
            .sort((a,b)=>String(a.clientId||"").localeCompare(String(b.clientId||"")))
            .forEach(u=>{
              const opt = document.createElement("option");
              opt.value = u.clientId;
              opt.textContent = `${u.clientId} ‚Ä¢ ${u.name||"-"} ‚Ä¢ ${u.phone||"-"}`;
              sel.appendChild(opt);
            });
        }

        // ‚úÖ table: show admin + users (no superadmin)
        const tb = $("clientsBody");
        if(!tb) return;

        const showList = users
          .filter(u => safeRole(u)==="admin" || safeRole(u)==="user")
          .sort((a,b)=>{
            const ar=safeRole(a), br=safeRole(b);
            if(ar!==br) return (ar==="admin" ? -1 : 1);
            return String(a.clientId||"").localeCompare(String(b.clientId||""));
          });

        if(!showList.length){
          tb.innerHTML = `<tr><td colspan="6" class="small">No users found.</td></tr>`;
          return;
        }

        const fd = (typeof window.fmtDate==="function") ? window.fmtDate : (x)=>String(x||"-");

        tb.innerHTML = showList.map(u=>{
          const pts = (typeof u.points==="number") ? u.points : 0;
          return `<tr>
            <td>${u.clientId||"-"}</td>
            <td>${u.name||"-"}</td>
            <td>${u.phone||"-"}</td>
            <td>${u.role||"-"}</td>
            <td>${pts} <span class="mini">(${fmtINR(pts)})</span></td>
            <td>${fd(u.createdAt)}</td>
          </tr>`;
        }).join("");

        await updateSelectedClientInfo();
        await renderHistory();

        // show admin hint (points)
        const freshAdmin = await _getUserSafe(ADMIN.clientId);
        $("adminHint").textContent = freshAdmin ? `Your Points: ${freshAdmin.points||0}` : "";
      }

      // ‚úÖ password toggle
      document.addEventListener("click", function(e){
        const btn = e.target.closest(".pw-toggle");
        if(!btn) return;
        const id = btn.getAttribute("data-target");
        const inp = $(id);
        if(!inp) return;
        if(inp.type==="password"){ inp.type="text"; btn.textContent="üôà"; }
        else{ inp.type="password"; btn.textContent="üëÅÔ∏è"; }
      });

      document.addEventListener("DOMContentLoaded", async function(){
        try{
          // sanity
          if(typeof window.requireAdminAsync !== "function"){
            document.body.style.visibility="visible";
            errBar("Error: app.js not loaded OR requireAdminAsync missing. Hard refresh (Ctrl+Shift+R).");
            return;
          }

          const ADMIN = await window.requireAdminAsync();
          if(!ADMIN) return;

          // ‚úÖ Block superadmin from this page too (extra safety)
          if(safeRole(ADMIN) === "superadmin"){
            window.location.replace("superadmin.html");
            return;
          }

          document.body.style.visibility="visible";
          $("adminName").textContent = ADMIN.name || "Admin";

          // logout
          $("btnLogout").addEventListener("click", function(e){
            e.preventDefault();
            if(typeof window.logout==="function") window.logout();
            else window.location.replace("login.html");
          });

          // reload
          $("btnReload").addEventListener("click", async function(e){
            e.preventDefault();
            errBar("");
            hideBox("admMsg"); hideBox("createMsg"); hideBox("actMsg");
            await loadClientsUI(ADMIN);
          });

          // dropdown change
          $("selClient").addEventListener("change", async function(){
            await updateSelectedClientInfo();
            await renderHistory();
          });

          // save admin
          $("btnSaveAdmin").addEventListener("click", async function(e){
            e.preventDefault();
            hideBox("admMsg");
            if(typeof window.updateAdminProfile !== "function"){
              showBox("admMsg","Error: updateAdminProfile missing in app.js");
              return;
            }
            const nm = ($("admNewName").value||"").trim();
            const pw = ($("admNewPass").value||"").trim();
            const r = await window.updateAdminProfile(ADMIN.clientId, nm, pw);
            if(!r || !r.ok){ showBox("admMsg", r?.msg || "Failed"); return; }
            showBox("admMsg","Saved.");
            const fresh = await _getUserSafe(ADMIN.clientId);
            $("adminName").textContent = fresh ? (fresh.name||"Admin") : "Admin";
            $("admNewPass").value="";
          });

          // create client
          $("btnCreateClient").addEventListener("click", async function(e){
            e.preventDefault();
            hideBox("createMsg");
            if(typeof window.adminCreateClient !== "function"){
              showBox("createMsg","Error: adminCreateClient missing in app.js");
              return;
            }
            const name = ($("cName").value||"").trim();
            const phone= ($("cPhone").value||"").trim();
            const pass = ($("cPass").value||"").trim();
            const r = await window.adminCreateClient({name, phone, password: pass}, ADMIN.clientId);
            if(!r || !r.ok){ showBox("createMsg", r?.msg || "Failed"); return; }
            showBox("createMsg", `Client created: ${r.user.clientId}`);
            $("cName").value=""; $("cPhone").value=""; $("cPass").value="";
            await loadClientsUI(ADMIN);
          });

          // credit/debit
          $("btnCredit").addEventListener("click", async function(e){
            e.preventDefault();
            hideBox("actMsg");
            const cid = selectedClientId();
            const amt = Number($("amt").value||0);
            if(!cid) return showBox("actMsg","Select client first.");
            if(!amt || amt<=0) return showBox("actMsg","Enter amount.");
            const r = await window.adjustPoints(cid, +amt, "Admin Credit", ADMIN.clientId);
            if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
            showBox("actMsg", `Credited. New points: ${r.points}`);
            await loadClientsUI(ADMIN);
          });

          $("btnDebit").addEventListener("click", async function(e){
            e.preventDefault();
            hideBox("actMsg");
            const cid = selectedClientId();
            const amt = Number($("amt").value||0);
            if(!cid) return showBox("actMsg","Select client first.");
            if(!amt || amt<=0) return showBox("actMsg","Enter amount.");
            const r = await window.adjustPoints(cid, -amt, "Admin Debit", ADMIN.clientId);
            if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
            showBox("actMsg", `Debited. New points: ${r.points}`);
            await loadClientsUI(ADMIN);
          });

          // reset pass
          $("btnResetPass").addEventListener("click", async function(e){
            e.preventDefault();
            hideBox("actMsg");
            const cid = selectedClientId();
            const np = ($("resetPass").value||"").trim();
            if(!cid) return showBox("actMsg","Select client first.");
            if(!np || np.length<4) return showBox("actMsg","Password min 4 chars.");
            const r = await window.adminResetClientPassword(cid, np, ADMIN.clientId);
            if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
            showBox("actMsg","Password reset done.");
            $("resetPass").value="";
          });

          // clear history
          $("btnClearHistory").addEventListener("click", async function(e){
            e.preventDefault();
            hideBox("actMsg");
            const cid = selectedClientId();
            if(!cid) return showBox("actMsg","Select client first.");
            if(!confirm("Clear selected client history?")) return;
            const r = await window.clearClientHistory(cid, false, ADMIN.clientId);
            if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
            showBox("actMsg","History cleared.");
            await renderHistory();
          });

          // clear + reset wallet
          $("btnClearAll").addEventListener("click", async function(e){
            e.preventDefault();
            hideBox("actMsg");
            const cid = selectedClientId();
            if(!cid) return showBox("actMsg","Select client first.");
            if(!confirm("Clear history AND reset wallet to 0?")) return;
            const r = await window.clearClientHistory(cid, true, ADMIN.clientId);
            if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
            showBox("actMsg","Cleared + Wallet reset.");
            await loadClientsUI(ADMIN);
          });

          // delete client
          $("btnDeleteClient").addEventListener("click", async function(e){
            e.preventDefault();
            hideBox("actMsg");
            const cid = selectedClientId();
            if(!cid) return showBox("actMsg","Select client first.");
            if(!confirm("Delete client permanently?")) return;
            const r = await window.deleteClient(cid, ADMIN.clientId);
            if(!r || !r.ok) return showBox("actMsg", r?.msg || "Failed");
            showBox("actMsg","Client deleted.");
            await loadClientsUI(ADMIN);
          });

          // refresh history
          $("btnRefreshHistory").addEventListener("click", async function(e){
            e.preventDefault();
            await updateSelectedClientInfo();
            await renderHistory();
          });

          // initial load
          await loadClientsUI(ADMIN);

        }catch(e){
          document.body.style.visibility="visible";
          errBar("Error: " + (e?.message || String(e)));
        }
      });
    })();
  </script>
</body>
</html>
