<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel</title>
  <link rel="icon" type="image/x-icon" href="images/logo.png">
  <link rel="stylesheet" href="styles.css" />
  <style>body{visibility:hidden}</style>
</head>

<body>
  <div class="nav">
    <div class="container">
      <div class="row header-row">
        <div class="brand">
          <a href="index.html"><img src="logo.png" alt="Logo" class="logo"></a>
        </div>
        <div class="row-actions">
          <button class="btn secondary small" id="btnLogout" type="button">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container grid two">
    <!-- Create Client -->
    <div class="card">
      <div class="h2">Create Client</div>
      <div class="small">Admin yaha se client ID create karega</div>
      <div class="hr"></div>

      <div class="input"><label>Name</label><input id="cname" placeholder="Client name"></div>
      <div class="input"><label>Phone</label><input id="cphone" placeholder="10 digit phone"></div>

      <div class="input pw-wrap">
        <label>Password</label>
        <input id="cpass" type="password" placeholder="Set password">
        <button type="button" class="pw-toggle" data-target="cpass">üëÅÔ∏è</button>
      </div>

      <button class="btn" id="btnCreate" type="button">Create Client</button>
      <div class="notice" id="createMsg" style="display:none;margin-top:10px;"></div>
    </div>

    <!-- Search -->
    <div class="card">
      <div class="h2">Search Client</div>
      <div class="hr"></div>

      <div class="input"><label>Client ID / Phone</label><input id="search" placeholder="CXXXXXX or phone"></div>
      <button class="btn secondary" id="btnSearch" type="button">Search</button>

      <div class="notice" id="foundBox" style="display:none;margin-top:10px;">
        <div><b>ID:</b> <span id="f_id"></span></div>
        <div><b>Name:</b> <span id="f_name"></span></div>
        <div><b>Phone:</b> <span id="f_phone"></span></div>
        <div><b>Current Wallet:</b> <span id="f_points"></span></div>
      </div>

      <div id="actionBox" style="display:none;margin-top:12px;">
        <div class="input">
          <label>Action</label>
          <select id="atype">
            <option value="credit">Credit</option>
            <option value="debit">Debit</option>
          </select>
        </div>

        <div class="input"><label>Points</label><input id="amt" type="number" min="1"></div>
        <div class="input"><label>Note</label><input id="note" placeholder="ex: Today credit"></div>

        <button class="btn" id="btnApply" type="button">Apply</button>
        <div class="notice" id="applyMsg" style="display:none;margin-top:10px;"></div>

        <div class="hr"></div>

        <div class="input pw-wrap">
          <label>Reset Password (email reset)</label>
          <input id="newPass" type="password" placeholder="New password (not direct)">
          <button type="button" class="pw-toggle" data-target="newPass">üëÅÔ∏è</button>
        </div>
        <button class="btn secondary" id="btnResetPass" type="button">Send Reset Email</button>
        <div class="notice" id="adminActionMsg" style="display:none;margin-top:10px;"></div>
      </div>
    </div>

    <!-- All Clients -->
    <div class="card" style="grid-column:1/-1;">
      <div class="row-actions" style="justify-content:space-between;">
        <div>
          <div class="h2" style="margin:0;">All Clients</div>
          <div class="small">Registered users</div>
        </div>
        <button class="btn secondary small" id="btnRefresh" type="button">Refresh</button>
      </div>

      <div style="overflow:auto;margin-top:10px;">
        <table class="table" id="uTable">
          <thead>
            <tr>
              <th>Client ID</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Wallet</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="app.js"></script>

  <script>
    (function(){
      "use strict";

      let ADMIN = null;
      let SELECTED = null; // {uid, ...}

      function show(el,on){ if(el) el.style.display = on ? "block":"none"; }
      function txt(id,v){ var e=document.getElementById(id); if(e) e.textContent = v; }
      function notice(id,msg){ var e=document.getElementById(id); if(!e) return; e.style.display="block"; e.textContent=msg; }

      // password toggle
      document.addEventListener("click", function(e){
        var b = e.target.closest(".pw-toggle");
        if(!b) return;
        var tid = b.getAttribute("data-target");
        var inp = document.getElementById(tid);
        if(!inp) return;
        if(inp.type==="password"){ inp.type="text"; b.textContent="üôà"; }
        else { inp.type="password"; b.textContent="üëÅÔ∏è"; }
      });

      async function renderUsers(){
        initFirebaseOnce();
        const snap = await DB.collection("users").where("role","==","user").get();
        const rows = snap.docs.map(d=>({ uid:d.id, ...d.data() }));

        rows.sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));

        const tb = document.querySelector("#uTable tbody");
        if(!tb) return;

        if(!rows.length){
          tb.innerHTML = '<tr><td colspan="5" class="small">No users</td></tr>';
          return;
        }

        tb.innerHTML = rows.map(u => `
          <tr>
            <td>${u.clientId || "-"}</td>
            <td>${u.name || "-"}</td>
            <td>${u.phone || "-"}</td>
            <td>${(typeof u.points==="number") ? u.points : 0}</td>
            <td>${fmtDate(u.createdAt)}</td>
          </tr>
        `).join("");
      }

      document.addEventListener("DOMContentLoaded", async function(){
        ADMIN = await requireAdmin();
        if(!ADMIN) return;

        document.body.style.visibility = "visible";

        document.getElementById("btnLogout").addEventListener("click", logout);
        document.getElementById("btnRefresh").addEventListener("click", renderUsers);

        // create client
        document.getElementById("btnCreate").addEventListener("click", async function(){
          const name = (document.getElementById("cname").value||"").trim();
          const phone = (document.getElementById("cphone").value||"").trim();
          const pass = (document.getElementById("cpass").value||"");

          const msg = document.getElementById("createMsg");
          show(msg,true);
          msg.textContent = "Creating...";

          const r = await adminCreateClient({ name, phone, password: pass });
          if(!r || !r.ok){
            msg.textContent = (r && r.msg) ? r.msg : "Create failed";
            return;
          }
          msg.textContent = "‚úÖ Client created. Client ID: " + r.clientId + " (Login by Phone or Client ID)";
          document.getElementById("cname").value="";
          document.getElementById("cphone").value="";
          document.getElementById("cpass").value="";
          renderUsers();
        });

        // search
        document.getElementById("btnSearch").addEventListener("click", async function(){
          const q = (document.getElementById("search").value||"").trim();
          const u = await findClientByPhoneOrId(q);

          if(!u){
            SELECTED = null;
            show(document.getElementById("foundBox"), false);
            show(document.getElementById("actionBox"), false);
            alert("Client not found");
            return;
          }

          SELECTED = u;
          txt("f_id", u.clientId || "-");
          txt("f_name", u.name || "-");
          txt("f_phone", u.phone || "-");
          txt("f_points", (typeof u.points==="number") ? u.points : 0);

          show(document.getElementById("foundBox"), true);
          show(document.getElementById("actionBox"), true);
        });

        // apply points
        document.getElementById("btnApply").addEventListener("click", async function(){
          if(!SELECTED) return notice("applyMsg","Search client first");

          const amt = Number(document.getElementById("amt").value || 0);
          const type = document.getElementById("atype").value;
          const note = (document.getElementById("note").value||"").trim();

          if(!amt || amt<=0) return notice("applyMsg","Enter valid points");

          const delta = (type==="credit") ? amt : -amt;
          const r = await adminAdjustPoints(SELECTED.uid, delta, note);

          if(!r || !r.ok){
            notice("applyMsg", (r && r.msg) ? r.msg : "Update failed");
            return;
          }

          notice("applyMsg", "‚úÖ Done! New wallet: " + r.points);
          document.getElementById("amt").value="";
          document.getElementById("note").value="";

          // refresh selected
          const fresh = await findClientByPhoneOrId(SELECTED.phone || SELECTED.clientId);
          if(fresh){ SELECTED = fresh; txt("f_points", fresh.points||0); }
          renderUsers();
        });

        // reset password (email reset)
        document.getElementById("btnResetPass").addEventListener("click", async function(){
          if(!SELECTED) return notice("adminActionMsg","Search client first");
          const np = (document.getElementById("newPass").value||"").trim();
          if(np.length < 4) return notice("adminActionMsg","Password min 4 characters");

          // Free plan me direct set possible nahi -> reset email
          const r = await adminResetClientPasswordByClientId(SELECTED.phone || SELECTED.clientId, np);
          notice("adminActionMsg", r.ok ? r.msg : (r.msg||"Failed"));
        });

        renderUsers();
      });
    })();
  </script>
</body>
</html>

