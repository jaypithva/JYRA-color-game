<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard</title>
    <link rel="icon" type="image/x-icon" href="images/logo.png">
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <!-- ===== Header ===== -->
    <div class="nav">
        <div class="container">
            <div class="row header-row">
                <div class="brand">
                    <a href="index.html">
                        <img src="images/logo.png" alt="Logo" class="logo">
                    </a>
                </div>

                <div class="row-actions">
                    <button class="btn secondary small" id="btnLogout" type="button">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="h2">My Account</div>
            <p class="p">Yaha aapki Client ID aur Points balance dikhte hain. Points sirf Admin change kar sakta hai.</p>

            <div class="kpi">
                <div class="box">
                    <div class="label">Client ID</div>
                    <div class="val" id="cid">-</div>
                </div>
                <div class="box">
                    <div class="label">Name</div>
                    <div class="val" id="nm">-</div>
                </div>
                <div class="box">
                    <div class="label">Points Balance</div>
                    <div class="val" id="pts">0</div>
                </div>
            </div>

            <div class="hr"></div>

            <div class="row-actions">
                <div>
                    <div class="h2" style="margin:0;">Transaction History</div>
                    <div class="small">Admin credit/debit ka record</div>
                </div>
                <button class="btn secondary small" id="btnRefresh" type="button">Refresh</button>
            </div>

            <div style="overflow:auto;margin-top:10px;">
                <table class="table" id="txTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody id="txBody"></tbody>
                </table>
            </div>

            <div class="hr"></div>

            <div class="h2">Play (Skill Demo)</div>
            <div class="small">Min 50 points. Max = your balance. History auto save hoti hai.</div>

            <div class="grid two" style="margin-top:10px;">
                <div class="card">
                    <div class="input">
                        <label>Play Points</label>
                        <input id="playAmt" type="number" min="50" placeholder="min 50" />
                    </div>

                    <div class="input">
                        <label>Quick Question (Skill)</label>
                        <div id="qText" style="font-weight:800;font-size:18px;padding:10px;border:1px solid rgba(0,0,0,.1);border-radius:12px;">-</div>
                    </div>

                    <div class="input">
                        <label>Your Answer</label>
                        <input id="qAns" placeholder="type answer" />
                    </div>

                    <button class="btn" id="btnPlay" type="button">Play Now</button>
                    <div class="notice" id="playMsg" style="display:none;margin-top:10px;"></div>
                </div>

                <div class="card">
                    <div class="h2" style="margin-top:0;">My Play History</div>
                    <div style="overflow:auto;margin-top:10px;">
                        <table class="table" id="playTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Play Points</th>
                                    <th>Result</th>
                                    <th>Before</th>
                                    <th>After</th>
                                </tr>
                            </thead>
                            <tbody id="playBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="notice small" style="margin-top:12px;">
                Tip: Agar admin panel same browser me open hai, to yaha points auto update honge.
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // ===== Guard: must be logged in (user only) =====
        var u = requireLogin();
        if (!u) throw new Error("Not logged in");
        if (u.role === "admin") window.location.replace("admin.html");

        // Logout
        var lo = document.getElementById("btnLogout");
        if (lo) lo.onclick = function() {
            logout();
        };

        // Refresh
        var rf = document.getElementById("btnRefresh");
        if (rf) rf.onclick = function() {
            render();
            renderPlayHistory();
        };

        function safeText(id, value) {
            var el = document.getElementById(id);
            if (!el) return;
            el.textContent = (value === undefined || value === null || value === "") ? "-" : String(value);
        }

        // ===== Account + txns =====
        function render() {
            var me = currentUser();
            if (!me) return;

            safeText("cid", me.id);
            safeText("nm", me.name);
            safeText("pts", (typeof me.points === "number" ? me.points : 0));

            var rows = userTxns(me.id) || [];
            var tbody = document.getElementById("txBody");
            if (!tbody) return;

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="small">No transactions yet.</td></tr>';
                return;
            }

            var html = "";
            for (var i = 0; i < rows.length; i++) {
                var t = rows[i];
                var type = String(t.type || "").toUpperCase();
                var sign = (t.type === "debit") ? "-" : "+";
                var amt = (t.amount !== undefined && t.amount !== null) ? t.amount : 0;
                var note = t.note ? t.note : "";
                var dt = fmtDate(t.createdAt);

                html += "<tr>" +
                    "<td>" + dt + "</td>" +
                    "<td>" + type + "</td>" +
                    "<td>" + sign + amt + "</td>" +
                    "<td>" + note + "</td>" +
                    "</tr>";
            }
            tbody.innerHTML = html;
        }

        // ===== Skill Game + History =====
        var PLAY_KEY = "club_play_history_v1";

        function loadPlays() {
            var raw = localStorage.getItem(PLAY_KEY);
            return raw ? JSON.parse(raw) : [];
        }

        function savePlays(rows) {
            localStorage.setItem(PLAY_KEY, JSON.stringify(rows));
        }

        function addPlayRow(row) {
            var rows = loadPlays();
            rows.unshift(row);
            savePlays(rows);
        }

        function playsForUser(userId) {
            var rows = loadPlays();
            var out = [];
            for (var i = 0; i < rows.length; i++) {
                if (rows[i].userId === userId) out.push(rows[i]);
            }
            return out;
        }

        function randomQuestion() {
            var a = Math.floor(Math.random() * 10) + 1;
            var b = Math.floor(Math.random() * 10) + 1;
            var op = (Math.random() < 0.5) ? "+" : "-";
            var ans = (op === "+") ? (a + b) : (a - b);
            return {
                text: a + " " + op + " " + b + " = ?",
                ans: String(ans)
            };
        }

        var currentQ = randomQuestion();

        function setQ() {
            currentQ = randomQuestion();
            var q = document.getElementById("qText");
            if (q) q.textContent = currentQ.text;
            var a = document.getElementById("qAns");
            if (a) a.value = "";
        }

        function showPlayMsg(text) {
            var el = document.getElementById("playMsg");
            if (!el) return;
            el.style.display = "block";
            el.textContent = text;
        }

        function renderPlayHistory() {
            var me = currentUser();
            if (!me) return;

            var rows = playsForUser(me.id);
            var tb = document.getElementById("playBody");
            if (!tb) return;

            if (rows.length === 0) {
                tb.innerHTML = '<tr><td colspan="5" class="small">No plays yet.</td></tr>';
                return;
            }

            var html = "";
            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                html += "<tr>" +
                    "<td>" + fmtDate(r.createdAt) + "</td>" +
                    "<td>" + r.playPoints + "</td>" +
                    "<td>" + r.result + "</td>" +
                    "<td>" + r.before + "</td>" +
                    "<td>" + r.after + "</td>" +
                    "</tr>";
            }
            tb.innerHTML = html;
        }

        // Play button
        var playBtn = document.getElementById("btnPlay");
        if (playBtn) {
            playBtn.onclick = function() {
                var me = currentUser();
                if (!me) return;

                var amt = Number(document.getElementById("playAmt").value);
                if (!amt || amt < 50) {
                    showPlayMsg("Minimum play points is 50.");
                    return;
                }
                if (amt > me.points) {
                    showPlayMsg("You can only play within your available points.");
                    return;
                }

                var ans = (document.getElementById("qAns").value || "").trim();
                if (!ans) {
                    showPlayMsg("Please enter your answer.");
                    return;
                }

                var before = me.points;

                // entry debit
                var spend = adjustPoints(me.id, -amt, "Game entry (skill)", null);
                if (!spend.ok) {
                    showPlayMsg(spend.msg);
                    return;
                }

                var isWin = (ans === currentQ.ans);
                if (isWin) {
                    adjustPoints(me.id, amt * 2, "Skill win reward", null);
                }

                var after = currentUser().points;

                addPlayRow({
                    id: "P" + Math.random().toString(36).slice(2, 9).toUpperCase(),
                    userId: me.id,
                    playPoints: amt,
                    result: isWin ? "WIN" : "LOSE",
                    before: before,
                    after: after,
                    createdAt: new Date().toISOString()
                });

                showPlayMsg(isWin ? "WIN! Reward added." : "LOSE. Try again.");
                document.getElementById("playAmt").value = "";
                setQ();
                render();
                renderPlayHistory();
            };
        }

        // Init
        setQ();
        render();
        renderPlayHistory();

        // auto refresh
        setInterval(function() {
            render();
        }, 1000);
    </script>
</body>

</html>