<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Casino - JVBET1803</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="shortcut icon" href="/assets/image/jvbet-logo.png" type="image/x-icon">

    <style>
        /* ---------- AI LIVE DEALER (MP4 loop) ---------- */
        
        .aiLiveBox {
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(212, 175, 55, .25);
            background: rgba(0, 0, 0, .25);
            box-shadow: 0 18px 60px rgba(0, 0, 0, .35);
            position: relative;
            width: 100%;
        }
        
        .aiLiveTop {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(0, 0, 0, .55);
            border: 1px solid rgba(255, 255, 255, .12);
            z-index: 2;
            max-width: calc(100% - 20px);
        }
        
        .liveDot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff3b3b;
            box-shadow: 0 0 14px rgba(255, 59, 59, .85);
            animation: pulse 1.2s infinite;
            flex: 0 0 auto;
        }
        
        @keyframes pulse {
            0%,
            100% {
                transform: scale(1);
                opacity: 1
            }
            50% {
                transform: scale(1.35);
                opacity: .65
            }
        }
        
        .liveTxt {
            font-weight: 900;
            letter-spacing: .4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }
        
        .liveView {
            opacity: .9;
            white-space: nowrap;
            flex: 0 0 auto
        }
        
        .aiVid {
            width: 100%;
            height: 320px;
            object-fit: cover;
            display: block;
            filter: contrast(1.05) saturate(1.05);
            background: #000;
        }
        
        @media (max-width: 900px) {
            .aiVid {
                height: 220px;
            }
        }
        /* ---------- Timer (Responsive) ---------- */
        
        .timerWrap {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap
        }
        
        .timerPill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(212, 175, 55, .35);
            background: rgba(0, 0, 0, .22);
            min-width: 220px;
            max-width: 100%;
        }
        
        .timerNum {
            font-weight: 900
        }
        
        .timerBar {
            flex: 1;
            height: 8px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .08);
            overflow: hidden;
            min-width: 120px;
        }
        
        .timerFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, rgba(212, 175, 55, .95), rgba(255, 255, 255, .35));
        }
        
        .pillSmall {
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(0, 0, 0, .18)
        }
        
        .lockOpen {
            border-color: rgba(34, 197, 94, .45)
        }
        
        .lockPlaced {
            border-color: rgba(43, 111, 255, .45)
        }
        
        .lockLocked {
            border-color: rgba(255, 193, 7, .45)
        }
        
        .lockClosed {
            border-color: rgba(255, 77, 109, .45)
        }
        /* ---------- Single latest result ---------- */
        
        .prevBox {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 10px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(0, 0, 0, .18);
            min-height: 44px;
        }
        
        .resChip {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(212, 175, 55, .28);
            background: rgba(0, 0, 0, .25);
            font-weight: 800;
            letter-spacing: .3px;
            white-space: nowrap;
        }
        
        .waitLine {
            margin-top: 6px
        }
        
        .waitLine .gold {
            font-weight: 900
        }
        /* ---------- Card flip (DT) ---------- */
        
        .card3 {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center
        }
        
        .flipCard {
            width: 72px;
            height: 92px;
            perspective: 800px;
        }
        
        .flipInner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform .6s ease;
        }
        
        .flipCard.flipped .flipInner {
            transform: rotateY(180deg);
        }
        
        .flipFace {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            backface-visibility: hidden;
            overflow: hidden;
        }
        
        .flipBack {
            transform: rotateY(180deg);
        }
        /* ---------- Toast ---------- */
        
        .toast {
            position: fixed;
            left: 50%;
            bottom: 22px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, .78);
            border: 1px solid rgba(212, 175, 55, .35);
            color: #fff;
            padding: 12px 14px;
            border-radius: 14px;
            z-index: 9999;
            display: none;
            max-width: 92vw;
            box-shadow: 0 16px 40px rgba(0, 0, 0, .45);
        }
        
        .toast.show {
            display: block
        }
        
        .toast .t {
            font-weight: 900
        }
        
        .toast.win {
            border-color: rgba(34, 197, 94, .55)
        }
        
        .toast.loss {
            border-color: rgba(255, 77, 109, .55)
        }
        
        .toast.tie {
            border-color: rgba(43, 111, 255, .55)
        }
    </style>
</head>

<body class="bg">
    <header class="header">
        <div class="head-inner">
            <img class="logo" src="../assets/image/jvbet-logo.png" alt="JVBET1803">
        </div>
    </header>

    <main class="wrap">
        <div class="row" style="justify-content:space-between;margin-bottom:12px">
            <div class="row">
                <span class="badge">Client: <span class="gold" id="cid">-</span></span>
                <span class="badge">Points: <span class="gold" id="pts">0</span></span>
                <span class="badge">Win: <span class="gold" id="w">0</span></span>
                <span class="badge">Loss: <span class="gold" id="l">0</span></span>

            </div>
            <button class="btn" type="button" onclick="logout(); location.href='../index.html'">Logout</button>
        </div>

        <div class="tabs">
            <button class="tabbtn active" data-tab="dt" type="button">Dragon Tiger</button>
            <button class="tabbtn" data-tab="tp" type="button">Teen Patti</button>
            <button class="tabbtn" data-tab="rl" type="button">Roulette</button>
            <button class="tabbtn" data-tab="hist" type="button">History</button>
        </div>

        <!-- DRAGON TIGER -->
        <section class="panel active" id="dt">
            <div class="grid">

                <!-- LEFT: AI DEALER + TIMER + LATEST RESULT -->
                <div class="card">
                    <h3>Dragon Tiger (AI Dealer Live Demo)</h3>

                    <div class="aiLiveBox shake">
                        <div class="aiLiveTop">
                            <span class="liveDot"></span>
                            <span class="liveTxt">LIVE AI DEALER</span>
                            <span class="liveView" id="dtView">üëÅ 128</span>
                        </div>

                        <video class="aiVid" autoplay loop muted playsinline>
              <source src="../assets/video/dealer_loop.mp4" type="video/mp4">
            </video>
                    </div>

                    <div class="timerWrap" style="margin-top:10px;justify-content:space-between">
                        <div class="timerPill">
                            <span>‚è≥</span>
                            <span>Closes in:</span>
                            <span class="timerNum gold" id="dtTimer">30</span><span>s</span>
                            <div class="timerBar">
                                <div class="timerFill" id="dtFill"></div>
                            </div>
                        </div>

                        <div class="pillSmall">Round: <span class="gold" id="dtRound">-</span></div>
                        <div class="pillSmall lockOpen" id="dtLock">OPEN</div>
                    </div>

                    <div style="margin-top:10px">
                        <div class="muted">Latest Result</div>
                        <div class="prevBox" id="dtPrev"></div>
                    </div>

                    <p class="muted" style="margin-top:10px">Bet allowed only when timer &gt; 15 sec. Result reveals at 0 sec.</p>
                </div>

                <!-- RIGHT: BET BOARD -->
                <div class="casinoBoard">
                    <div class="cTop">
                        <div class="topBox">
                            <div class="topTitle">Last Result</div>
                            <div class="topValue" id="dtLast">-</div>
                        </div>

                        <div class="topBox">
                            <div class="topTitle" style="text-align:center">Cards</div>
                            <div class="card3">
                                <div class="flipCard" id="fcD">
                                    <div class="flipInner">
                                        <div class="flipFace">?</div>
                                        <div class="flipFace flipBack" id="dtD">?</div>
                                    </div>
                                </div>
                                <div class="flipCard" id="fcT">
                                    <div class="flipInner">
                                        <div class="flipFace">?</div>
                                        <div class="flipFace flipBack" id="dtT">?</div>
                                    </div>
                                </div>
                                <div class="flipCard" id="fcR">
                                    <div class="flipInner">
                                        <div class="flipFace">?</div>
                                        <div class="flipFace flipBack" id="dtR">?</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="topBox">
                            <div class="topTitle">Selected</div>
                            <div class="topValue gold" id="dtPickShow">DRAGON</div>
                        </div>
                    </div>

                    <div class="cMid">
                        <div class="betRow" id="dtBets">
                            <div class="betBox active" data-pick="DRAGON">
                                <div class="betName">DRAGON</div>
                                <div class="betMul">2x</div>
                            </div>
                            <div class="betBox" data-pick="TIGER">
                                <div class="betName">TIGER</div>
                                <div class="betMul">2x</div>
                            </div>
                            <div class="betBox" data-pick="TIE">
                                <div class="betName">TIE</div>
                                <div class="betMul">Refund</div>
                            </div>
                        </div>
                    </div>

                    <div class="cBottom">
                        <div class="chips">
                            <div class="chip" data-v="10">10</div>
                            <div class="chip" data-v="50">50</div>
                            <div class="chip" data-v="100">100</div>
                            <div class="chip" data-v="500">500</div>
                            <div class="chip" data-v="1000">1000</div>
                        </div>

                        <div class="stakeBox">
                            <input class="stakeInput" id="dtStake" type="number" placeholder="Stake points">
                            <button class="btn" id="dtPlay" type="button">PLACE BET</button>
                        </div>

                        <span class="badge" id="dtMsg">-</span>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:14px">
                <h3>Last Bets (Dragon Tiger)</h3>
                <div class="muted waitLine" id="dtWait"></div>
                <table class="table" id="dtPast">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Pick</th>
                            <th>Stake</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- TEEN PATTI -->
        <section class="panel" id="tp">
            <div class="grid">

                <div class="card">
                    <h3>Teen Patti (AI Dealer Live Demo)</h3>

                    <div class="aiLiveBox shake">
                        <div class="aiLiveTop">
                            <span class="liveDot"></span>
                            <span class="liveTxt">LIVE AI DEALER</span>
                            <span class="liveView" id="tpView">üëÅ 212</span>
                        </div>

                        <video class="aiVid" autoplay loop muted playsinline>
              <source src="../assets/video/teen-patti.mp4" type="video/mp4">
            </video>
                    </div>

                    <div class="timerWrap" style="margin-top:10px;justify-content:space-between">
                        <div class="timerPill">
                            <span>‚è≥</span><span>Closes in:</span>
                            <span class="timerNum gold" id="tpTimer">30</span><span>s</span>
                            <div class="timerBar">
                                <div class="timerFill" id="tpFill"></div>
                            </div>
                        </div>
                        <div class="pillSmall">Round: <span class="gold" id="tpRound">-</span></div>
                        <div class="pillSmall lockOpen" id="tpLock">OPEN</div>
                        <div class="pillSmall">Selected: <span class="gold" id="tpPickShow">PLAYER</span></div>
                    </div>

                    <div style="margin-top:10px">
                        <div class="muted">Latest Result</div>
                        <div class="prevBox" id="tpPrev"></div>
                    </div>
                </div>

                <div class="casinoBoard">
                    <div class="cTop">
                        <div class="topBox">
                            <div class="topTitle">Selected</div>
                            <div class="topValue gold" id="tpPickShow2">PLAYER</div>
                        </div>
                        <div class="topBox">
                            <div class="topTitle">Round</div>
                            <div class="topValue" id="tpRound2">-</div>
                        </div>
                        <div class="topBox">
                            <div class="topTitle">Status</div>
                            <div class="topValue" id="tpStatus">-</div>
                        </div>
                    </div>

                    <div class="cMid">
                        <div class="betRow" id="tpBets">
                            <div class="betBox active" data-pick="PLAYER">
                                <div class="betName">PLAYER</div>
                                <div class="betMul">2x</div>
                            </div>
                            <div class="betBox" data-pick="BANKER">
                                <div class="betName">BANKER</div>
                                <div class="betMul">2x</div>
                            </div>
                            <div class="betBox" data-pick="TIE">
                                <div class="betName">TIE</div>
                                <div class="betMul">Refund</div>
                            </div>
                        </div>
                    </div>

                    <div class="cBottom">
                        <div class="chips">
                            <div class="chip" data-v="10">10</div>
                            <div class="chip" data-v="50">50</div>
                            <div class="chip" data-v="100">100</div>
                            <div class="chip" data-v="500">500</div>
                            <div class="chip" data-v="1000">1000</div>
                        </div>

                        <div class="stakeBox">
                            <input class="stakeInput" id="tpStake" type="number" placeholder="Stake points">
                            <button class="btn" id="tpPlay" type="button">PLACE BET</button>
                        </div>

                        <span class="badge" id="tpMsg">-</span>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:14px">
                <h3>Last Bets (Teen Patti)</h3>
                <div class="muted waitLine" id="tpWait"></div>
                <table class="table" id="tpPast">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Pick</th>
                            <th>Stake</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- ROULETTE -->
        <section class="panel" id="rl">
            <div class="grid">

                <div class="card">
                    <h3>Roulette (AI Dealer Live Demo)</h3>

                    <div class="aiLiveBox shake">
                        <div class="aiLiveTop">
                            <span class="liveDot"></span>
                            <span class="liveTxt">LIVE AI DEALER</span>
                            <span class="liveView" id="rView">üëÅ 156</span>
                        </div>

                        <video class="aiVid" autoplay loop muted playsinline>
              <source src="../assets/video/Roulette .mp4" type="video/mp4">
            </video>
                    </div>

                    <div class="timerWrap" style="margin-top:10px;justify-content:space-between">
                        <div class="timerPill">
                            <span>‚è≥</span><span>Closes in:</span>
                            <span class="timerNum gold" id="rTimer">30</span><span>s</span>
                            <div class="timerBar">
                                <div class="timerFill" id="rFill"></div>
                            </div>
                        </div>
                        <div class="pillSmall">Round: <span class="gold" id="rRound">-</span></div>
                        <div class="pillSmall lockOpen" id="rLock">OPEN</div>
                        <div class="pillSmall">Selected: <span class="gold" id="rPickShow">RED</span></div>
                    </div>

                    <div style="margin-top:10px">
                        <div class="muted">Latest Result</div>
                        <div class="prevBox" id="rPrev"></div>
                    </div>
                </div>

                <div class="casinoBoard">
                    <div class="cMid">
                        <div class="betRow" id="rBets">
                            <div class="betBox active" data-pick="RED">
                                <div class="betName">RED</div>
                                <div class="betMul">2x</div>
                            </div>
                            <div class="betBox" data-pick="BLACK">
                                <div class="betName">BLACK</div>
                                <div class="betMul">2x</div>
                            </div>
                        </div>
                    </div>

                    <div class="cBottom">
                        <div class="chips">
                            <div class="chip" data-v="10">10</div>
                            <div class="chip" data-v="50">50</div>
                            <div class="chip" data-v="100">100</div>
                            <div class="chip" data-v="500">500</div>
                            <div class="chip" data-v="1000">1000</div>
                        </div>

                        <div class="stakeBox">
                            <input class="stakeInput" id="rStake" type="number" placeholder="Stake points">
                            <button class="btn" id="rPlay" type="button">PLACE BET</button>
                        </div>

                        <span class="badge" id="rMsg">-</span>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:14px">
                <h3>Last Bets (Roulette)</h3>
                <div class="muted waitLine" id="rWait"></div>
                <table class="table" id="rPast">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Pick</th>
                            <th>Stake</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- HISTORY -->
        <section class="panel" id="hist">
            <div class="card">
                <h3>Full Bet History</h3>
                <table class="table" id="bh">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Game</th>
                            <th>Pick</th>
                            <th>Stake</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>

    <div class="toast" id="toast">
        <div class="t" id="toastTitle">-</div>
        <div class="muted" id="toastBody">-</div>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        requireClient();

        const TOTAL_SEC = 30;
        const LOCK_REMAINING = 15;

        function showToast(type, title, body) {
            var t = document.getElementById("toast");
            t.className = "toast show " + (type || "");
            document.getElementById("toastTitle").textContent = title;
            document.getElementById("toastBody").textContent = body || "";
            setTimeout(function() {
                t.className = "toast";
            }, 2500);
        }

        function beep() {
            try {
                var ctx = new(window.AudioContext || window.webkitAudioContext)();
                var o = ctx.createOscillator();
                var g = ctx.createGain();
                o.type = "sine";
                o.frequency.value = 880;
                g.gain.value = 0.16;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(function() {
                    o.stop();
                    ctx.close();
                }, 160);
            } catch (e) {}
        }

        function vib(ms) {
            try {
                if (navigator.vibrate) navigator.vibrate(ms);
            } catch (e) {}
        }

        // Single latest result per game
        function prevKey(game) {
            return "jvbet_last_" + game;
        }

        function setLastResult(game, val) {
            localStorage.setItem(prevKey(game), String(val));
            renderLastResult(game);
        }

        function getLastResult(game) {
            return localStorage.getItem(prevKey(game)) || "";
        }

        function renderLastResult(game) {
            var el = document.getElementById(game === "DragonTiger" ? "dtPrev" : (game === "TeenPatti" ? "tpPrev" : "rPrev"));
            var v = getLastResult(game);
            el.innerHTML = v ? ('<span class="resChip">' + v + '</span>') : '<span class="muted">No result</span>';
        }

        function refreshTop() {
            var me = getMeClient();
            document.getElementById("cid").textContent = me.clientId;
            document.getElementById("pts").textContent = me.points;
            var st = statsWinLoss(me.clientId);
            document.getElementById("w").textContent = st.win;
            document.getElementById("l").textContent = st.loss;

        }

        function setPastTable(game, tableId) {
            var me = getMeClient();
            var bets = getClientBets(me.clientId).filter(function(b) {
                return b.game === game && b.result !== "PENDING";
            }).slice(0, 10);
            var tb = document.querySelector("#" + tableId + " tbody");
            tb.innerHTML = bets.map(function(b) {
                return "<tr><td>" + fmtDate(b.at) + "</td><td>" + b.pick + "</td><td class='gold'>" + b.stake + "</td><td>" + b.result + "</td></tr>";
            }).join("") || "<tr><td colspan='4' class='muted'>No bets</td></tr>";
        }

        // Tabs
        document.querySelectorAll(".tabbtn").forEach(function(btn) {
            btn.addEventListener("click", function() {
                document.querySelectorAll(".tabbtn").forEach(function(x) {
                    x.classList.remove("active");
                });
                document.querySelectorAll(".panel").forEach(function(p) {
                    p.classList.remove("active");
                });
                btn.classList.add("active");
                document.getElementById(btn.dataset.tab).classList.add("active");
                if (btn.dataset.tab === "hist") renderHistory();
            });
        });

        // Picks
        function bindBetBoxes(containerId, showId, showId2) {
            var cont = document.getElementById(containerId);
            var show = document.getElementById(showId);
            var show2 = showId2 ? document.getElementById(showId2) : null;
            var active = cont.querySelector(".betBox.active");
            var pick = active ? active.dataset.pick : "";
            show.textContent = pick;
            if (show2) show2.textContent = pick;

            cont.querySelectorAll(".betBox").forEach(function(box) {
                box.addEventListener("click", function() {
                    cont.querySelectorAll(".betBox").forEach(function(b) {
                        b.classList.remove("active");
                    });
                    box.classList.add("active");
                    pick = box.dataset.pick || "";
                    show.textContent = pick;
                    if (show2) show2.textContent = pick;
                });
            });
            return function() {
                return pick;
            };
        }

        function bindChips(scopeEl, inputEl) {
            scopeEl.querySelectorAll(".chip").forEach(function(ch) {
                ch.addEventListener("click", function() {
                    var v = Number(ch.dataset.v || 0);
                    var cur = Number(inputEl.value || 0);
                    inputEl.value = cur + v;
                });
            });
        }

        var getDTPick = bindBetBoxes("dtBets", "dtPickShow");
        var dtStake = document.getElementById("dtStake");
        bindChips(document.getElementById("dt"), dtStake);

        var getTPPick = bindBetBoxes("tpBets", "tpPickShow", "tpPickShow2");
        var tpStake = document.getElementById("tpStake");
        bindChips(document.getElementById("tp"), tpStake);

        var getRPick = bindBetBoxes("rBets", "rPickShow");
        var rStake = document.getElementById("rStake");
        bindChips(document.getElementById("rl"), rStake);

        function setWait(game, roundId) {
            var map = {
                DragonTiger: "dtWait",
                TeenPatti: "tpWait",
                Roulette: "rWait"
            };
            var el = document.getElementById(map[game]);
            if (!el) return;
            if (roundId) el.innerHTML = "‚è≥ BET PLACED (Waiting for result) ‚Äî Round: <span class='gold'>" + roundId + "</span>";
            else el.textContent = "";
        }

        // Results
        function randCard() {
            return 1 + Math.floor(Math.random() * 13);
        }

        function cardStr(v) {
            return (v === 1 ? "A" : v === 11 ? "J" : v === 12 ? "Q" : v === 13 ? "K" : String(v));
        }

        function drawDragonTiger() {
            var d = randCard(),
                t = randCard();
            var res = (d === t) ? "TIE" : (d > t ? "DRAGON" : "TIGER");
            return {
                d: d,
                t: t,
                res: res
            };
        }

        function randTP() {
            return 2 + Math.floor(Math.random() * 13);
        }

        function tpScore(a, b, c) {
            var s = a + b + c;
            var triple = (a === b && b === c);
            var pair = (a === b || b === c || a === c);
            if (triple) s += 1000;
            else if (pair) s += 200;
            return s;
        }

        function drawTeenPatti() {
            var p = [randTP(), randTP(), randTP()];
            var b = [randTP(), randTP(), randTP()];
            var ps = tpScore(p[0], p[1], p[2]);
            var bs = tpScore(b[0], b[1], b[2]);
            var res = (ps === bs) ? "TIE" : (ps > bs ? "PLAYER" : "BANKER");
            return {
                res: res
            };
        }

        function drawRoulette() {
            var n = Math.floor(Math.random() * 37);
            var color = (n === 0) ? "GREEN" : (n % 2 === 0 ? "BLACK" : "RED");
            return {
                n: n,
                color: color
            };
        }

        // DT flip
        function flipReset() {
            document.getElementById("fcD").classList.remove("flipped");
            document.getElementById("fcT").classList.remove("flipped");
            document.getElementById("fcR").classList.remove("flipped");
            document.getElementById("dtD").textContent = "?";
            document.getElementById("dtT").textContent = "?";
            document.getElementById("dtR").textContent = "?";
        }

        function flipShow(d, t, r) {
            document.getElementById("dtD").textContent = d;
            document.getElementById("dtT").textContent = t;
            document.getElementById("dtR").textContent = r;
            setTimeout(function() {
                document.getElementById("fcD").classList.add("flipped");
                document.getElementById("fcT").classList.add("flipped");
                document.getElementById("fcR").classList.add("flipped");
            }, 50);
        }

        function setLock(el, state) {
            el.classList.remove("lockOpen", "lockPlaced", "lockLocked", "lockClosed");
            if (state === "OPEN") {
                el.classList.add("lockOpen");
                el.textContent = "OPEN";
            }
            if (state === "PLACED") {
                el.classList.add("lockPlaced");
                el.textContent = "BET PLACED";
            }
            if (state === "LOCKED") {
                el.classList.add("lockLocked");
                el.textContent = "LOCKED";
            }
            if (state === "CLOSED") {
                el.classList.add("lockClosed");
                el.textContent = "CLOSED";
            }
        }

        // Place bet
        document.getElementById("dtPlay").addEventListener("click", function() {
            var me = getMeClient();
            var r = ensureRound(me.clientId, "DragonTiger", TOTAL_SEC, LOCK_REMAINING);
            if (!isBetOpen(r)) {
                document.getElementById("dtMsg").textContent = "Locked (bet only when timer > 15)";
                return;
            }
            if (r.betPlaced) {
                document.getElementById("dtMsg").textContent = "Already bet in this round.";
                return;
            }
            try {
                markBetPlaced(me.clientId, "DragonTiger");
                placePendingBet({
                    game: "DragonTiger",
                    pick: getDTPick(),
                    stake: dtStake.value,
                    roundId: r.roundId
                });
                setWait("DragonTiger", r.roundId);
                refreshTop();
                showToast("tie", "üïí BET PLACED", "Wait for result at 0 sec");
                vib(40);
                document.getElementById("dtMsg").textContent = "BET PLACED";
            } catch (e) {
                document.getElementById("dtMsg").textContent = e.message || String(e);
            }
        });

        document.getElementById("tpPlay").addEventListener("click", function() {
            var me = getMeClient();
            var r = ensureRound(me.clientId, "TeenPatti", TOTAL_SEC, LOCK_REMAINING);
            if (!isBetOpen(r)) {
                document.getElementById("tpMsg").textContent = "Locked (bet only when timer > 15)";
                return;
            }
            if (r.betPlaced) {
                document.getElementById("tpMsg").textContent = "Already bet in this round.";
                return;
            }
            try {
                markBetPlaced(me.clientId, "TeenPatti");
                placePendingBet({
                    game: "TeenPatti",
                    pick: getTPPick(),
                    stake: tpStake.value,
                    roundId: r.roundId
                });
                setWait("TeenPatti", r.roundId);
                refreshTop();
                showToast("tie", "üïí BET PLACED", "Wait for result at 0 sec");
                vib(40);
                document.getElementById("tpMsg").textContent = "BET PLACED";
            } catch (e) {
                document.getElementById("tpMsg").textContent = e.message || String(e);
            }
        });

        document.getElementById("rPlay").addEventListener("click", function() {
            var me = getMeClient();
            var r = ensureRound(me.clientId, "Roulette", TOTAL_SEC, LOCK_REMAINING);
            if (!isBetOpen(r)) {
                document.getElementById("rMsg").textContent = "Locked (bet only when timer > 15)";
                return;
            }
            if (r.betPlaced) {
                document.getElementById("rMsg").textContent = "Already bet in this round.";
                return;
            }
            try {
                markBetPlaced(me.clientId, "Roulette");
                placePendingBet({
                    game: "Roulette",
                    pick: getRPick(),
                    stake: rStake.value,
                    roundId: r.roundId
                });
                setWait("Roulette", r.roundId);
                refreshTop();
                showToast("tie", "üïí BET PLACED", "Wait for result at 0 sec");
                vib(40);
                document.getElementById("rMsg").textContent = "BET PLACED";
            } catch (e) {
                document.getElementById("rMsg").textContent = e.message || String(e);
            }
        });

        function revealDT(me, r) {
            var pb = getPendingBet(me.clientId, "DragonTiger", r.roundId);
            if (!pb) {
                markRevealed(me.clientId, "DragonTiger");
                setWait("DragonTiger", "");
                return;
            }

            setTimeout(function() {
                var draw = drawDragonTiger();
                flipReset();
                flipShow(cardStr(draw.d), cardStr(draw.t), draw.res);

                document.getElementById("dtLast").textContent = draw.res;
                setLastResult("DragonTiger", draw.res);

                var outcome = "LOSS";
                if (draw.res === "TIE") outcome = "TIE";
                else if (pb.pick === draw.res) outcome = "WIN";

                settlePendingBet({
                    betId: pb.betId,
                    outcome: outcome
                });

                setWait("DragonTiger", "");
                refreshTop();
                setPastTable("DragonTiger", "dtPast");

                if (outcome === "WIN") {
                    showToast("win", "‚úÖ WIN", "2x credited");
                    vib([60, 40, 60]);
                } else if (outcome === "TIE") {
                    showToast("tie", "‚ÑπÔ∏è TIE", "Stake returned");
                    vib(60);
                } else {
                    showToast("loss", "‚ùå LOSS", "Try again");
                    vib(120);
                }

                document.getElementById("dtMsg").textContent = "RESULT: " + outcome;
                markRevealed(me.clientId, "DragonTiger");
            }, 2500);
        }

        function revealTP(me, r) {
            var pb = getPendingBet(me.clientId, "TeenPatti", r.roundId);
            if (!pb) {
                markRevealed(me.clientId, "TeenPatti");
                setWait("TeenPatti", "");
                return;
            }

            setTimeout(function() {
                var draw = drawTeenPatti();
                setLastResult("TeenPatti", draw.res);

                var outcome = "LOSS";
                if (draw.res === "TIE") outcome = "TIE";
                else if (pb.pick === draw.res) outcome = "WIN";

                settlePendingBet({
                    betId: pb.betId,
                    outcome: outcome
                });

                setWait("TeenPatti", "");
                refreshTop();
                setPastTable("TeenPatti", "tpPast");
                document.getElementById("tpStatus").textContent = outcome;

                if (outcome === "WIN") {
                    showToast("win", "‚úÖ WIN", "2x credited");
                    vib([60, 40, 60]);
                } else if (outcome === "TIE") {
                    showToast("tie", "‚ÑπÔ∏è TIE", "Stake returned");
                    vib(60);
                } else {
                    showToast("loss", "‚ùå LOSS", "Try again");
                    vib(120);
                }

                document.getElementById("tpMsg").textContent = "RESULT: " + outcome;
                markRevealed(me.clientId, "TeenPatti");
            }, 2500);
        }

        function revealR(me, r) {
            var pb = getPendingBet(me.clientId, "Roulette", r.roundId);
            if (!pb) {
                markRevealed(me.clientId, "Roulette");
                setWait("Roulette", "");
                return;
            }

            setTimeout(function() {
                var draw = drawRoulette();
                var latest = draw.color + " " + draw.n;
                setLastResult("Roulette", latest);

                var outcome = (pb.pick === draw.color) ? "WIN" : "LOSS";
                settlePendingBet({
                    betId: pb.betId,
                    outcome: outcome
                });

                setWait("Roulette", "");
                refreshTop();
                setPastTable("Roulette", "rPast");

                if (outcome === "WIN") {
                    showToast("win", "‚úÖ WIN", "2x credited");
                    vib([60, 40, 60]);
                } else {
                    showToast("loss", "‚ùå LOSS", "Try again");
                    vib(120);
                }

                document.getElementById("rMsg").textContent = "RESULT: " + outcome;
                markRevealed(me.clientId, "Roulette");
            }, 2500);
        }

        var lastBeep = {
            DT: -1,
            TP: -1,
            R: -1
        };

        function tickGame(game, timerId, fillId, roundIdEl, lockId, playBtnId, revealFn, beepKey) {
            var me = getMeClient();
            var r = ensureRound(me.clientId, game, TOTAL_SEC, LOCK_REMAINING);

            document.getElementById(roundIdEl).textContent = r.roundId;
            if (game === "TeenPatti") {
                document.getElementById("tpRound2").textContent = r.roundId;
            }

            var left = secondsLeftRound(r);
            document.getElementById(timerId).textContent = left;

            var pct = Math.max(0, Math.min(100, (left / TOTAL_SEC) * 100));
            document.getElementById(fillId).style.width = pct + "%";

            if (left <= 3 && left > 0 && lastBeep[beepKey] !== left) {
                lastBeep[beepKey] = left;
                beep();
                vib(20);
            }
            if (left > 3) lastBeep[beepKey] = -1;

            var lockEl = document.getElementById(lockId);
            var btn = document.getElementById(playBtnId);

            if (left <= 0) {
                btn.disabled = true;
                btn.style.opacity = ".6";
                setLock(lockEl, "CLOSED");

                if (!r.revealed) {
                    revealFn(me, r);
                } else {
                    if (!r.nextStarted) {
                        markNextStarted(me.clientId, game);
                        setTimeout(function() {
                            startNextRound(me.clientId, game, TOTAL_SEC, LOCK_REMAINING);
                            if (game === "DragonTiger") {
                                flipReset();
                                document.getElementById("dtMsg").textContent = "-";
                            }
                            if (game === "TeenPatti") {
                                document.getElementById("tpMsg").textContent = "-";
                                document.getElementById("tpStatus").textContent = "-";
                            }
                            if (game === "Roulette") {
                                document.getElementById("rMsg").textContent = "-";
                            }
                        }, 900);
                    }
                }
                return;
            }

            if (isBetOpen(r)) {
                if (r.betPlaced) {
                    btn.disabled = true;
                    btn.style.opacity = ".6";
                    setLock(lockEl, "PLACED");
                } else {
                    btn.disabled = false;
                    btn.style.opacity = "1";
                    setLock(lockEl, "OPEN");
                }
            } else {
                btn.disabled = true;
                btn.style.opacity = ".6";
                setLock(lockEl, r.betPlaced ? "PLACED" : "LOCKED");
            }
        }

        function renderHistory() {
            var me = getMeClient();
            var bets = getClientBets(me.clientId).filter(function(b) {
                return b.result !== "PENDING";
            });
            var bh = document.querySelector("#bh tbody");
            bh.innerHTML = bets.map(function(b) {
                return "<tr><td>" + fmtDate(b.at) + "</td><td>" + b.game + "</td><td>" + b.pick + "</td><td class='gold'>" + b.stake + "</td><td>" + b.result + "</td></tr>";
            }).join("") || "<tr><td colspan='5' class='muted'>No bets</td></tr>";
        }

        // viewer fake random
        function bumpView(id, base) {
            var el = document.getElementById(id);
            if (!el) return;
            var v = base + Math.floor(Math.random() * 25);
            el.textContent = "üëÅ " + v;
        }
        setInterval(function() {
            bumpView("dtView", 120);
            bumpView("tpView", 200);
            bumpView("rView", 150);
        }, 2500);

        refreshTop();
        setPastTable("DragonTiger", "dtPast");
        setPastTable("TeenPatti", "tpPast");
        setPastTable("Roulette", "rPast");
        renderLastResult("DragonTiger");
        renderLastResult("TeenPatti");
        renderLastResult("Roulette");

        setInterval(function() {
            tickGame("DragonTiger", "dtTimer", "dtFill", "dtRound", "dtLock", "dtPlay", revealDT, "DT");
            tickGame("TeenPatti", "tpTimer", "tpFill", "tpRound", "tpLock", "tpPlay", revealTP, "TP");
            tickGame("Roulette", "rTimer", "rFill", "rRound", "rLock", "rPlay", revealR, "R");
        }, 200);
    </script>
</body>

</html>