<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Casino - JVBET1803</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<link rel="stylesheet" href="../assets/css/style.css"/>
<link rel="shortcut icon" href="../assets/image/jvbet-logo.png"/>

<style>
.aiLiveBox{border-radius:16px;overflow:hidden;border:1px solid rgba(212,175,55,.25);background:rgba(0,0,0,.25);box-shadow:0 18px 60px rgba(0,0,0,.35);position:relative;width:100%}
.aiVid{width:100%;height:260px;object-fit:cover;background:#000}
@media(max-width:700px){.aiVid{height:200px}}

.timerWrap{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.timerPill{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(212,175,55,.35);background:rgba(0,0,0,.22)}
.timerBar{flex:1;height:6px;border-radius:999px;background:#222;overflow:hidden}
.timerFill{height:100%;background:linear-gradient(90deg,#d4af37,#fff);width:100%}

.prevBox{display:flex;gap:6px;flex-wrap:wrap;padding:10px;border-radius:12px;background:rgba(0,0,0,.18)}
.resChip{padding:4px 10px;border-radius:999px;border:1px solid rgba(212,175,55,.35);font-weight:800}

.flipFace{font-size:20px;overflow:hidden;white-space:nowrap}
@media(max-width:600px){.flipFace{font-size:16px}}

.scrollBox{overflow:auto;max-height:240px}
.scrollBox table{min-width:600px}

</style>
</head>

<body class="bg">

<header class="header">
<div class="head-inner">
<img class="logo" src="../assets/image/jvbet-logo.png"/>
</div>
</header>

<main class="wrap">

<div class="row" style="justify-content:space-between;margin-bottom:12px">
<div class="row">
<span class="badge">Client: <span id="cid" class="gold">-</span></span>
<span class="badge">Points: <span id="pts" class="gold">0</span></span>
</div>
<button class="btn" id="logoutBtn">Logout</button>
</div>

<div class="tabs">
<button class="tabbtn active" data-tab="dt">Dragon Tiger</button>
<button class="tabbtn" data-tab="tp">Teen Patti</button>
<button class="tabbtn" data-tab="rl">Roulette</button>
<button class="tabbtn" data-tab="hist">History</button>
</div>

<!-- DRAGON TIGER -->
<section class="panel active" id="dt">
<div class="card">
<h3>Dragon Tiger</h3>

<div class="timerWrap">
<div class="timerPill">
‚è≥ <span id="dtTimer">30</span>s
<div class="timerBar"><div id="dtFill" class="timerFill"></div></div>
</div>
</div>

<div class="prevBox" id="dtPrev"></div>

<input id="dtStake" type="number" placeholder="Enter Bet" class="stakeInput"/>
<button id="dtPlay" class="btn">Place Bet</button>
<div id="dtMsg"></div>

<div class="scrollBox">
<table class="table" id="dtPast">
<thead><tr><th>Time</th><th>Pick</th><th>Points</th><th>Result</th></tr></thead>
<tbody></tbody>
</table>
</div>

</div>
</section>

<!-- HISTORY -->
<section class="panel" id="hist">
<div class="card">
<h3>Full History</h3>
<div class="scrollBox">
<table class="table" id="bh">
<thead><tr><th>Time</th><th>Game</th><th>Pick</th><th>Points</th><th>Result</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</section>

</main>

<!-- Firebase -->
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE INIT ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCAFH5_1RjVHyZLwkj26zQPCq0-8S0fSKA",
  authDomain: "jvbet-bbf90.firebaseapp.com",
  projectId: "jvbet-bbf90",
});
const db = firebase.firestore();

/* ================= SESSION ================= */
const session = JSON.parse(localStorage.getItem("jvbet_session"));
if(!session){ location.href="../index.html"; }
const CLIENT_ID = session.id;
document.getElementById("cid").textContent = CLIENT_ID;

document.getElementById("logoutBtn").onclick = ()=>{
  localStorage.removeItem("jvbet_session");
  location.href="../index.html";
};

/* ================= GAME CONFIG ================= */
const TOTAL_SEC = 30;
const LOCK_TIME = 15;
let roundStart = Date.now();

/* ================= STORAGE KEYS ================= */
const RESULT_KEY = "jvbet_dt_results";
const BET_KEY = "jvbet_bets";

/* ================= LOAD ================= */
function load(key, def){
  try{ return JSON.parse(localStorage.getItem(key)) || def; }
  catch(e){ return def; }
}
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ================= RESULTS ================= */
function addResult(res){
  let arr = load(RESULT_KEY, []);
  arr.unshift(res);
  if(arr.length>5) arr = arr.slice(0,5);
  save(RESULT_KEY, arr);
  renderResults();
}
function renderResults(){
  const box = document.getElementById("dtPrev");
  const arr = load(RESULT_KEY, []);
  box.innerHTML = arr.map(r=>`<span class="resChip">${r}</span>`).join("");
}

/* ================= BETS ================= */
function addBet(bet){
  let arr = load(BET_KEY, []);
  arr.unshift(bet);
  save(BET_KEY, arr);
}
function renderLast10(){
  const arr = load(BET_KEY, [])
    .filter(b=>b.clientId===CLIENT_ID)
    .slice(0,10);

  const tb = document.querySelector("#dtPast tbody");
  tb.innerHTML = arr.map(b=>
    `<tr>
      <td>${new Date(b.time).toLocaleTimeString()}</td>
      <td>${b.pick}</td>
      <td>${b.stake}</td>
      <td>${b.result}</td>
    </tr>`
  ).join("") || `<tr><td colspan="4">No history</td></tr>`;
}

/* ================= TIMER ENGINE ================= */
function secondsLeft(){
  const diff = Math.floor((Date.now()-roundStart)/1000);
  return TOTAL_SEC - diff;
}

function nextRound(){
  roundStart = Date.now();
}

function drawResult(){
  const picks = ["DRAGON","TIGER","TIE"];
  return picks[Math.floor(Math.random()*3)];
}

/* ================= MAIN TICK ================= */
setInterval(()=>{
  let left = secondsLeft();

  if(left <= 0){
    const result = drawResult();
    addResult(result);

    const pending = load("pending_bet", null);
    if(pending && pending.round === pendingRound){
      pending.result = (pending.pick === result) ? "WIN" :
                       (result==="TIE") ? "TIE" : "LOSS";
      addBet(pending);
      localStorage.removeItem("pending_bet");
    }

    nextRound();
  }

  if(left<0) left=0;

  document.getElementById("dtTimer").textContent = left;
  document.getElementById("dtFill").style.width = (left/TOTAL_SEC*100)+"%";

},500);

/* ================= PLAY ================= */
let pendingRound = 1;

document.getElementById("dtPlay").onclick = ()=>{
  const left = secondsLeft();
  if(left<=LOCK_TIME){
    document.getElementById("dtMsg").textContent="Bet Locked";
    return;
  }

  const stake = Number(document.getElementById("dtStake").value);
  if(!stake || stake<=0){
    document.getElementById("dtMsg").textContent="Enter Bet";
    return;
  }

  const bet = {
    clientId: CLIENT_ID,
    pick: "DRAGON",
    stake: stake,
    round: pendingRound,
    result: "PENDING",
    time: Date.now()
  };

  localStorage.setItem("pending_bet", JSON.stringify(bet));
  document.getElementById("dtMsg").textContent="Bet Placed";
};

/* ================= INIT ================= */
renderResults();
renderLast10();
setInterval(renderLast10,2000);

</script>


</body>
</html>

