<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Casino - JVBET1803</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="shortcut icon" href="../assets/image/jvbet-logo.png" type="image/x-icon" />

  <style>
    :root{
      --bg:#05060a;
      --gold:#d4af37;
      --goldSoft: rgba(212,175,55,.22);

      --text:#fff;
      --muted: rgba(255,255,255,.72);

      --shadow: 0 18px 60px rgba(0,0,0,.65);

      --good: rgba(34,197,94,1);
      --warn: rgba(255,193,7,1);
      --bad: rgba(255,77,109,1);
      --blue: rgba(43,111,255,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif;
      background:
        radial-gradient(1200px 650px at 15% -10%, rgba(212,175,55,.16), transparent 55%),
        radial-gradient(950px 550px at 90% 0%, rgba(212,175,55,.08), transparent 55%),
        radial-gradient(900px 550px at 40% 120%, rgba(255,255,255,.05), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.88), rgba(0,0,0,.96)),
        var(--bg);
      background-blend-mode: screen, screen, screen, normal, normal;
      min-height:100dvh;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-80px;
      pointer-events:none;
      background:
        radial-gradient(circle at 20% 10%, rgba(212,175,55,.10), transparent 35%),
        radial-gradient(circle at 70% 35%, rgba(212,175,55,.06), transparent 45%),
        radial-gradient(circle at 35% 80%, rgba(212,175,55,.08), transparent 50%),
        repeating-radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.06) 0 1px, transparent 1px 6px);
      opacity:.18;
      mix-blend-mode: overlay;
      filter: blur(.2px);
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px;
      padding-bottom: 104px;
    }

    .gold{color:var(--gold)}
    .muted{color:var(--muted);font-weight:800}

    /* TOP HEADER */
    .topBanner{
      position: sticky;
      top:0;
      z-index:100;
      padding: 12px;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .bannerInner{
      max-width:980px;
      margin:0 auto;
      border-radius: 18px;
      border: 1px solid rgba(212,175,55,.18);
      background:
        radial-gradient(900px 260px at 30% 0%, rgba(212,175,55,.22), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.55));
      box-shadow: var(--shadow);
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:relative;
      overflow:hidden;
    }
    .bannerInner::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: linear-gradient(90deg, transparent, rgba(212,175,55,.10), transparent);
      opacity:.55;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{
      height:42px;width:auto;display:block;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.55)) drop-shadow(0 0 18px rgba(212,175,55,.28));
    }
    .brandTxt .t2{
      font-weight:1000;font-size:12px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.35px;
    }
    .logoutBtn{
      display:inline-flex;align-items:center;gap:10px;
      padding: 10px 16px;border-radius: 12px;
      border: 1px solid rgba(212,175,55,.25);
      background: rgba(0,0,0,.35);
      color:#fff;font-weight:1100;cursor:pointer;user-select:none;
      box-shadow: 0 10px 26px rgba(0,0,0,.45);
    }
    .logoutBtn:active{transform:scale(.99)}
    .logoutBtn .ic{filter: drop-shadow(0 0 10px rgba(212,175,55,.30))}

    /* STATS BAR */
    .statsBar{
      max-width:980px;
      margin:10px auto 0;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .statPill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      font-weight:1000;
      white-space:nowrap;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* TABS: single row + scroll */
    .tabsRow{
      max-width:980px;
      margin: 10px auto 0;
      display:flex;
      gap:10px;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
      padding-bottom: 2px;
    }
    .tabsRow::-webkit-scrollbar{display:none}
    .tabBtn{
      flex: 0 0 auto;
      display:inline-flex;align-items:center;gap:10px;
      padding: 10px 14px;border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color:#fff;font-weight:1100;cursor:pointer;user-select:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .tabBtn.active{
      border-color: rgba(212,175,55,.38);
      background:
        radial-gradient(220px 80px at 30% 0%, rgba(212,175,55,.24), transparent 60%),
        rgba(0,0,0,.28);
      box-shadow:
        0 16px 40px rgba(0,0,0,.55),
        inset 0 0 0 1px rgba(212,175,55,.16);
    }

    .panel{display:none}
    .panel.active{display:block}

    /* SECTION BAR */
    .sectionBar{
      margin-top: 14px;border-radius: 14px;
      border: 1px solid rgba(212,175,55,.16);
      background:
        radial-gradient(900px 200px at 30% 0%, rgba(212,175,55,.14), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.45));
      padding: 12px 14px;
      box-shadow: var(--shadow);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      overflow:hidden;
    }
    .sectionBar .title{display:flex;align-items:center;gap:10px;font-weight:1100;letter-spacing:.2px;font-size:18px}
    .sectionBar .badgeLive{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      font-weight:1000;white-space:nowrap;
    }

    /* CARDS */
    .card{
      margin-top: 12px;border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 300px at 20% 0%, rgba(212,175,55,.08), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.52));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .liveWrap{
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(212,175,55,.18);
      background: rgba(0,0,0,.35);
    }
    .liveTopLeft{
      position:absolute;top:12px;left:12px;z-index:5;
      display:flex;align-items:center;gap:10px;
      padding: 8px 10px;border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.45);
      font-weight:1100;white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#ff3b3b;
      box-shadow: 0 0 14px rgba(255,59,59,.85);
      animation:pulse 1.2s infinite;
    }
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.35);opacity:.65}}
    .video{
      width:100%;
      height: 320px;
      object-fit:cover;
      display:block;
      background:#000;
      filter: contrast(1.05) saturate(1.05);
    }
    @media (max-width: 560px){ .video{height: 250px} }

    .lockedOverlay{
      position:absolute;inset:0;z-index:6;
      display:none;align-items:center;justify-content:center;padding: 16px;
      background: linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.72));
      backdrop-filter: blur(1.5px);
    }
    .lockedOverlay.show{display:flex}
    .lockedCard{
      width:min(520px, 92%);
      border-radius: 16px;
      border: 1px solid rgba(212,175,55,.22);
      background: rgba(0,0,0,.58);
      box-shadow: 0 22px 70px rgba(0,0,0,.65);
      padding: 14px;text-align:center;
    }
    .lockedCard .t{font-weight:1100;font-size:16px;letter-spacing:.2px}
    .lockedCard .s{margin-top:6px;color:var(--muted);font-weight:900;font-size:13px}
    .lockedRow{margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .miniPill{
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      font-weight:1000;white-space:nowrap;
    }

    .timerLine{
      display:flex;align-items:center;gap:10px;
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.32);
      flex-wrap:wrap;
    }
    .progressOuter{
      flex: 1 1 360px;
      display:flex;align-items:center;gap:10px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,.22);
      background: rgba(0,0,0,.35);
      padding: 8px 10px;
      min-width: 260px;
    }
    .timerText{font-weight:1100;white-space:nowrap}
    .progressBar{
      flex:1;height: 10px;border-radius: 999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
    }
    .progressFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(212,175,55,.92), rgba(255,255,255,.22));
      box-shadow: 0 0 18px rgba(212,175,55,.25);
    }
    .statusPill{
      padding: 10px 14px;border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      font-weight:1100;white-space:nowrap;
    }
    .lockOpen{ border-color: rgba(34,197,94,.40) }
    .lockLocked{ border-color: rgba(255,193,7,.40) }
    .lockClosed{ border-color: rgba(255,77,109,.40) }
    .lockPlaced{ border-color: rgba(43,111,255,.40) }

    .betRow{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
    }
    @media (max-width: 560px){
      .betRow{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    .betBox{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      padding: 14px 10px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .betBox:active{transform:scale(.99)}
    .betBox.active{
      border-color: rgba(212,175,55,.40);
      background:
        radial-gradient(220px 90px at 30% 0%, rgba(212,175,55,.22), transparent 60%),
        rgba(0,0,0,.30);
      box-shadow:
        0 16px 40px rgba(0,0,0,.55),
        inset 0 0 0 1px rgba(212,175,55,.14);
    }
    .betName{font-weight:1100;letter-spacing:.2px}
    .betMul{margin-top:4px;font-weight:900;color:var(--muted);font-size:12px}

    .tableCard{
      margin-top: 12px;border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 300px at 20% 0%, rgba(212,175,55,.08), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.52));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .tableHead{
      padding: 12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.30);
      flex-wrap:wrap;
    }
    .tableHead .h{font-weight:1100;display:flex;align-items:center;gap:10px;white-space:nowrap}
    .tableActions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .stakeRow{
      display:flex;gap:10px;align-items:stretch;
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
      flex-wrap:wrap;
    }
    .stakeInput{
      flex: 1 1 260px;min-width: 180px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      color:#fff;
      padding: 12px 12px;
      font-weight:1000;
      outline:none;
    }
    .placeBtn{
      padding: 12px 18px;border-radius: 12px;
      border: 1px solid rgba(212,175,55,.28);
      background: linear-gradient(180deg, rgba(212,175,55,1), rgba(255,255,255,.78));
      color:#120c00;
      font-weight:1100;
      cursor:pointer;user-select:none;
      white-space:nowrap;
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
    }
    .placeBtn:active{transform:scale(.99)}
    .placeBtn:disabled{opacity:.55;cursor:not-allowed}

    .chipBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
    }
    .chip{
      min-width:70px;text-align:center;
      padding: 10px 14px;border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      font-weight:1100;cursor:pointer;user-select:none;
    }
    .chip:active{transform:scale(.99)}
    .chip.goldChip{border-color: rgba(212,175,55,.30); box-shadow: 0 0 18px rgba(212,175,55,.12);}

    .scroll{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      max-height: 260px;
    }
    table{width:100%;border-collapse: collapse;min-width: 620px;}
    th,td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      text-align:left;
      white-space:nowrap;
      font-weight:900;
    }
    th{font-size:12px;color:var(--muted);letter-spacing:.2px}

    /* compact tables on mobile */
    @media (max-width: 560px){
      table{min-width: 520px}
      th,td{padding: 9px 10px}
    }

    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      z-index:200;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255,255,255,.10);
      display:none;
    }
    .bottomInner{
      max-width: 980px;margin:0 auto;
      display:grid;grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .bBtn{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      padding: 10px 8px;
      color:#fff;
      cursor:pointer;
      user-select:none;
      display:flex;flex-direction:column;align-items:center;gap:6px;
      font-weight:1100;
    }
    .bBtn.active{
      border-color: rgba(212,175,55,.38);
      background:
        radial-gradient(220px 90px at 30% 0%, rgba(212,175,55,.22), transparent 60%),
        rgba(0,0,0,.30);
      box-shadow: inset 0 0 0 1px rgba(212,175,55,.14);
    }
    .bBtn .i{font-size:18px;opacity:.95}
    .bBtn .t{font-size:12px;opacity:.95}
    @media (max-width: 720px){ .bottomBar{display:block} }

    .toast{
      position:fixed;left:50%;bottom:92px;transform:translateX(-50%);
      background: rgba(0,0,0,.80);
      border:1px solid rgba(212,175,55,.30);
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      z-index:9999;
      display:none;
      max-width: 92vw;
      box-shadow: 0 18px 60px rgba(0,0,0,.60);
    }
    .toast.show{display:block}
    .toast .t{font-weight:1100}

    /* Last5 + MyBet cards */
    .miniGrid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      padding:12px;
    }
    @media (max-width: 720px){
      .miniGrid{grid-template-columns: 1fr}
    }
    .miniCard{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .miniHead{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.30);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-weight:1100;
    }
    .miniBody{padding: 10px 12px}
    .miniTable{
      width:100%;
      border-collapse: collapse;
      min-width: 0 !important;
    }
    .miniTable th, .miniTable td{
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      font-weight:900;
      white-space:nowrap;
    }
    .miniSub{font-weight:900;color:var(--muted);font-size:12px}
    .statusTag{
      padding: 7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      font-weight:1100;
      white-space:nowrap;
    }
  </style>
</head>

<body>

  <header class="topBanner">
    <div class="bannerInner">
      <div class="brand">
        <img class="logo" src="../assets/image/jvbet-logo.png" alt="JVBET1803">
        <div class="brandTxt">
          <div class="t2">Premium Live Casino</div>
        </div>
      </div>

      <button class="logoutBtn" id="logoutBtn" type="button">
        <span class="ic">üîí</span> Logout
      </button>
    </div>

    <!-- ‚úÖ Role/Points/W/L -->
    <div class="statsBar">
      <div class="statPill">Role: <span class="gold" id="roleName">-</span></div>
      <div class="statPill">Points: <span class="gold" id="pointsShow">0</span></div>
      <div class="statPill">Win: <span class="gold" id="winShow">0</span></div>
      <div class="statPill">Loss: <span class="gold" id="lossShow">0</span></div>
    </div>

    <div class="tabsRow">
      <button class="tabBtn active" data-tab="dt" type="button"><span class="ico">üêâ</span> Dragon</button>
      <button class="tabBtn" data-tab="tp" type="button"><span class="ico">üÉè</span> Teen Patti</button>
      <button class="tabBtn" data-tab="rl" type="button"><span class="ico">üé°</span> Roulette</button>
      <button class="tabBtn" data-tab="hist" type="button"><span class="ico">üìú</span> History</button>
    </div>
  </header>

  <main class="wrap">

    <!-- ================= DRAGON TIGER ================= -->
    <section class="panel active" id="dt">

      <div class="sectionBar">
        <div class="title">üêâ Dragon Tiger</div>
        <div class="badgeLive">üé• Live <span class="gold" id="dtView">üëÅ 124</span></div>
      </div>

      <div class="card" style="padding:12px;">
        <div class="liveWrap">
          <div class="liveTopLeft"><span class="dot"></span> LIVE</div>

          <div class="lockedOverlay" id="dtOverlay">
            <div class="lockedCard">
              <div class="t">üîí Bets Locked</div>
              <div class="s">Play only when timer &gt; <span class="gold">15</span> sec</div>
              <div class="lockedRow">
                <div class="miniPill">Round: <span class="gold" id="dtOverlayRound">-</span></div>
                <div class="miniPill">Time left: <span class="gold" id="dtOverlayTimer">0</span>s</div>
              </div>
            </div>
          </div>

          <video class="video" autoplay loop muted playsinline>
            <source src="../assets/video/dealer_loop.mp4" type="video/mp4">
          </video>
        </div>

        <div class="timerLine">
          <div class="progressOuter">
            <div class="timerText">‚è≥ Round ends in: <span class="gold" id="dtTimer">30</span>s</div>
            <div class="progressBar"><div class="progressFill" id="dtFill"></div></div>
          </div>

          <div class="statusPill">Round: <span class="gold" id="dtRound">-</span></div>
          <div class="statusPill lockOpen" id="dtLock">OPEN</div>
        </div>

        <div class="betRow" id="dtBets">
          <div class="betBox active" data-pick="DRAGON"><div class="betName">Dragon</div><div class="betMul">2x</div></div>
          <div class="betBox" data-pick="TIGER"><div class="betName">Tiger</div><div class="betMul">2x</div></div>
          <div class="betBox" data-pick="TIE"><div class="betName">Tie</div><div class="betMul">Refund</div></div>
          <div class="betBox" data-pick="REFUND"><div class="betName">Refund</div><div class="betMul">‚Äî</div></div>
        </div>
      </div>

      <div class="tableCard">
        <div class="tableHead">
          <div class="h">üßæ Last 10 Bets (Dragon Tiger)</div>
          <div class="tableActions"><span class="muted" id="dtWait"></span></div>
        </div>

        <div class="stakeRow">
          <input class="stakeInput" id="dtStake" type="number" inputmode="numeric" placeholder="Enter Bet" />
          <button class="placeBtn" id="dtPlay" type="button">Place Bet</button>
        </div>

        <div class="scroll">
          <table class="table" id="dtPast">
            <thead><tr><th>Time</th><th>Pick</th><th>Points</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="chipBar" id="dtChips">
          <div class="chip goldChip" data-v="50">50</div>
          <div class="chip" data-v="100">100</div>
          <div class="chip" data-v="500">500</div>
          <div class="chip" data-v="1000">1000</div>
          <div class="chip" data-v="5000">5000</div>
        </div>

        <div class="stakeRow" style="justify-content:space-between; padding-top:0;">
          <div class="muted">Latest Result:</div>
          <div id="dtPrev" class="muted">No result</div>
        </div>

        <div class="stakeRow" style="padding-top:0;">
          <div class="muted" style="flex:1">Selected:</div>
          <div class="gold" id="dtPickShow">DRAGON</div>
        </div>

        <div class="stakeRow" style="padding-top:0;">
          <div class="muted" style="flex:1">Message:</div>
          <div class="gold" id="dtMsg">-</div>
        </div>

        <!-- ‚úÖ Last5 + MyBet (Old IDs preserved) -->
        <div class="miniGrid">
          <div class="miniCard">
            <div class="miniHead">
              <div>üìå Last 5 Results</div>
              <div class="miniSub" id="dtLast5Sub">-</div>
            </div>
            <div class="miniBody">
              <table class="miniTable">
                <thead><tr><th>Seq</th><th>Result</th></tr></thead>
                <tbody id="dtLast5Body"></tbody>
              </table>
            </div>
          </div>

          <div class="miniCard">
            <div class="miniHead">
              <div>üôã My Bet</div>
              <div class="statusTag" id="dtMyBetStatus">-</div>
            </div>
            <div class="miniBody">
              <div class="miniSub" id="dtMyBetSub">-</div>
              <table class="miniTable" style="margin-top:8px">
                <thead><tr><th>Pick</th><th>Points</th></tr></thead>
                <tbody id="dtMyBetBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ================= TEEN PATTI ================= -->
    <section class="panel" id="tp">
      <div class="sectionBar">
        <div class="title">üÉè Teen Patti</div>
        <div class="badgeLive">üé• Live <span class="gold" id="tpView">üëÅ 212</span></div>
      </div>

      <div class="card" style="padding:12px;">
        <div class="liveWrap">
          <div class="liveTopLeft"><span class="dot"></span> LIVE</div>

          <div class="lockedOverlay" id="tpOverlay">
            <div class="lockedCard">
              <div class="t">üîí Bets Locked</div>
              <div class="s">Play only when timer &gt; <span class="gold">15</span> sec</div>
              <div class="lockedRow">
                <div class="miniPill">Round: <span class="gold" id="tpOverlayRound">-</span></div>
                <div class="miniPill">Time left: <span class="gold" id="tpOverlayTimer">0</span>s</div>
              </div>
            </div>
          </div>

          <video class="video" autoplay loop muted playsinline>
            <source src="../assets/video/teen-patti.mp4" type="video/mp4">
          </video>
        </div>

        <div class="timerLine">
          <div class="progressOuter">
            <div class="timerText">‚è≥ Round ends in: <span class="gold" id="tpTimer">30</span>s</div>
            <div class="progressBar"><div class="progressFill" id="tpFill"></div></div>
          </div>
          <div class="statusPill">Round: <span class="gold" id="tpRound">-</span></div>
          <div class="statusPill lockOpen" id="tpLock">OPEN</div>
          <div class="statusPill">Selected: <span class="gold" id="tpPickShow">PLAYER</span></div>
        </div>

        <div class="betRow" id="tpBets" style="grid-template-columns: repeat(3, minmax(0,1fr));">
          <div class="betBox active" data-pick="PLAYER"><div class="betName">Player</div><div class="betMul">2x</div></div>
          <div class="betBox" data-pick="BANKER"><div class="betName">Banker</div><div class="betMul">2x</div></div>
          <div class="betBox" data-pick="TIE"><div class="betName">Tie</div><div class="betMul">Refund</div></div>
        </div>
      </div>

      <div class="tableCard">
        <div class="tableHead">
          <div class="h">üßæ Last 10 Bets (Teen Patti)</div>
          <div class="tableActions"><span class="muted" id="tpWait"></span></div>
        </div>

        <div class="stakeRow">
          <input class="stakeInput" id="tpStake" type="number" inputmode="numeric" placeholder="Enter points" />
          <button class="placeBtn" id="tpPlay" type="button">Place Bet</button>
        </div>

        <div class="scroll">
          <table class="table" id="tpPast">
            <thead><tr><th>Time</th><th>Pick</th><th>Points</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="chipBar" id="tpChips">
          <div class="chip goldChip" data-v="50">50</div>
          <div class="chip" data-v="100">100</div>
          <div class="chip" data-v="500">500</div>
          <div class="chip" data-v="1000">1000</div>
          <div class="chip" data-v="5000">5000</div>
        </div>

        <div class="stakeRow" style="justify-content:space-between; padding-top:0;">
          <div class="muted">Latest Result:</div>
          <div id="tpPrev" class="muted">No result</div>
        </div>

        <div class="stakeRow" style="padding-top:0;">
          <div class="muted" style="flex:1">Message:</div>
          <div class="gold" id="tpMsg">-</div>
        </div>

        <div style="display:none">
          <span id="tpPickShow2">PLAYER</span>
          <span id="tpRound2">-</span>
        </div>

        <!-- ‚úÖ Last5 + MyBet (Old IDs preserved) -->
        <div class="miniGrid">
          <div class="miniCard">
            <div class="miniHead">
              <div>üìå Last 5 Results</div>
              <div class="miniSub" id="tpLast5Sub">-</div>
            </div>
            <div class="miniBody">
              <table class="miniTable">
                <thead><tr><th>Seq</th><th>Result</th></tr></thead>
                <tbody id="tpLast5Body"></tbody>
              </table>
            </div>
          </div>

          <div class="miniCard">
            <div class="miniHead">
              <div>üôã My Bet</div>
              <div class="statusTag" id="tpMyBetStatus">-</div>
            </div>
            <div class="miniBody">
              <div class="miniSub" id="tpMyBetSub">-</div>
              <table class="miniTable" style="margin-top:8px">
                <thead><tr><th>Pick</th><th>Points</th></tr></thead>
                <tbody id="tpMyBetBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ================= ROULETTE ================= -->
    <section class="panel" id="rl">
      <div class="sectionBar">
        <div class="title">üé° Roulette</div>
        <div class="badgeLive">üé• Live <span class="gold" id="rView">üëÅ 156</span></div>
      </div>

      <div class="card" style="padding:12px;">
        <div class="liveWrap">
          <div class="liveTopLeft"><span class="dot"></span> LIVE</div>

          <div class="lockedOverlay" id="rOverlay">
            <div class="lockedCard">
              <div class="t">üîí Bets Locked</div>
              <div class="s">Play only when timer &gt; <span class="gold">15</span> sec</div>
              <div class="lockedRow">
                <div class="miniPill">Round: <span class="gold" id="rOverlayRound">-</span></div>
                <div class="miniPill">Time left: <span class="gold" id="rOverlayTimer">0</span>s</div>
              </div>
            </div>
          </div>

          <video class="video" autoplay loop muted playsinline>
            <source src="../assets/video/Roulette_.mp4" type="video/mp4">
          </video>
        </div>

        <div class="timerLine">
          <div class="progressOuter">
            <div class="timerText">‚è≥ Round ends in: <span class="gold" id="rTimer">30</span>s</div>
            <div class="progressBar"><div class="progressFill" id="rFill"></div></div>
          </div>
          <div class="statusPill">Round: <span class="gold" id="rRound">-</span></div>
          <div class="statusPill lockOpen" id="rLock">OPEN</div>
          <div class="statusPill">Selected: <span class="gold" id="rPickShow">RED</span></div>
        </div>

        <div class="betRow" id="rBets" style="grid-template-columns: repeat(2, minmax(0,1fr));">
          <div class="betBox active" data-pick="RED"><div class="betName">Red</div><div class="betMul">2x</div></div>
          <div class="betBox" data-pick="BLACK"><div class="betName">Black</div><div class="betMul">2x</div></div>
        </div>
      </div>

      <div class="tableCard">
        <div class="tableHead">
          <div class="h">üßæ Last 10 Bets (Roulette)</div>
          <div class="tableActions"><span class="muted" id="rWait"></span></div>
        </div>

        <div class="stakeRow">
          <input class="stakeInput" id="rStake" type="number" inputmode="numeric" placeholder="Enter points" />
          <button class="placeBtn" id="rPlay" type="button">Place Bet</button>
        </div>

        <div class="scroll">
          <table class="table" id="rPast">
            <thead><tr><th>Time</th><th>Pick</th><th>Points</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="chipBar" id="rChips">
          <div class="chip goldChip" data-v="50">50</div>
          <div class="chip" data-v="100">100</div>
          <div class="chip" data-v="500">500</div>
          <div class="chip" data-v="1000">1000</div>
          <div class="chip" data-v="5000">5000</div>
        </div>

        <div class="stakeRow" style="justify-content:space-between; padding-top:0;">
          <div class="muted">Latest Result:</div>
          <div id="rPrev" class="muted">No result</div>
        </div>

        <div class="stakeRow" style="padding-top:0;">
          <div class="muted" style="flex:1">Message:</div>
          <div class="gold" id="rMsg">-</div>
        </div>

        <!-- ‚úÖ Last5 + MyBet (Old IDs preserved) -->
        <div class="miniGrid">
          <div class="miniCard">
            <div class="miniHead">
              <div>üìå Last 5 Results</div>
              <div class="miniSub" id="rLast5Sub">-</div>
            </div>
            <div class="miniBody">
              <table class="miniTable">
                <thead><tr><th>Seq</th><th>Result</th></tr></thead>
                <tbody id="rLast5Body"></tbody>
              </table>
            </div>
          </div>

          <div class="miniCard">
            <div class="miniHead">
              <div>üôã My Bet</div>
              <div class="statusTag" id="rMyBetStatus">-</div>
            </div>
            <div class="miniBody">
              <div class="miniSub" id="rMyBetSub">-</div>
              <table class="miniTable" style="margin-top:8px">
                <thead><tr><th>Pick</th><th>Points</th></tr></thead>
                <tbody id="rMyBetBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ================= HISTORY ================= -->
    <section class="panel" id="hist">
      <div class="sectionBar">
        <div class="title">üìú History</div>
        <div class="badgeLive">All Bets</div>
      </div>

      <div class="tableCard" style="margin-top:12px;">
        <div class="tableHead">
          <div class="h">üìú Full Play History</div>
        </div>
        <div class="scroll" style="max-height:420px">
          <table class="table" id="bh">
            <thead>
              <tr><th>Time</th><th>Game</th><th>Pick</th><th>Points</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ‚úÖ OLD COMPAT IDs (keep for your older code compatibility too) -->
    <div style="display:none">
      <span id="cid">-</span>
      <span id="pts">0</span>
      <span id="w">0</span>
      <span id="l">0</span>
    </div>

  </main>

  <nav class="bottomBar" aria-label="Bottom navigation">
    <div class="bottomInner">
      <button class="bBtn active" data-tab="dt" type="button"><div class="i">üêâ</div><div class="t">Dragon</div></button>
      <button class="bBtn" data-tab="tp" type="button"><div class="i">üÉè</div><div class="t">Teen Patti</div></button>
      <button class="bBtn" data-tab="rl" type="button"><div class="i">üé°</div><div class="t">Roulette</div></button>
      <button class="bBtn" data-tab="hist" type="button"><div class="i">üìú</div><div class="t">History</div></button>
    </div>
  </nav>

  <div class="toast" id="toast">
    <div class="t" id="toastTitle">-</div>
    <div class="muted" id="toastBody">-</div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

  <script>
    /* ========= TAB SYNC (top + bottom) ========= */
    function setTab(tabId){
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
      document.querySelectorAll(".bBtn").forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
      document.querySelectorAll(".panel").forEach(p => p.classList.toggle("active", p.id === tabId));
      if (tabId === "hist") renderHistory();
      try{ window.scrollTo({top:0, behavior:"smooth"}); }catch(e){}
    }
    document.querySelectorAll(".tabBtn").forEach(b => b.addEventListener("click", ()=> setTab(b.dataset.tab)));
    document.querySelectorAll(".bBtn").forEach(b => b.addEventListener("click", ()=> setTab(b.dataset.tab)));

    function showToast(title, body) {
      const t = document.getElementById("toast");
      if (!t) return;
      t.className = "toast show";
      document.getElementById("toastTitle").textContent = title || "";
      document.getElementById("toastBody").textContent = body || "";
      setTimeout(() => t.className = "toast", 2200);
    }
    function vib(ms) { try { if (navigator.vibrate) navigator.vibrate(ms); } catch (e) {} }

    /* ================= FIREBASE INIT ================= */
    firebase.initializeApp({
      apiKey: "AIzaSyCAFH5_1RjVHyZLwkj26zQPCq0-8S0fSKA",
      authDomain: "jvbet-bbf90.firebaseapp.com",
      projectId: "jvbet-bbf90",
      storageBucket: "jvbet-bbf90.appspot.com",
      messagingSenderId: "824871692224",
      appId: "1:824871692224:web:f74baa642b1f43b78aca25"
    });
    const db = firebase.firestore();

    /* ================= SESSION + STORAGE ================= */
    const K_SESSION_A = "jvbet_session";
    const K_SESSION_B = "jvbet_session_v1";
    function loadJSON(k, f) { try { const r = localStorage.getItem(k); return r ? JSON.parse(r) : f; } catch (e) { return f; } }
    function getSession() { return loadJSON(K_SESSION_A, null) || loadJSON(K_SESSION_B, null); }
    function clearSession() { localStorage.removeItem(K_SESSION_A); localStorage.removeItem(K_SESSION_B); }
    function logout() { clearSession(); location.href = "../index.html"; }
    document.getElementById("logoutBtn").addEventListener("click", logout);
    function fmtDate(ts) { return new Date(ts || Date.now()).toLocaleString(); }

    /* ================= BET BOXES + CHIPS ================= */
    function bindBetBoxes(containerId, showId, showId2) {
      const cont = document.getElementById(containerId);
      const show = document.getElementById(showId);
      const show2 = showId2 ? document.getElementById(showId2) : null;
      if (!cont || !show) return () => "";

      let active = cont.querySelector(".betBox.active");
      let pick = (active && active.dataset && active.dataset.pick) ? active.dataset.pick : "";
      show.textContent = pick;
      if (show2) show2.textContent = pick;

      cont.querySelectorAll(".betBox").forEach(box => {
        box.addEventListener("click", () => {
          cont.querySelectorAll(".betBox").forEach(b => b.classList.remove("active"));
          box.classList.add("active");
          pick = box.dataset.pick || "";
          show.textContent = pick;
          if (show2) show2.textContent = pick;
        });
      });
      return () => pick;
    }

    function bindChips(scopeEl, inputEl) {
      if (!scopeEl || !inputEl) return;
      scopeEl.querySelectorAll(".chip").forEach(ch => {
        if (ch.dataset.bound === "1") return;
        ch.dataset.bound = "1";
        ch.addEventListener("click", () => {
          const v = Number(ch.dataset.v || 0);
          inputEl.value = Number(inputEl.value || 0) + v;
        });
      });
    }

    const getDTPick = bindBetBoxes("dtBets", "dtPickShow");
    const dtStake = document.getElementById("dtStake");
    bindChips(document.getElementById("dtChips"), dtStake);

    const getTPPick = bindBetBoxes("tpBets", "tpPickShow", "tpPickShow2");
    const tpStake = document.getElementById("tpStake");
    bindChips(document.getElementById("tpChips"), tpStake);

    const getRPick = bindBetBoxes("rBets", "rPickShow");
    const rStake = document.getElementById("rStake");
    bindChips(document.getElementById("rChips"), rStake);

    /* ================= CONSTANTS ================= */
    const TOTAL_SEC = 30;
    const LOCK_REMAINING = 15;

    // ‚úÖ separate seq for each game
    const START_SEQ = { DragonTiger: 282, TeenPatti: 500, Roulette: 900 };

    const GAME_DOC = (g) => db.collection("gameState").doc(g);
    const USERS = db.collection("users");
    const BETS = db.collection("bets");

    /* ================= STATE ================= */
    let ME_ID = null;
    let ME_USER = null;
    const state = { DragonTiger: null, TeenPatti: null, Roulette: null };

    /* ================= ROUND ID (YYYYMMDDHHMMSS_SEQ) ================= */
    function pad2(n) { return String(n).padStart(2, "0"); }
    function pad3(n) { return String(n).padStart(3, "0"); }
    function ymdhms(d) {
      return d.getFullYear()
        + pad2(d.getMonth() + 1)
        + pad2(d.getDate())
        + pad2(d.getHours())
        + pad2(d.getMinutes())
        + pad2(d.getSeconds());
    }
    function makeRoundIdFromSeq(seq) {
      return ymdhms(new Date()) + "_" + pad3(Number(seq || 0));
    }

    /* ================= UI HELPERS ================= */
    function setLock(el, stateStr) {
      if (!el) return;
      el.classList.remove("lockOpen", "lockPlaced", "lockLocked", "lockClosed");
      if (stateStr === "OPEN") { el.classList.add("lockOpen"); el.textContent = "OPEN"; }
      else if (stateStr === "PLACED") { el.classList.add("lockPlaced"); el.textContent = "PLAYED"; }
      else if (stateStr === "LOCKED") { el.classList.add("lockLocked"); el.textContent = "LOCKED"; }
      else { el.classList.add("lockClosed"); el.textContent = "CLOSED"; }
    }

    function setLockedOverlay(gameKey, show, roundId, left){
      const map = {
        DragonTiger: { box:"dtOverlay", rid:"dtOverlayRound", t:"dtOverlayTimer" },
        TeenPatti:   { box:"tpOverlay", rid:"tpOverlayRound", t:"tpOverlayTimer" },
        Roulette:    { box:"rOverlay",  rid:"rOverlayRound",  t:"rOverlayTimer"  }
      };
      const m = map[gameKey];
      if(!m) return;
      const box = document.getElementById(m.box);
      const rid = document.getElementById(m.rid);
      const tt  = document.getElementById(m.t);
      if(rid) rid.textContent = roundId || "-";
      if(tt) tt.textContent = String(Math.max(0, Number(left || 0)));
      if(box) box.classList.toggle("show", !!show);
    }

    /* ================= USER DEFAULTS + TOP STATS ================= */
    async function ensureUserDefaults() {
      const ref = USERS.doc(ME_ID);
      const doc = await ref.get();
      if (!doc.exists) throw new Error("User not found");
      const data = doc.data() || {};
      const patch = {};
      if (typeof data.points !== "number") patch.points = 0;
      if (typeof data.isBlocked !== "boolean") patch.isBlocked = false;
      if (!data.clientId) patch.clientId = ME_ID;
      if (!data.role) patch.role = data.isAdmin ? "admin" : "user";
      if (Object.keys(patch).length) await ref.set(patch, { merge: true });
    }

    async function calcWinLoss() {
      const qs = await BETS.where("clientId", "==", ME_ID).orderBy("at", "desc").limit(200).get();
      let w = 0, l = 0;
      qs.forEach(doc => {
        const b = doc.data() || {};
        if (b.result === "WIN") w++;
        else if (b.result === "LOSS") l++;
      });
      return { win: w, loss: l };
    }

    async function refreshTop() {
      const snap = await USERS.doc(ME_ID).get();
      if (!snap.exists) return logout();
      ME_USER = snap.data() || {};

      // old hidden compat
      document.getElementById("cid").textContent = ME_ID;
      document.getElementById("pts").textContent = Number(ME_USER.points || 0);

      // visible
      document.getElementById("roleName").textContent = String(ME_USER.role || ME_USER.isAdmin ? "admin" : "user");
      document.getElementById("pointsShow").textContent = String(Number(ME_USER.points || 0));

      const wl = await calcWinLoss();
      document.getElementById("w").textContent = wl.win;
      document.getElementById("l").textContent = wl.loss;

      document.getElementById("winShow").textContent = String(wl.win);
      document.getElementById("lossShow").textContent = String(wl.loss);
    }

    /* ================= RNG ================= */
    function randCard() { return 1 + Math.floor(Math.random() * 13); }
    function cardStr(v) { return (v === 1 ? "A" : v === 11 ? "J" : v === 12 ? "Q" : v === 13 ? "K" : String(v)); }

    function drawDT() {
      const d = randCard(), t = randCard();
      const res = (d === t) ? "TIE" : (d > t ? "DRAGON" : "TIGER");
      return { d, t, res };
    }
    function drawTP() { return { res: ["PLAYER", "BANKER", "TIE"][Math.floor(Math.random() * 3)] }; }
    function drawR() {
      const n = Math.floor(Math.random() * 37);
      const c = (n === 0) ? "GREEN" : (n % 2 === 0 ? "BLACK" : "RED");
      return { n, color: c, res: (c + " " + n) };
    }

    /* ================= gameState INIT / PATCH (old or fresh) ================= */
    async function ensureGameDocExists(game) {
      const ref = GAME_DOC(game);
      const snap = await ref.get();
      const now = Date.now();

      if (!snap.exists) {
        const seq = START_SEQ[game];
        const startedAt = now;
        await ref.set({
          seq,
          roundId: makeRoundIdFromSeq(seq),
          startedAt,
          endsAt: startedAt + TOTAL_SEC * 1000,
          lockAt: startedAt + LOCK_REMAINING * 1000,
          status: "OPEN",
          result: null,
          payload: null,
          last5: [],
          nextStarted: false
        }, { merge: true });
        return;
      }

      const g = snap.data() || {};
      const patch = {};
      if (typeof g.seq !== "number") patch.seq = START_SEQ[game];
      if (!g.roundId) patch.roundId = makeRoundIdFromSeq((typeof g.seq === "number") ? g.seq : START_SEQ[game]);
      if (typeof g.startedAt !== "number") patch.startedAt = now;
      if (typeof g.endsAt !== "number") patch.endsAt = now + TOTAL_SEC * 1000;
      if (typeof g.lockAt !== "number") patch.lockAt = now + LOCK_REMAINING * 1000;
      if (typeof g.nextStarted !== "boolean") patch.nextStarted = false;
      if (!Array.isArray(g.last5)) patch.last5 = [];

      if (Object.keys(patch).length) await ref.set(patch, { merge: true });
    }

    function secondsLeftFromDoc(doc) {
      const endsAt = Number(doc?.endsAt || 0);
      return Math.ceil((endsAt - Date.now()) / 1000);
    }
    function statusFromDoc(doc) {
      const left = secondsLeftFromDoc(doc);
      if (left <= 0) return "CLOSED";
      if (left <= LOCK_REMAINING) return "LOCKED";
      return "OPEN";
    }

    /* ================= FINALIZE + NEXT ROUND ================= */
    async function finalizeIfNeeded(game) {
      const ref = GAME_DOC(game);

      return db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists) return;

        const g = snap.data() || {};
        const left = Math.ceil((Number(g.endsAt || 0) - Date.now()) / 1000);
        if (left > 0) return;

        const currentSeq = (typeof g.seq === "number") ? g.seq : START_SEQ[game];

        if (!g.result) {
          let result = null;
          let payload = null;

          if (game === "DragonTiger") {
            const d = drawDT();
            result = d.res;
            payload = { d: cardStr(d.d), t: cardStr(d.t), res: d.res };
          } else if (game === "TeenPatti") {
            const d = drawTP();
            result = d.res;
            payload = { res: d.res };
          } else {
            const d = drawR();
            result = d.res;
            payload = { color: d.color, n: d.n, res: d.res };
          }

          const now = Date.now();
          const entry = { roundId: g.roundId, seq: currentSeq, result, time: now };
          const old = Array.isArray(g.last5) ? g.last5 : [];
          const cleaned = old.filter(x => x && x.roundId !== g.roundId);
          cleaned.unshift(entry);
          const last5 = cleaned.slice(0, 5);

          tx.set(ref, {
            status: "CLOSED",
            result,
            payload,
            last5,
            resultAt: now,
            nextStarted: false
          }, { merge: true });

          return;
        }

        if (g.result && !g.nextStarted) {
          const now = Date.now();
          const nextSeq = currentSeq + 1;

          tx.set(ref, {
            seq: nextSeq,
            roundId: makeRoundIdFromSeq(nextSeq),
            startedAt: now,
            endsAt: now + TOTAL_SEC * 1000,
            lockAt: now + LOCK_REMAINING * 1000,
            status: "OPEN",
            result: null,
            payload: null,
            nextStarted: true
          }, { merge: true });
        }
      });
    }

    /* ================= BETS ================= */
    async function placeBetFS({ game, pick, stake, roundId, seq }) {
      stake = Number(stake || 0);
      if (!stake || stake <= 0) throw new Error("Enter valid points");
      if (Number(ME_USER?.points || 0) < stake) throw new Error("Not enough points");

      const betKey = ME_ID + "_" + game + "_" + roundId;
      const ref = BETS.doc(betKey);

      await db.runTransaction(async (tx) => {
        const bSnap = await tx.get(ref);
        if (bSnap.exists) throw new Error("Already played");

        tx.set(USERS.doc(ME_ID), {
          points: firebase.firestore.FieldValue.increment(-stake)
        }, { merge: true });

        tx.set(ref, {
          betId: betKey,
          clientId: ME_ID,
          game,
          pick,
          stake,
          roundId,
          seq,
          at: Date.now(),
          result: "PENDING",
          settled: false
        }, { merge: true });
      });
    }

    async function settleMyBetIfNeeded(game, gameDoc) {
      if (!gameDoc?.result) return;

      const betKey = ME_ID + "_" + game + "_" + gameDoc.roundId;
      const ref = BETS.doc(betKey);

      await db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists) return;
        const b = snap.data() || {};
        if (b.settled) return;

        let out = "LOSS";

        if (game === "Roulette") {
          const color = String(gameDoc.payload?.color || "").toUpperCase();
          out = (String(b.pick).toUpperCase() === color) ? "WIN" : "LOSS";
        } else {
          if (String(gameDoc.result) === "TIE") out = "TIE";
          else out = (String(b.pick) === String(gameDoc.result)) ? "WIN" : "LOSS";
        }

        if (out === "WIN") {
          tx.set(USERS.doc(ME_ID), {
            points: firebase.firestore.FieldValue.increment(Number(b.stake || 0) * 2)
          }, { merge: true });
        } else if (out === "TIE") {
          tx.set(USERS.doc(ME_ID), {
            points: firebase.firestore.FieldValue.increment(Number(b.stake || 0))
          }, { merge: true });
        }

        tx.set(ref, {
          result: out,
          settled: true,
          settledAt: Date.now(),
          roundResult: gameDoc.result
        }, { merge: true });
      });

      await refreshTop();
    }

    /* ================= TABLES ================= */
    async function setPastTable(game, tableId, waitId) {
      const tb = document.querySelector("#" + tableId + " tbody");
      const w = document.getElementById(waitId);

      const qs = await BETS.where("clientId", "==", ME_ID)
        .where("game", "==", game)
        .orderBy("at", "desc").limit(10).get();

      const arr = [];
      qs.forEach(d => arr.push(d.data() || {}));
      const pending = arr.filter(b => b.result === "PENDING").length;
      if (w) w.textContent = pending ? ("Pending bets: " + pending) : "";

      if (!tb) return;
      tb.innerHTML = arr.map(b => (
        "<tr>" +
          "<td>" + fmtDate(b.at) + "</td>" +
          "<td>" + (b.pick || "-") + "</td>" +
          "<td class='gold'>" + Number(b.stake || 0) + "</td>" +
          "<td>" + (b.result || "-") + "</td>" +
        "</tr>"
      )).join("") || "<tr><td colspan='4' class='muted'>No bets yet</td></tr>";
    }

    async function renderHistory() {
      const tb = document.querySelector("#bh tbody");
      const qs = await BETS.where("clientId", "==", ME_ID).orderBy("at", "desc").limit(200).get();
      const arr = [];
      qs.forEach(d => arr.push(d.data() || {}));
      if (!tb) return;
      tb.innerHTML = arr.map(b => (
        "<tr>" +
          "<td>" + fmtDate(b.at) + "</td>" +
          "<td>" + (b.game || "-") + "</td>" +
          "<td>" + (b.pick || "-") + "</td>" +
          "<td class='gold'>" + Number(b.stake || 0) + "</td>" +
          "<td>" + (b.result || "-") + "</td>" +
        "</tr>"
      )).join("") || "<tr><td colspan='5' class='muted'>No history</td></tr>";
    }

    function renderLatestResult(game, gameDoc) {
      const elId = (game === "DragonTiger") ? "dtPrev" : (game === "TeenPatti") ? "tpPrev" : "rPrev";
      const el = document.getElementById(elId);
      if (!el) return;
      const v = String(gameDoc?.result || "");
      el.innerHTML = v ? ('<span class="gold">' + v + '</span>') : '<span class="muted">No result</span>';
    }

    /* ================= LAST5 RENDER (uses old IDs) ================= */
    function renderLast5(game, gdoc) {
      const arr = Array.isArray(gdoc?.last5) ? gdoc.last5 : [];
      const rows = arr.slice(0,5);

      let subId = "dtLast5Sub", bodyId = "dtLast5Body";
      if (game === "TeenPatti") { subId = "tpLast5Sub"; bodyId = "tpLast5Body"; }
      if (game === "Roulette") { subId = "rLast5Sub";  bodyId = "rLast5Body"; }

      const sub = document.getElementById(subId);
      const body = document.getElementById(bodyId);
      if (sub) sub.textContent = rows.length ? ("Rounds: " + rows.length) : "No data";
      if (!body) return;

      body.innerHTML = rows.map(x => (
        "<tr>" +
          "<td class='gold'>" + (typeof x.seq === "number" ? x.seq : "-") + "</td>" +
          "<td>" + (x.result || "-") + "</td>" +
        "</tr>"
      )).join("") || "<tr><td colspan='2' class='muted'>No results yet</td></tr>";
    }

    /* ================= MY BET LIVE (without refresh) ================= */
    const myBetUnsub = { DragonTiger:null, TeenPatti:null, Roulette:null };

    function setMyBetUI(game, bet, roundId){
      let subId="dtMyBetSub", stId="dtMyBetStatus", bodyId="dtMyBetBody";
      if (game === "TeenPatti") { subId="tpMyBetSub"; stId="tpMyBetStatus"; bodyId="tpMyBetBody"; }
      if (game === "Roulette")  { subId="rMyBetSub";  stId="rMyBetStatus";  bodyId="rMyBetBody";  }

      const sub = document.getElementById(subId);
      const st  = document.getElementById(stId);
      const bd  = document.getElementById(bodyId);

      if (!bet) {
        if (sub) sub.textContent = "Round: " + (roundId || "-");
        if (st) st.textContent = "NO BET";
        if (bd) bd.innerHTML = "<tr><td colspan='2' class='muted'>Not played</td></tr>";
        return;
      }

      if (sub) sub.textContent = "Round: " + (bet.roundId || roundId || "-");
      if (st) st.textContent = (bet.result || "PENDING");
      if (bd) bd.innerHTML =
        "<tr><td>" + (bet.pick || "-") + "</td><td class='gold'>" + Number(bet.stake || 0) + "</td></tr>";
    }

    function watchMyBet(game, roundId){
      // clear old
      if (myBetUnsub[game]) { try{ myBetUnsub[game](); }catch(e){} myBetUnsub[game]=null; }

      const betKey = ME_ID + "_" + game + "_" + roundId;
      const ref = BETS.doc(betKey);

      myBetUnsub[game] = ref.onSnapshot((snap)=>{
        if (!snap.exists) {
          setMyBetUI(game, null, roundId);
          return;
        }
        setMyBetUI(game, snap.data() || null, roundId);
      });
    }

    /* ================= UI TIMER UPDATE ================= */
    function updateTimerUI(game, gameDoc) {
      const left = secondsLeftFromDoc(gameDoc);
      const showLeft = Math.max(0, left);
      const pct = Math.max(0, Math.min(100, (showLeft / TOTAL_SEC) * 100)) + "%";
      const lockState = statusFromDoc(gameDoc);

      if (game === "DragonTiger") {
        document.getElementById("dtRound").textContent = gameDoc?.roundId ?? "-";
        document.getElementById("dtTimer").textContent = showLeft;
        document.getElementById("dtFill").style.width = pct;

        setLock(document.getElementById("dtLock"), lockState);
        document.getElementById("dtPlay").disabled = (lockState !== "OPEN");
        setLockedOverlay("DragonTiger", lockState === "LOCKED", gameDoc?.roundId, showLeft);

      } else if (game === "TeenPatti") {
        document.getElementById("tpRound").textContent = gameDoc?.roundId ?? "-";
        document.getElementById("tpRound2").textContent = gameDoc?.roundId ?? "-";
        document.getElementById("tpTimer").textContent = showLeft;
        document.getElementById("tpFill").style.width = pct;

        setLock(document.getElementById("tpLock"), lockState);
        document.getElementById("tpPlay").disabled = (lockState !== "OPEN");
        setLockedOverlay("TeenPatti", lockState === "LOCKED", gameDoc?.roundId, showLeft);

      } else {
        document.getElementById("rRound").textContent = gameDoc?.roundId ?? "-";
        document.getElementById("rTimer").textContent = showLeft;
        document.getElementById("rFill").style.width = pct;

        setLock(document.getElementById("rLock"), lockState);
        document.getElementById("rPlay").disabled = (lockState !== "OPEN");
        setLockedOverlay("Roulette", lockState === "LOCKED", gameDoc?.roundId, showLeft);
      }
    }

    /* ================= LIVE SUBSCRIBE ================= */
    function subscribeGame(game) {
      const ref = GAME_DOC(game);
      return ref.onSnapshot(async (snap) => {
        if (!snap.exists) return;
        const g = snap.data() || {};
        state[game] = g;

        updateTimerUI(game, g);
        renderLatestResult(game, g);
        renderLast5(game, g);

        // My bet live watch per-round (without refresh)
        if (ME_ID && g.roundId) watchMyBet(game, g.roundId);

        if (g.result) {
          await settleMyBetIfNeeded(game, g);
          if (game === "DragonTiger") document.getElementById("dtMsg").textContent = "ROUND RESULT: " + g.result;
          if (game === "TeenPatti")  document.getElementById("tpMsg").textContent = "ROUND RESULT: " + g.result;
          if (game === "Roulette")   document.getElementById("rMsg").textContent = "ROUND RESULT: " + g.result;
        }

        if (secondsLeftFromDoc(g) <= 0) await finalizeIfNeeded(game);

        if (game === "DragonTiger") await setPastTable("DragonTiger", "dtPast", "dtWait");
        if (game === "TeenPatti")  await setPastTable("TeenPatti",  "tpPast", "tpWait");
        if (game === "Roulette")   await setPastTable("Roulette",   "rPast",  "rWait");
      });
    }

    /* ================= PLAY BUTTONS ================= */
    document.getElementById("dtPlay").addEventListener("click", async () => {
      try {
        const g = state.DragonTiger;
        if (!g) return;
        const left = secondsLeftFromDoc(g);
        if (left <= LOCK_REMAINING) return document.getElementById("dtMsg").textContent = "Locked (play only when timer > 15)";
        await placeBetFS({ game:"DragonTiger", pick:getDTPick(), stake:dtStake.value, roundId:g.roundId, seq:g.seq });
        document.getElementById("dtMsg").textContent = "PLAY SUBMITTED";
        showToast("üïí SUBMITTED", "Result at 0 sec");
        vib(40);
        await refreshTop();
      } catch (e) { document.getElementById("dtMsg").textContent = e.message || String(e); }
    });

    document.getElementById("tpPlay").addEventListener("click", async () => {
      try {
        const g = state.TeenPatti;
        if (!g) return;
        const left = secondsLeftFromDoc(g);
        if (left <= LOCK_REMAINING) return document.getElementById("tpMsg").textContent = "Locked (play only when timer > 15)";
        await placeBetFS({ game:"TeenPatti", pick:getTPPick(), stake:tpStake.value, roundId:g.roundId, seq:g.seq });
        document.getElementById("tpMsg").textContent = "PLAY SUBMITTED";
        vib(40);
        await refreshTop();
      } catch (e) { document.getElementById("tpMsg").textContent = e.message || String(e); }
    });

    document.getElementById("rPlay").addEventListener("click", async () => {
      try {
        const g = state.Roulette;
        if (!g) return;
        const left = secondsLeftFromDoc(g);
        if (left <= LOCK_REMAINING) return document.getElementById("rMsg").textContent = "Locked (play only when timer > 15)";
        await placeBetFS({ game:"Roulette", pick:getRPick(), stake:rStake.value, roundId:g.roundId, seq:g.seq });
        document.getElementById("rMsg").textContent = "PLAY SUBMITTED";
        vib(40);
        await refreshTop();
      } catch (e) { document.getElementById("rMsg").textContent = e.message || String(e); }
    });

    /* ================= VIEWERS (FAKE) ================= */
    setInterval(() => {
      const el = id => document.getElementById(id);
      if (el("dtView")) el("dtView").textContent = "üëÅ " + (120 + Math.floor(Math.random() * 25));
      if (el("tpView")) el("tpView").textContent = "üëÅ " + (200 + Math.floor(Math.random() * 25));
      if (el("rView"))  el("rView").textContent  = "üëÅ " + (150 + Math.floor(Math.random() * 25));
    }, 2500);

    /* ================= INIT ================= */
    (async function init() {
      const s = getSession();
      if (!s || !s.id) return logout();
      ME_ID = s.id;

      await ensureUserDefaults();

      const snap = await USERS.doc(ME_ID).get();
      if (!snap.exists) return logout();
      if (snap.data()?.isBlocked) return logout();

      await refreshTop();

      // keep top live updates too
      USERS.doc(ME_ID).onSnapshot(()=> refreshTop());

      await ensureGameDocExists("DragonTiger");
      await ensureGameDocExists("TeenPatti");
      await ensureGameDocExists("Roulette");

      subscribeGame("DragonTiger");
      subscribeGame("TeenPatti");
      subscribeGame("Roulette");

      setInterval(async () => {
        await finalizeIfNeeded("DragonTiger");
        await finalizeIfNeeded("TeenPatti");
        await finalizeIfNeeded("Roulette");
      }, 1000);

      setInterval(() => {
        if (state.DragonTiger) updateTimerUI("DragonTiger", state.DragonTiger);
        if (state.TeenPatti)  updateTimerUI("TeenPatti",  state.TeenPatti);
        if (state.Roulette)   updateTimerUI("Roulette",   state.Roulette);
      }, 200);

    })().catch((e) => {
      console.error("INIT ERROR:", e);
      alert(e?.message || e);
    });
  </script>
</body>
</html>
