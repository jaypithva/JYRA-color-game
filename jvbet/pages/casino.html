<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Casino - JVBET1803</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="../assets/image/jvbet-logo.png">

<link rel="stylesheet" href="../assets/css/style.css">

<style>
/* =================== SAME DESIGN (UNCHANGED) =================== */
body{margin:0;background:#0b0b0f;color:#fff;font-family:system-ui}
.header{position:sticky;top:0;background:rgba(0,0,0,.4);backdrop-filter:blur(10px)}
.logo{height:42px}
.tabs{display:flex;gap:8px;padding:12px}
.tabbtn{padding:10px 14px;border-radius:20px;background:#111;color:#fff;border:1px solid #333;cursor:pointer}
.tabbtn.active{background:rgba(212,175,55,.2);border-color:gold}
.panel{display:none}
.panel.active{display:block}
.gold{color:gold}
.card{margin:12px;border-radius:16px;padding:14px;background:#111;border:1px solid #333}
.timer{display:flex;gap:10px;align-items:center}
.badge{padding:6px 10px;border-radius:14px;border:1px solid #444}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #333;text-align:left}
</style>
</head>

<body>

<header class="header">
  <div style="padding:10px;text-align:center">
    <img src="../assets/image/jvbet-logo.png" class="logo">
  </div>
</header>

<div class="tabs">
  <button class="tabbtn active" data-tab="dt">Dragon Tiger</button>
  <button class="tabbtn" data-tab="tp">Teen Patti</button>
  <button class="tabbtn" data-tab="rl">Roulette</button>
</div>

<!-- ================= DRAGON TIGER ================= -->
<section class="panel active" id="dt">
  <div class="card">
    <div class="timer">
      ⏳ <span id="dtTimer">30</span>s
      <span class="badge">Round: <span class="gold" id="dtRound">-</span></span>
    </div>

    <h3>Last 5 Results</h3>
    <table>
      <thead><tr><th>#</th><th>Result</th><th>Round</th><th>Time</th></tr></thead>
      <tbody id="dtLast5"><tr><td colspan="4">Loading…</td></tr></tbody>
    </table>
  </div>
</section>

<!-- ================= TEEN PATTI ================= -->
<section class="panel" id="tp">
  <div class="card">
    <div class="timer">
      ⏳ <span id="tpTimer">30</span>s
      <span class="badge">Round: <span class="gold" id="tpRound">-</span></span>
    </div>

    <h3>Last 5 Results</h3>
    <table>
      <thead><tr><th>#</th><th>Result</th><th>Round</th><th>Time</th></tr></thead>
      <tbody id="tpLast5"><tr><td colspan="4">Loading…</td></tr></tbody>
    </table>
  </div>
</section>

<!-- ================= ROULETTE ================= -->
<section class="panel" id="rl">
  <div class="card">
    <div class="timer">
      ⏳ <span id="rTimer">30</span>s
      <span class="badge">Round: <span class="gold" id="rRound">-</span></span>
    </div>

    <h3>Last 5 Results</h3>
    <table>
      <thead><tr><th>#</th><th>Result</th><th>Round</th><th>Time</th></tr></thead>
      <tbody id="rLast5"><tr><td colspan="4">Loading…</td></tr></tbody>
    </table>
  </div>
</section>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE INIT ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCAFH5_1RjVHyZLwkj26zQPCq0-8S0fSKA",
  authDomain: "jvbet-bbf90.firebaseapp.com",
  projectId: "jvbet-bbf90"
});
const db = firebase.firestore();

/* ================= SESSION ================= */
const session = JSON.parse(localStorage.getItem("jvbet_session"));
if(!session?.id) location.href="../index.html";
const UID = session.id;

/* ================= CONFIG ================= */
const ROUND_TIME = 30;

/* ================= TAB FIX ================= */
document.querySelectorAll(".tabbtn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  }
});

/* ================= HELPERS ================= */
const stateRef = g =>
  db.collection("users").doc(UID).collection("gameState").doc(g);

function now(){return Date.now();}

async function ensureGame(g){
  const ref = stateRef(g);
  const s = await ref.get();
  if(!s.exists){
    await ref.set({round:1,start:now(),done:false});
  }
}

function leftTime(s){
  return Math.max(0, ROUND_TIME - Math.floor((now()-s.start)/1000));
}

/* ================= RESULT ================= */
function draw(g){
  if(g==="dt") return ["DRAGON","TIGER","TIE"][Math.floor(Math.random()*3)];
  if(g==="tp") return ["PLAYER","BANKER","TIE"][Math.floor(Math.random()*3)];
  if(g==="rl"){
    const n=Math.floor(Math.random()*37);
    return (n===0?"GREEN":(n%2?"RED":"BLACK"))+" "+n;
  }
}

/* ================= LAST 5 ================= */
async function pushLast5(game,res,round){
  const uref = db.collection("users").doc(UID);
  await db.runTransaction(async tx=>{
    const s = await tx.get(uref);
    const d = s.data()||{};
    const l = d.last5Results||{};
    const arr = l[game]||[];
    arr.unshift({res,round,time:now()});
    l[game]=arr.slice(0,5);
    tx.set(uref,{last5Results:l},{merge:true});
  });
}

async function renderLast5(game,el){
  const s = await db.collection("users").doc(UID).get();
  const arr = s.data()?.last5Results?.[game]||[];
  el.innerHTML = arr.length
    ? arr.map((x,i)=>`<tr><td>${i+1}</td><td class="gold">${x.res}</td><td>${x.round}</td><td>${new Date(x.time).toLocaleTimeString()}</td></tr>`).join("")
    : `<tr><td colspan="4">No data</td></tr>`;
}

/* ================= LOOP ================= */
async function tick(game,timer,roundEl,tbody){
  await ensureGame(game);
  const ref = stateRef(game);
  const s = (await ref.get()).data();
  const left = leftTime(s);

  timer.textContent = left;
  roundEl.textContent = s.round;

  if(left===0 && !s.done){
    const r = draw(game);
    await pushLast5(game,r,s.round);
    await ref.update({done:true});
    setTimeout(()=>{
      ref.update({round:s.round+1,start:now(),done:false});
    },800);
  }
}

/* ================= INIT ================= */
setInterval(()=>{
  tick("dt",dtTimer,dtRound,dtLast5);
  tick("tp",tpTimer,tpRound,tpLast5);
  tick("rl",rTimer,rRound,rLast5);

  renderLast5("dt",dtLast5);
  renderLast5("tp",tpLast5);
  renderLast5("rl",rLast5);
},1000);
</script>
</body>
</html>
