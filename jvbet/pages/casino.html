<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Casino Demo - JVBET1803</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="shortcut icon" href="../assets/image/jvbet-logo.png" type="image/x-icon">

  <style>
    /* --- Mobile scroll box for tables (Last Plays + History) --- */
    .scrollBox{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      max-height: 320px;
      margin-top: 10px;
    }
    @media (min-width: 900px){
      .scrollBox{ max-height: 420px; }
    }

    /* keep table width on mobile */
    .scrollBox table{
      min-width: 720px;
    }

    /* --- Last 5 results chips wrap --- */
    .prevBox {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(0, 0, 0, .18);
      min-height: 44px;
    }
    .resChip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(212, 175, 55, .28);
      background: rgba(0, 0, 0, .25);
      font-weight: 800;
      letter-spacing: .3px;
      white-space: nowrap;
    }

    /* --- Toast --- */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, .78);
      border: 1px solid rgba(212, 175, 55, .35);
      color: #fff;
      padding: 12px 14px;
      border-radius: 14px;
      z-index: 9999;
      display: none;
      max-width: 92vw;
      box-shadow: 0 16px 40px rgba(0, 0, 0, .45);
    }
    .toast.show { display:block; }
    .toast .t { font-weight: 900; }
    .toast.win { border-color: rgba(34, 197, 94, .55); }
    .toast.loss { border-color: rgba(255, 77, 109, .55); }
    .toast.tie { border-color: rgba(43, 111, 255, .55); }

    /* --- small fixes --- */
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .muted { opacity:.75; }
    .gold { color:#d4af37; font-weight:900; }
  </style>
</head>

<body class="bg">
  <header class="header">
    <div class="head-inner">
      <img class="logo" src="../assets/image/jvbet-logo.png" alt="JVBET1803">
    </div>
  </header>

  <main class="wrap">
    <div class="row" style="justify-content:space-between;margin-bottom:12px">
      <div class="row">
        <span class="badge">Client: <span class="gold" id="cid">-</span></span>
        <span class="badge">Points: <span class="gold" id="pts">0</span></span>
        <span class="badge">Win: <span class="gold" id="w">0</span></span>
        <span class="badge">Loss: <span class="gold" id="l">0</span></span>
      </div>
      <button class="btn" type="button" id="logoutBtn">Logout</button>
    </div>

    <div class="tabs">
      <button class="tabbtn active" data-tab="dt" type="button">Dragon Tiger</button>
      <button class="tabbtn" data-tab="tp" type="button">Teen Patti</button>
      <button class="tabbtn" data-tab="rl" type="button">Roulette</button>
      <button class="tabbtn" data-tab="hist" type="button">History</button>
    </div>

    <!-- DRAGON TIGER -->
    <section class="panel active" id="dt">
      <div class="grid">
        <div class="card">
          <h3>Dragon Tiger</h3>

          <div style="margin-top:10px">
            <div class="muted">Last 5 Results</div>
            <div class="prevBox" id="dtPrev"></div>
          </div>

          <p class="muted" style="margin-top:10px">
            âœ… Play allowed only when timer &gt; 15 sec. âœ… Result shows at 0 sec.
          </p>

          <div class="row" style="justify-content:space-between;margin-top:10px">
            <span class="badge">Round: <span class="gold" id="dtRound">-</span></span>
            <span class="badge">Timer: <span class="gold" id="dtTimer">30</span>s</span>
            <span class="badge" id="dtLock">OPEN</span>
          </div>
        </div>

        <div class="casinoBoard">
          <div class="cTop">
            <div class="topBox">
              <div class="topTitle">Selected</div>
              <div class="topValue gold" id="dtPickShow">DRAGON</div>
            </div>
            <div class="topBox">
              <div class="topTitle">Last Result</div>
              <div class="topValue" id="dtLast">-</div>
            </div>
          </div>

          <div class="cMid">
            <div class="betRow" id="dtBets">
              <div class="betBox active" data-pick="DRAGON"><div class="betName">DRAGON</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="TIGER"><div class="betName">TIGER</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="TIE"><div class="betName">TIE</div><div class="betMul">Refund</div></div>
            </div>
          </div>

          <div class="cBottom">
            <div class="chips">
              <div class="chip" data-v="50">50</div>
              <div class="chip" data-v="100">100</div>
              <div class="chip" data-v="500">500</div>
              <div class="chip" data-v="1000">1000</div>
              <div class="chip" data-v="5000">5000</div>
            </div>

            <div class="stakeBox">
              <input class="stakeInput" id="dtStake" type="number" placeholder="Enter Bet">
              <button class="btn" id="dtPlay" type="button">Place Bet</button>
            </div>

            <span class="badge" id="dtMsg">-</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>Last Plays (Dragon Tiger)</h3>
        <div class="muted" id="dtWait"></div>

        <div class="scrollBox">
          <table class="table" id="dtPast">
            <thead>
              <tr><th>Time</th><th>Pick</th><th>Points</th><th>Result</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TEEN PATTI -->
    <section class="panel" id="tp">
      <div class="grid">
        <div class="card">
          <h3>Teen Patti</h3>

          <div style="margin-top:10px">
            <div class="muted">Last 5 Results</div>
            <div class="prevBox" id="tpPrev"></div>
          </div>

          <div class="row" style="justify-content:space-between;margin-top:10px">
            <span class="badge">Round: <span class="gold" id="tpRound">-</span></span>
            <span class="badge">Timer: <span class="gold" id="tpTimer">30</span>s</span>
            <span class="badge" id="tpLock">OPEN</span>
            <span class="badge">Selected: <span class="gold" id="tpPickShow">PLAYER</span></span>
          </div>
        </div>

        <div class="casinoBoard">
          <div class="cMid">
            <div class="betRow" id="tpBets">
              <div class="betBox active" data-pick="PLAYER"><div class="betName">PLAYER</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="BANKER"><div class="betName">BANKER</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="TIE"><div class="betName">TIE</div><div class="betMul">Refund</div></div>
            </div>
          </div>

          <div class="cBottom">
            <div class="chips">
              <div class="chip" data-v="10">10</div>
              <div class="chip" data-v="50">50</div>
              <div class="chip" data-v="100">100</div>
              <div class="chip" data-v="500">500</div>
              <div class="chip" data-v="1000">1000</div>
            </div>

            <div class="stakeBox">
              <input class="stakeInput" id="tpStake" type="number" placeholder="Enter points">
              <button class="btn" id="tpPlay" type="button">PLAY (POINTS)</button>
            </div>

            <span class="badge" id="tpMsg">-</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>Last Plays (Teen Patti)</h3>
        <div class="muted" id="tpWait"></div>

        <div class="scrollBox">
          <table class="table" id="tpPast">
            <thead>
              <tr><th>Time</th><th>Pick</th><th>Points</th><th>Result</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ROULETTE -->
    <section class="panel" id="rl">
      <div class="grid">
        <div class="card">
          <h3>Roulette</h3>

          <div style="margin-top:10px">
            <div class="muted">Last 5 Results</div>
            <div class="prevBox" id="rPrev"></div>
          </div>

          <div class="row" style="justify-content:space-between;margin-top:10px">
            <span class="badge">Round: <span class="gold" id="rRound">-</span></span>
            <span class="badge">Timer: <span class="gold" id="rTimer">30</span>s</span>
            <span class="badge" id="rLock">OPEN</span>
            <span class="badge">Selected: <span class="gold" id="rPickShow">RED</span></span>
          </div>
        </div>

        <div class="casinoBoard">
          <div class="cMid">
            <div class="betRow" id="rBets">
              <div class="betBox active" data-pick="RED"><div class="betName">RED</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="BLACK"><div class="betName">BLACK</div><div class="betMul">2x</div></div>
            </div>
          </div>

          <div class="cBottom">
            <div class="chips">
              <div class="chip" data-v="10">10</div>
              <div class="chip" data-v="50">50</div>
              <div class="chip" data-v="100">100</div>
              <div class="chip" data-v="500">500</div>
              <div class="chip" data-v="1000">1000</div>
            </div>

            <div class="stakeBox">
              <input class="stakeInput" id="rStake" type="number" placeholder="Enter points">
              <button class="btn" id="rPlay" type="button">PLAY (POINTS)</button>
            </div>

            <span class="badge" id="rMsg">-</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>Last Plays (Roulette)</h3>
        <div class="muted" id="rWait"></div>

        <div class="scrollBox">
          <table class="table" id="rPast">
            <thead>
              <tr><th>Time</th><th>Pick</th><th>Points</th><th>Result</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section class="panel" id="hist">
      <div class="card">
        <h3>Full Play History</h3>

        <div class="scrollBox">
          <table class="table" id="bh">
            <thead>
              <tr><th>Time</th><th>Game</th><th>Pick</th><th>Points</th><th>Result</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:8px">
          âœ… Mobile me box ke andar scroll hoga (left-right + up-down).
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast">
    <div class="t" id="toastTitle">-</div>
    <div class="muted" id="toastBody">-</div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

  <script>
    /* ================= FIREBASE INIT ================= */
    firebase.initializeApp({
      apiKey: "AIzaSyCAFH5_1RjVHyZLwkj26zQPCq0-8S0fSKA",
      authDomain: "jvbet-bbf90.firebaseapp.com",
      projectId: "jvbet-bbf90",
      storageBucket: "jvbet-bbf90.appspot.com",
      messagingSenderId: "824871692224",
      appId: "1:824871692224:web:f74baa642b1f43b78aca25"
    });
    const db = firebase.firestore();

    /* ================= SESSION (support old + new keys) ================= */
    const K_SESSION_NEW = "jvbet_session";
    const K_SESSION_OLD = "jvbet_session_v1";

    function getSession(){
      try{
        const a = localStorage.getItem(K_SESSION_NEW);
        if(a) return JSON.parse(a);
      }catch(e){}
      try{
        const b = localStorage.getItem(K_SESSION_OLD);
        if(b) return JSON.parse(b);
      }catch(e){}
      return null;
    }

    function clearSession(){
      localStorage.removeItem(K_SESSION_NEW);
      localStorage.removeItem(K_SESSION_OLD);
    }

    function requireClient(){
      const s = getSession();
      if(!s || (s.role !== "client" && s.role !== "admin")){
        location.href = "../index.html";
        return null;
      }
      // admin ko bhi casino me allow kar diya (optional)
      return s;
    }

    /* ================= UI HELPERS ================= */
    function fmtDate(ms){
      try{
        return new Date(Number(ms)).toLocaleString();
      }catch(e){ return String(ms); }
    }

    function showToast(type, title, body) {
      var t = document.getElementById("toast");
      t.className = "toast show " + (type || "");
      document.getElementById("toastTitle").textContent = title;
      document.getElementById("toastBody").textContent = body || "";
      setTimeout(function(){ t.className = "toast"; }, 2500);
    }

    function vib(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){} }

    /* ================= FIRESTORE PATHS ================= */
    function userRef(uid){ return db.collection("users").doc(uid); }
    function resultsRef(game){ return db.collection("gameResults").doc(game); }
    function stateRef(game){ return db.collection("gameState").doc(game); }
    function betsRef(uid){ return db.collection("users").doc(uid).collection("bets"); }

    /* ================= LAST 5 RESULTS (subscribe) ================= */
    function renderLast5(game, elId){
      return resultsRef(game).onSnapshot((snap)=>{
        const el = document.getElementById(elId);
        if(!el) return;
        const arr = (snap.exists && Array.isArray(snap.data().last5)) ? snap.data().last5 : [];
        if(!arr.length){
          el.innerHTML = '<span class="muted">No result</span>';
          return;
        }
        el.innerHTML = arr.slice().reverse().map(v=>`<span class="resChip">${v}</span>`).join("");
      });
    }

    async function pushResultTx(game, value){
      await db.runTransaction(async (tx)=>{
        const ref = resultsRef(game);
        const snap = await tx.get(ref);
        const data = snap.exists ? snap.data() : {};
        let arr = Array.isArray(data.last5) ? data.last5.slice() : [];
        arr.push(String(value));
        if(arr.length > 5) arr = arr.slice(arr.length - 5);
        tx.set(ref, {
          last5: arr,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      });
    }

    /* ================= GLOBAL ROUND (shared) =================
       NOTE: Static site limitation:
       - Agar koi user online nahi hoga, round auto-generate nahi hoga.
       - Always-running ke liye Firebase Cloud Functions Scheduler best hai.
    */
    const TOTAL_SEC = 30;
    const LOCK_REMAINING = 15;

    function newRound(){
      const nowMs = Date.now();
      const rid = "R-" + nowMs + "-" + Math.floor(Math.random()*999999);
      return { roundId: rid, startAtMs: nowMs, endAtMs: nowMs + TOTAL_SEC*1000, lastResult:"" };
    }

    async function ensureGlobalRound(game){
      const ref = stateRef(game);
      await db.runTransaction(async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists){
          tx.set(ref, newRound(), { merge:true });
          return;
        }
        const st = snap.data() || {};
        const endAt = Number(st.endAtMs || 0);
        if(!endAt || Date.now() > endAt + 2000){
          tx.set(ref, newRound(), { merge:true });
        }
      });
    }

    /* Host tries to publish result at round end.
       Whoever is active can act as host.
    */
    async function tryPublishResult(game){
      const ref = stateRef(game);
      await db.runTransaction(async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists) return;
        const st = snap.data() || {};
        const endAt = Number(st.endAtMs || 0);
        const publishedFor = st.publishedForRoundId || "";
        if(!endAt) return;
        if(Date.now() < endAt) return; // not ended
        if(publishedFor === st.roundId) return; // already published

        // generate result
        let res = "-";
        if(game === "DragonTiger"){
          const d = 1 + Math.floor(Math.random()*13);
          const t = 1 + Math.floor(Math.random()*13);
          res = (d===t) ? "TIE" : (d>t ? "DRAGON" : "TIGER");
        } else if(game === "TeenPatti"){
          const r = Math.random();
          res = (r<0.45) ? "PLAYER" : (r<0.9 ? "BANKER" : "TIE");
        } else if(game === "Roulette"){
          const n = Math.floor(Math.random()*37);
          const color = (n===0) ? "GREEN" : (n%2===0 ? "BLACK" : "RED");
          res = color + " " + n;
        }

        // save into state
        tx.set(ref, {
          lastResult: res,
          publishedForRoundId: st.roundId,
          publishedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      });
    }

    /* ================= BETS + POINTS (per user) ================= */
    async function placeBet(uid, game, pick, stake, roundId){
      stake = Number(stake || 0);
      if(stake<=0) throw new Error("Enter valid points");
      // lock check is handled in UI

      await db.runTransaction(async (tx)=>{
        const uref = userRef(uid);
        const usnap = await tx.get(uref);
        if(!usnap.exists) throw new Error("User missing");
        const u = usnap.data() || {};
        const pts = Number(u.points || 0);
        if(stake > pts) throw new Error("Not enough points");

        // create bet doc
        const bref = betsRef(uid).doc();
        tx.set(bref, {
          at: Date.now(),
          game: game,
          pick: pick,
          stake: stake,
          roundId: roundId,
          result: "PENDING"
        });

        // deduct points
        tx.set(uref, { points: pts - stake }, { merge:true });
      });
    }

    async function settleUserPending(uid, game, roundId, lastResult){
      // find pending bets for this game+round
      const qs = await betsRef(uid)
        .where("game","==",game)
        .where("roundId","==",roundId)
        .where("result","==","PENDING")
        .get();

      if(qs.empty) return;

      for(const doc of qs.docs){
        await db.runTransaction(async (tx)=>{
          const bref = betsRef(uid).doc(doc.id);
          const bsnap = await tx.get(bref);
          if(!bsnap.exists) return;
          const b = bsnap.data() || {};
          if(b.result !== "PENDING") return;

          let outcome = "LOSS";
          if(game === "Roulette"){
            // lastResult: "RED 15"
            const parts = String(lastResult).split(" ");
            const color = parts[0] || "";
            outcome = (b.pick === color) ? "WIN" : "LOSS";
          } else {
            if(String(lastResult) === "TIE") outcome = "TIE";
            else outcome = (b.pick === String(lastResult)) ? "WIN" : "LOSS";
          }

          // points payout
          const uref = userRef(uid);
          const usnap = await tx.get(uref);
          const u = usnap.data() || {};
          const curPts = Number(u.points || 0);
          const stake = Number(b.stake || 0);

          let add = 0;
          if(outcome === "WIN") add = stake * 2;
          if(outcome === "TIE") add = stake;

          tx.set(bref, { result: outcome, settledAt: Date.now(), resultValue: String(lastResult) }, { merge:true });
          if(add>0) tx.set(uref, { points: curPts + add }, { merge:true });
        });
      }
    }

    /* ================= UI BINDINGS ================= */
    function bindBetBoxes(containerId, showId) {
      const cont = document.getElementById(containerId);
      const show = document.getElementById(showId);
      let pick = (cont.querySelector(".betBox.active") || {}).dataset ? cont.querySelector(".betBox.active").dataset.pick : "";

      show.textContent = pick || "-";
      cont.querySelectorAll(".betBox").forEach(function(box){
        box.addEventListener("click", function(){
          cont.querySelectorAll(".betBox").forEach(b=>b.classList.remove("active"));
          box.classList.add("active");
          pick = box.dataset.pick || "";
          show.textContent = pick || "-";
        });
      });
      return function(){ return pick; };
    }

    function bindChips(scopeEl, inputEl){
      scopeEl.querySelectorAll(".chip").forEach(function(ch){
        ch.addEventListener("click", function(){
          const v = Number(ch.dataset.v || 0);
          const cur = Number(inputEl.value || 0);
          inputEl.value = cur + v;
        });
      });
    }

    function setLock(id, txt){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = txt;
    }

    /* ================= LOAD + RUN ================= */
    const s = requireClient();
    const uid = (s && (s.id || s.clientId || s.uid)) ? (s.id || s.clientId || s.uid) : null;
    if(!uid){ location.href = "../index.html"; }

    // logout
    document.getElementById("logoutBtn").addEventListener("click", function(){
      clearSession();
      location.href = "../index.html";
    });

    // tabs
    document.querySelectorAll(".tabbtn").forEach(function(btn){
      btn.addEventListener("click", function(){
        document.querySelectorAll(".tabbtn").forEach(x=>x.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
        if(btn.dataset.tab === "hist") renderHistory();
      });
    });

    // picks + chips
    const getDTPick = bindBetBoxes("dtBets","dtPickShow");
    const getTPPick = bindBetBoxes("tpBets","tpPickShow");
    const getRPick  = bindBetBoxes("rBets","rPickShow");

    bindChips(document.getElementById("dt"), document.getElementById("dtStake"));
    bindChips(document.getElementById("tp"), document.getElementById("tpStake"));
    bindChips(document.getElementById("rl"), document.getElementById("rStake"));

    // subscribe user points + basic
    let unsubUser = userRef(uid).onSnapshot((snap)=>{
      if(!snap.exists){
        clearSession();
        location.href = "../index.html";
        return;
      }
      const u = snap.data() || {};
      document.getElementById("cid").textContent = u.clientId || uid;
      document.getElementById("pts").textContent = Number(u.points || 0);
    });

    // last 5 subscribe
    let unsubDT = renderLast5("DragonTiger","dtPrev");
    let unsubTP = renderLast5("TeenPatti","tpPrev");
    let unsubR  = renderLast5("Roulette","rPrev");

    // ensure rounds exist (global)
    ensureGlobalRound("DragonTiger");
    ensureGlobalRound("TeenPatti");
    ensureGlobalRound("Roulette");

    // state listeners for result publish + settle
    function watchGame(game, roundEl, timerEl, lockEl, lastEl, pastTableId){
      return stateRef(game).onSnapshot(async (snap)=>{
        if(!snap.exists) return;
        const st = snap.data() || {};
        const endAt = Number(st.endAtMs || 0);
        const rid = st.roundId || "-";
        const lastResult = st.lastResult || "";

        // show round + timer
        document.getElementById(roundEl).textContent = rid;
        const left = Math.max(0, Math.ceil((endAt - Date.now())/1000));
        document.getElementById(timerEl).textContent = left;

        // lock UI
        if(left > LOCK_REMAINING) setLock(lockEl, "OPEN");
        else if(left > 0) setLock(lockEl, "LOCKED");
        else setLock(lockEl, "CLOSED");

        // show last result on board
        if(lastResult){
          document.getElementById(lastEl).textContent = lastResult;
        }

        // if round ended: host try publish result
        if(left <= 0){
          try{
            await tryPublishResult(game);
          }catch(e){}
        }

        // if published for this round: settle my pending bet
        if(st.publishedForRoundId === rid && lastResult){
          try{
            await settleUserPending(uid, game, rid, lastResult);
            await loadPast(game, pastTableId);
            await loadWinLoss(); // update W/L
          }catch(e){}
        }
      });
    }

    // Win/Loss simple count from bets subcollection
    async function loadWinLoss(){
      const qs = await betsRef(uid).where("result","in",["WIN","LOSS"]).get();
      let win=0, loss=0;
      qs.forEach(d=>{
        const r = (d.data()||{}).result;
        if(r==="WIN") win++;
        if(r==="LOSS") loss++;
      });
      document.getElementById("w").textContent = win;
      document.getElementById("l").textContent = loss;
    }

    async function loadPast(game, tableId){
      const qs = await betsRef(uid)
        .where("game","==",game)
        .where("result","in",["WIN","LOSS","TIE"])
        .orderBy("at","desc")
        .limit(10)
        .get();

      const tb = document.querySelector("#"+tableId+" tbody");
      if(!tb) return;

      if(qs.empty){
        tb.innerHTML = "<tr><td colspan='4' class='muted'>No history</td></tr>";
        return;
      }
      let html = "";
      qs.forEach(doc=>{
        const b = doc.data() || {};
        html += "<tr>" +
          "<td>"+fmtDate(b.at)+"</td>" +
          "<td>"+(b.pick||"-")+"</td>" +
          "<td class='gold'>"+Number(b.stake||0)+"</td>" +
          "<td>"+(b.result||"-")+"</td>" +
        "</tr>";
      });
      tb.innerHTML = html;
    }

    async function renderHistory(){
      const qs = await betsRef(uid)
        .where("result","in",["WIN","LOSS","TIE"])
        .orderBy("at","desc")
        .limit(200)
        .get();

      const tb = document.querySelector("#bh tbody");
      if(!tb) return;

      if(qs.empty){
        tb.innerHTML = "<tr><td colspan='5' class='muted'>No history</td></tr>";
        return;
      }
      let html = "";
      qs.forEach(doc=>{
        const b = doc.data() || {};
        html += "<tr>" +
          "<td>"+fmtDate(b.at)+"</td>" +
          "<td>"+(b.game||"-")+"</td>" +
          "<td>"+(b.pick||"-")+"</td>" +
          "<td class='gold'>"+Number(b.stake||0)+"</td>" +
          "<td>"+(b.result||"-")+"</td>" +
        "</tr>";
      });
      tb.innerHTML = html;
    }

    // Watch games
    let unsubStateDT = watchGame("DragonTiger","dtRound","dtTimer","dtLock","dtLast","dtPast");
    let unsubStateTP = watchGame("TeenPatti","tpRound","tpTimer","tpLock","tpMsg","tpPast"); // tpMsg me last show as status (simple)
    let unsubStateR  = watchGame("Roulette","rRound","rTimer","rLock","rMsg","rPast");       // rMsg me last show as status (simple)

    // Place bet buttons
    document.getElementById("dtPlay").addEventListener("click", async function(){
      try{
        const stSnap = await stateRef("DragonTiger").get();
        const st = stSnap.data() || {};
        const endAt = Number(st.endAtMs||0);
        const left = Math.max(0, Math.ceil((endAt - Date.now())/1000));
        if(left <= LOCK_REMAINING) throw new Error("Locked (play only when timer > 15)");

        await placeBet(uid, "DragonTiger", getDTPick(), document.getElementById("dtStake").value, st.roundId);
        document.getElementById("dtMsg").textContent = "PLAY SUBMITTED";
        showToast("tie","ðŸ•’ PLAY SUBMITTED","Result will show at 0 sec");
        vib(40);
      }catch(e){
        document.getElementById("dtMsg").textContent = e.message || String(e);
      }
    });

    document.getElementById("tpPlay").addEventListener("click", async function(){
      try{
        const stSnap = await stateRef("TeenPatti").get();
        const st = stSnap.data() || {};
        const endAt = Number(st.endAtMs||0);
        const left = Math.max(0, Math.ceil((endAt - Date.now())/1000));
        if(left <= LOCK_REMAINING) throw new Error("Locked (play only when timer > 15)");

        await placeBet(uid, "TeenPatti", getTPPick(), document.getElementById("tpStake").value, st.roundId);
        document.getElementById("tpMsg").textContent = "PLAY SUBMITTED";
        showToast("tie","ðŸ•’ PLAY SUBMITTED","Result will show at 0 sec");
        vib(40);
      }catch(e){
        document.getElementById("tpMsg").textContent = e.message || String(e);
      }
    });

    document.getElementById("rPlay").addEventListener("click", async function(){
      try{
        const stSnap = await stateRef("Roulette").get();
        const st = stSnap.data() || {};
        const endAt = Number(st.endAtMs||0);
        const left = Math.max(0, Math.ceil((endAt - Date.now())/1000));
        if(left <= LOCK_REMAINING) throw new Error("Locked (play only when timer > 15)");

        await placeBet(uid, "Roulette", getRPick(), document.getElementById("rStake").value, st.roundId);
        document.getElementById("rMsg").textContent = "PLAY SUBMITTED";
        showToast("tie","ðŸ•’ PLAY SUBMITTED","Result will show at 0 sec");
        vib(40);
      }catch(e){
        document.getElementById("rMsg").textContent = e.message || String(e);
      }
    });

    // init load
    loadPast("DragonTiger","dtPast");
    loadPast("TeenPatti","tpPast");
    loadPast("Roulette","rPast");
    loadWinLoss();

    // small tick: keep ensuring rounds (in case doc deleted)
    setInterval(function(){
      ensureGlobalRound("DragonTiger");
      ensureGlobalRound("TeenPatti");
      ensureGlobalRound("Roulette");
    }, 5000);
  </script>
</body>
</html>
