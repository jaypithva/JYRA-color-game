<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>dNEW UI TEST - JVBET1803</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="shortcut icon" href="../assets/image/jvbet-logo.png" type="image/x-icon" />

  <style>
    :root{
      --bg:#05060a;

      --gold:#d4af37;
      --gold2:#f3df8a;
      --goldSoft: rgba(212,175,55,.22);

      --text:#fff;
      --muted: rgba(255,255,255,.72);

      --shadow: 0 18px 60px rgba(0,0,0,.65);

      --good: rgba(34,197,94,1);
      --warn: rgba(255,193,7,1);
      --bad: rgba(255,77,109,1);
      --blue: rgba(43,111,255,1);

      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.08);

      --r1: 18px;
      --r2: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif;
      background:
        radial-gradient(1200px 650px at 15% -10%, rgba(212,175,55,.20), transparent 55%),
        radial-gradient(950px 550px at 90% 0%, rgba(212,175,55,.12), transparent 55%),
        radial-gradient(900px 550px at 40% 120%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.88), rgba(0,0,0,.96)),
        var(--bg);
      background-blend-mode: screen, screen, screen, normal, normal;
      min-height:100dvh;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-120px;
      pointer-events:none;
      background:
        radial-gradient(circle at 15% 10%, rgba(212,175,55,.12), transparent 36%),
        radial-gradient(circle at 85% 22%, rgba(212,175,55,.08), transparent 42%),
        radial-gradient(circle at 40% 90%, rgba(212,175,55,.10), transparent 48%),
        repeating-radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.07) 0 1px, transparent 1px 7px),
        linear-gradient(120deg, rgba(255,255,255,.05), transparent 35%, rgba(255,255,255,.04));
      opacity:.18;
      mix-blend-mode: overlay;
      filter: blur(.35px);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px;
      padding-bottom: 104px;
    }

    .gold{color:var(--gold)}
    .muted{color:var(--muted);font-weight:900}

    /* TOP HEADER */
    .topBanner{
      position: sticky;
      top:0;
      z-index:100;
      padding: 12px;
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .bannerInner{
      max-width:1100px;
      margin:0 auto;
      border-radius: 18px;
      border: 1px solid rgba(212,175,55,.22);
      background:
        radial-gradient(900px 260px at 30% 0%, rgba(212,175,55,.28), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.62));
      box-shadow:
        0 22px 80px rgba(0,0,0,.70),
        inset 0 1px 0 rgba(255,255,255,.08);
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:relative;
      overflow:hidden;
    }

    .bannerInner::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: linear-gradient(90deg, transparent, rgba(212,175,55,.14), transparent);
      opacity:.55;
    }

    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{
      height:42px;width:auto;display:block;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.55)) drop-shadow(0 0 18px rgba(212,175,55,.30));
    }
    .brandTxt .t2{
      font-weight:1100;font-size:12px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.45px;
    }

    .logoutBtn{
      display:inline-flex;align-items:center;gap:10px;
      padding: 10px 16px;border-radius: 12px;
      border: 1px solid rgba(212,175,55,.28);
      background:
        radial-gradient(180px 60px at 30% 10%, rgba(255,255,255,.12), transparent 55%),
        rgba(0,0,0,.38);
      color:#fff;font-weight:1200;cursor:pointer;user-select:none;
      box-shadow:
        0 16px 40px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.08);
    }
    .logoutBtn:active{transform:scale(.99)}
    .logoutBtn .ic{filter: drop-shadow(0 0 10px rgba(212,175,55,.30))}

    /* STATS BAR */
    .statsBar{
      max-width:1100px;
      margin:10px auto 0;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .statPill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(140px 50px at 30% 10%, rgba(255,255,255,.10), transparent 60%),
        rgba(0,0,0,.30);
      font-weight:1100;
      white-space:nowrap;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .statClickable{cursor:pointer}
    .statClickable:active{transform:scale(.99)}
    .statPill b{font-weight:1300}

    /* TABS */
    .tabsRow{
      max-width:1100px;
      margin: 10px auto 0;
      display:flex;
      gap:10px;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
      padding-bottom: 2px;
    }
    .tabsRow::-webkit-scrollbar{display:none}
    .tabBtn{
      flex: 0 0 auto;
      display:inline-flex;align-items:center;gap:10px;
      padding: 10px 14px;border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(220px 70px at 30% 10%, rgba(255,255,255,.09), transparent 60%),
        rgba(0,0,0,.26);
      color:#fff;font-weight:1200;cursor:pointer;user-select:none;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.06),
        0 10px 24px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .tabBtn.active{
      border-color: rgba(212,175,55,.45);
      background:
        radial-gradient(220px 80px at 30% 0%, rgba(212,175,55,.28), transparent 60%),
        rgba(0,0,0,.32);
      box-shadow:
        0 18px 44px rgba(0,0,0,.58),
        inset 0 0 0 1px rgba(212,175,55,.20),
        inset 0 1px 0 rgba(255,255,255,.08);
    }

    .panel{display:none}
    .panel.active{display:block}

    /* SECTION BAR */
    .sectionBar{
      margin-top: 14px;border-radius: 14px;
      border: 1px solid rgba(212,175,55,.18);
      background:
        radial-gradient(900px 200px at 30% 0%, rgba(212,175,55,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.52));
      padding: 12px 14px;
      box-shadow:
        0 22px 70px rgba(0,0,0,.62),
        inset 0 1px 0 rgba(255,255,255,.07);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      overflow:hidden;
    }
    .sectionBar .title{display:flex;align-items:center;gap:10px;font-weight:1200;letter-spacing:.2px;font-size:18px}
    .sectionBar .badgeLive{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      font-weight:1100;white-space:nowrap;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* ===== GAME SHELL ===== */
    .gameShell{
      margin-top: 12px;
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 300px at 20% 0%, rgba(212,175,55,.12), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.62));
      box-shadow:
        0 26px 90px rgba(0,0,0,.75),
        inset 0 1px 0 rgba(255,255,255,.08);
      overflow:hidden;
      position:relative;
    }
    .gameShell::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background: linear-gradient(120deg, transparent 0 30%, rgba(212,175,55,.06) 45%, transparent 65%);
      opacity:.65;
      mix-blend-mode: screen;
    }

    .gameGrid{display:grid;grid-template-columns:1fr;}
    @media (min-width: 980px){
      .gameGrid{grid-template-columns: 1.75fr 1fr; min-height: 430px;}
    }

    /* LEFT: video */
    .liveWrap{
      position:relative;
      overflow:hidden;
      background: rgba(0,0,0,.48);
      border-right: 1px solid rgba(255,255,255,.08);
      min-height: 280px;
    }
    @media (max-width: 979px){
      .liveWrap{border-right:none;border-bottom: 1px solid rgba(255,255,255,.08);}
    }
    .liveTopLeft{
      position:absolute;top:12px;left:12px;z-index:5;
      display:flex;align-items:center;gap:10px;
      padding: 8px 10px;border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.62);
      font-weight:1200;white-space:nowrap;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.07), 0 12px 26px rgba(0,0,0,.35);
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#ff3b3b;
      box-shadow: 0 0 14px rgba(255,59,59,.85);
      animation:pulse 1.2s infinite;
    }
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.35);opacity:.65}}

    .video{
      width:100%;
      height: 320px;
      object-fit:cover;
      display:block;
      background:#000;
      filter: contrast(1.10) saturate(1.08) brightness(.96);
      transform: scale(1.02);
    }
    @media (max-width: 560px){ .video{height: 250px} }
    @media (min-width: 980px){ .video{height: 100%; min-height:430px} }

    .liveWrap::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      border: 1px solid rgba(212,175,55,.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }

    .lockedOverlay{
      position:absolute;inset:0;z-index:6;
      display:none;align-items:center;justify-content:center;padding: 16px;
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.82));
      backdrop-filter: blur(2px);
    }
    .lockedOverlay.show{display:flex}
    .lockedCard{
      width:min(520px, 92%);
      border-radius: var(--r2);
      border: 1px solid rgba(212,175,55,.24);
      background:
        radial-gradient(260px 120px at 30% 10%, rgba(212,175,55,.14), transparent 60%),
        rgba(0,0,0,.70);
      box-shadow: 0 22px 70px rgba(0,0,0,.70);
      padding: 14px;text-align:center;
    }
    .lockedCard .t{font-weight:1200;font-size:16px;letter-spacing:.2px}
    .lockedCard .s{margin-top:6px;color:var(--muted);font-weight:1000;font-size:13px}
    .lockedRow{margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .miniPill{
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.34);
      font-weight:1100;white-space:nowrap;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* RIGHT: controls */
    .sideControls{
      background:
        radial-gradient(320px 140px at 30% 0%, rgba(255,255,255,.06), transparent 60%),
        rgba(0,0,0,.30);
      display:flex;
      flex-direction:column;
      min-width: 0;
      position:relative;
    }

    .timerLine{
      display:flex;align-items:center;gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.36);
      flex-wrap:wrap;
    }
    .progressOuter{
      flex: 1 1 260px;
      display:flex;align-items:center;gap:10px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,.24);
      background:
        radial-gradient(220px 70px at 30% 20%, rgba(255,255,255,.08), transparent 62%),
        rgba(0,0,0,.40);
      padding: 8px 10px;
      min-width: 240px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .timerText{font-weight:1200;white-space:nowrap}
    .progressBar{
      flex:1;height: 10px;border-radius: 999px;
      background: rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    .progressFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(212,175,55,.98), rgba(255,255,255,.22));
      box-shadow: 0 0 18px rgba(212,175,55,.28);
    }
    .statusPill{
      padding: 10px 14px;border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(140px 50px at 30% 10%, rgba(255,255,255,.08), transparent 60%),
        rgba(0,0,0,.32);
      font-weight:1200;white-space:nowrap;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .lockOpen{ border-color: rgba(34,197,94,.40) }
    .lockLocked{ border-color: rgba(255,193,7,.40) }
    .lockClosed{ border-color: rgba(255,77,109,.40) }
    .lockPlaced{ border-color: rgba(43,111,255,.40) }

    .betRow{
      display:grid;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
    }
    .betRow.cols4{grid-template-columns: repeat(4, minmax(0,1fr));}
    .betRow.cols3{grid-template-columns: repeat(3, minmax(0,1fr));}
    .betRow.cols2{grid-template-columns: repeat(2, minmax(0,1fr));}
    @media (max-width: 560px){
      .betRow.cols4{grid-template-columns: repeat(2, minmax(0,1fr))}
      .betRow.cols3{grid-template-columns: repeat(3, minmax(0,1fr))}
      .betRow.cols2{grid-template-columns: repeat(2, minmax(0,1fr))}
    }

    .betBox{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(240px 90px at 30% 10%, rgba(255,255,255,.08), transparent 62%),
        rgba(0,0,0,.30);
      padding: 14px 10px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.06),
        0 14px 34px rgba(0,0,0,.30);
      transition: transform .08s ease, border-color .2s ease, background .2s ease, box-shadow .2s ease;
      min-width: 0;
    }
    .betBox:active{transform:scale(.99)}
    .betBox.active{
      border-color: rgba(212,175,55,.55);
      background:
        radial-gradient(240px 100px at 30% 0%, rgba(212,175,55,.26), transparent 64%),
        rgba(0,0,0,.34);
      box-shadow:
        0 22px 56px rgba(0,0,0,.60),
        inset 0 0 0 1px rgba(212,175,55,.18),
        inset 0 1px 0 rgba(255,255,255,.07);
    }
    .betName{font-weight:1200;letter-spacing:.15px}
    .betMul{margin-top:4px;font-weight:1000;color:var(--muted);font-size:12px}

    .stakeRow{
      display:flex;gap:10px;align-items:stretch;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
      flex-wrap:wrap;
    }
    .stakeInput{
      flex: 1 1 260px;min-width: 180px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(220px 70px at 30% 10%, rgba(255,255,255,.08), transparent 62%),
        rgba(0,0,0,.34);
      color:#fff;
      padding: 12px 12px;
      font-weight:1200;
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .stakeInput::placeholder{color: rgba(255,255,255,.55); font-weight:900}
    .placeBtn{
      padding: 12px 18px;border-radius: 12px;
      border: 1px solid rgba(212,175,55,.34);
      background:
        radial-gradient(240px 80px at 30% 10%, rgba(255,255,255,.40), transparent 62%),
        linear-gradient(180deg, rgba(212,175,55,1), rgba(255,255,255,.80));
      color:#120c00;
      font-weight:1300;
      cursor:pointer;user-select:none;
      white-space:nowrap;
      box-shadow: 0 18px 54px rgba(0,0,0,.62);
    }
    .placeBtn:active{transform:scale(.99)}
    .placeBtn:disabled{opacity:.55;cursor:not-allowed}

    .chipBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
    }
    .chip{
      min-width:72px;text-align:center;
      padding: 10px 14px;border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(220px 70px at 30% 10%, rgba(255,255,255,.10), transparent 62%),
        rgba(0,0,0,.32);
      font-weight:1200;cursor:pointer;user-select:none;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        0 12px 26px rgba(0,0,0,.25);
      transition: transform .08s ease, border-color .2s ease;
    }
    .chip:active{transform:scale(.99)}
    .chip.goldChip{
      border-color: rgba(212,175,55,.36);
      box-shadow: 0 0 20px rgba(212,175,55,.14), inset 0 1px 0 rgba(255,255,255,.08);
    }

    /* BELOW TABLES */
    .tableCard{
      margin-top: 12px;border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 300px at 20% 0%, rgba(212,175,55,.10), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.56));
      box-shadow:
        0 22px 80px rgba(0,0,0,.70),
        inset 0 1px 0 rgba(255,255,255,.07);
      overflow:hidden;
    }
    .tableHead{
      padding: 12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.34);
      flex-wrap:wrap;
    }
    .tableHead .h{font-weight:1200;display:flex;align-items:center;gap:10px;white-space:nowrap}
    .tableActions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .scroll{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      max-height: 260px;
    }
    table{width:100%;border-collapse: collapse;min-width: 620px;}
    th,td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      text-align:left;
      white-space:nowrap;
      font-weight:1000;
    }
    th{font-size:12px;color:var(--muted);letter-spacing:.2px}
    @media (max-width: 560px){
      table{min-width: 520px}
      th,td{padding: 9px 10px}
    }

    /* toast */
    .toast{
      position:fixed;left:50%;bottom:92px;transform:translateX(-50%);
      background: rgba(0,0,0,.84);
      border:1px solid rgba(212,175,55,.32);
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      z-index:9999;
      display:none;
      max-width: 92vw;
      box-shadow: 0 18px 60px rgba(0,0,0,.65);
    }
    .toast.show{display:block}
    .toast .t{font-weight:1200}

    /* bottom nav */
    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      z-index:200;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255,255,255,.10);
      display:none;
    }
    .bottomInner{
      max-width: 1100px;margin:0 auto;
      display:grid;grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .bBtn{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(220px 70px at 30% 10%, rgba(255,255,255,.08), transparent 62%),
        rgba(0,0,0,.30);
      padding: 10px 8px;
      color:#fff;
      cursor:pointer;
      user-select:none;
      display:flex;flex-direction:column;align-items:center;gap:6px;
      font-weight:1200;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .bBtn.active{
      border-color: rgba(212,175,55,.40);
      background:
        radial-gradient(220px 90px at 30% 0%, rgba(212,175,55,.22), transparent 60%),
        rgba(0,0,0,.34);
      box-shadow: inset 0 0 0 1px rgba(212,175,55,.14), inset 0 1px 0 rgba(255,255,255,.07);
    }
    .bBtn .i{font-size:18px;opacity:.95}
    .bBtn .t{font-size:12px;opacity:.95}
    @media (max-width: 720px){ .bottomBar{display:block} }

    /* mini cards (Last5 / MyBet) */
    .miniGrid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      padding:12px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    @media (max-width: 720px){
      .miniGrid{grid-template-columns: 1fr}
    }
    .miniCard{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(240px 90px at 30% 10%, rgba(255,255,255,.08), transparent 62%),
        rgba(0,0,0,.26);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .miniHead{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.30);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-weight:1200;
    }
    .miniBody{padding: 10px 12px}
    .miniTable{
      width:100%;
      border-collapse: collapse;
      min-width: 0 !important;
    }
    .miniTable th, .miniTable td{
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      font-weight:1000;
      white-space:nowrap;
    }
    .miniSub{font-weight:900;color:var(--muted);font-size:12px}
    .statusTag{
      padding: 7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      font-weight:1200;
      white-space:nowrap;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* ===== WIN/LOSS POPUP ===== */
    .modalBack{
      position:fixed;
      inset:0;
      z-index:99999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.70);
      backdrop-filter: blur(12px);
    }
    .modalBack.show{display:flex}
    .modalCard{
      width:min(720px, 94vw);
      max-height: 88vh;
      border-radius: 18px;
      border:1px solid rgba(212,175,55,.28);
      background:
        radial-gradient(900px 260px at 30% 0%, rgba(212,175,55,.22), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.82));
      box-shadow: 0 28px 90px rgba(0,0,0,.80);
      overflow:hidden;
      transform: translateY(8px);
      animation: popIn .14s ease-out forwards;
    }
    @keyframes popIn{to{transform: translateY(0)}}
    .modalHead{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.38);
    }
    .modalTitle{
      font-weight:1300;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modalClose{
      border:none;
      background: rgba(0,0,0,.28);
      color:#fff;
      font-weight:1300;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .modalBody{padding: 14px 16px; overflow:auto; max-height: calc(88vh - 64px);}
    .bigCount{
      text-align:center;
      font-weight:1400;
      font-size:44px;
      letter-spacing:.6px;
      margin: 10px 0 6px;
    }
    .bigSub{
      text-align:center;
      color: var(--muted);
      font-weight:1100;
      margin-bottom: 14px;
    }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:520px){ .modalGrid{grid-template-columns:1fr} }
    .modalMini{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(240px 90px at 30% 10%, rgba(255,255,255,.08), transparent 62%),
        rgba(0,0,0,.30);
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .modalMini .k{color:var(--muted);font-weight:1000;font-size:12px}
    .modalMini .v{margin-top:6px;font-weight:1300;font-size:18px}
    .modalBtnRow{
      margin-top: 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .modalBtn{
      padding: 12px 16px;
      border-radius: 12px;
      border:1px solid rgba(212,175,55,.28);
      background: rgba(0,0,0,.30);
      color:#fff;
      font-weight:1200;
      cursor:pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .modalBtn.primary{
      background:
        radial-gradient(240px 80px at 30% 10%, rgba(255,255,255,.40), transparent 62%),
        linear-gradient(180deg, rgba(212,175,55,1), rgba(255,255,255,.82));
      color:#120c00;
      font-weight:1300;
    }
    .modalListCard{
      margin-top:14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.24);
      overflow:hidden;
    }
    .modalListHead{
      padding:10px 12px;
      background: rgba(0,0,0,.32);
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-weight:1200;
    }
    .modalListScroll{
      max-height: 260px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .modalTable{
      width:100%;
      border-collapse:collapse;
      min-width: 520px;
    }
    .modalTable th,.modalTable td{
      padding: 9px 10px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      white-space:nowrap;
      font-weight:1000;
    }
    .modalTable th{font-size:12px;color:var(--muted)}
    @media (max-width:560px){
      .modalTable{min-width: 480px;}
    }
  </style>
</head>

<body>

  <header class="topBanner">
    <div class="bannerInner">
      <div class="brand">
        <img class="logo" src="../assets/image/jvbet-logo.png" alt="JVBET1803">
        <div class="brandTxt">
          <div class="t2">Premium Live Casino</div>
        </div>
      </div>

      <button class="logoutBtn" id="logoutBtn" type="button">
        <span class="ic">üîí</span> Logout
      </button>
    </div>

    <div class="statsBar">
      <div class="statPill">Role: <b class="gold" id="roleName">-</b></div>
      <div class="statPill">Points: <b class="gold" id="pointsShow">0</b></div>
      <div class="statPill statClickable" id="winPill">Win: <b class="gold" id="winShow">0</b></div>
      <div class="statPill statClickable" id="lossPill">Loss: <b class="gold" id="lossShow">0</b></div>
    </div>

    <div class="tabsRow">
      <button class="tabBtn active" data-tab="dt" type="button"><span class="ico">üêâ</span> Dragon</button>
      <button class="tabBtn" data-tab="tp" type="button"><span class="ico">üÉè</span> Teen Patti</button>
      <button class="tabBtn" data-tab="rl" type="button"><span class="ico">üé°</span> Roulette</button>
      <button class="tabBtn" data-tab="hist" type="button"><span class="ico">üìú</span> History</button>
    </div>
  </header>

  <main class="wrap">

    <!-- ================= DRAGON TIGER ================= -->
    <section class="panel active" id="dt">
      <div class="sectionBar">
        <div class="title">üêâ Dragon Tiger</div>
        <div class="badgeLive">üé• Live <span class="gold" id="dtView">üëÅ 124</span></div>
      </div>

      <div class="gameShell">
        <div class="gameGrid">
          <div class="liveWrap">
            <div class="liveTopLeft"><span class="dot"></span> LIVE</div>

            <div class="lockedOverlay" id="dtOverlay">
              <div class="lockedCard">
                <div class="t">üîí Bets Locked</div>
                <div class="s">Play only when timer &gt; <span class="gold">15</span> sec</div>
                <div class="lockedRow">
                  <div class="miniPill">Round: <span class="gold" id="dtOverlayRound">-</span></div>
                  <div class="miniPill">Time left: <span class="gold" id="dtOverlayTimer">0</span>s</div>
                </div>
              </div>
            </div>

            <video class="video" autoplay loop muted playsinline>
              <source src="../assets/video/dealer_loop.mp4" type="video/mp4">
            </video>
          </div>

          <aside class="sideControls">
            <div class="timerLine">
              <div class="progressOuter">
                <div class="timerText">‚è≥ Round ends in: <span class="gold" id="dtTimer">30</span>s</div>
                <div class="progressBar"><div class="progressFill" id="dtFill"></div></div>
              </div>
              <div class="statusPill">Round: <span class="gold" id="dtRound">-</span></div>
              <div class="statusPill lockOpen" id="dtLock">OPEN</div>
            </div>

            <div class="betRow cols4" id="dtBets">
              <div class="betBox active" data-pick="DRAGON"><div class="betName">Dragon</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="TIGER"><div class="betName">Tiger</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="TIE"><div class="betName">Tie</div><div class="betMul">Refund</div></div>
              <div class="betBox" data-pick="REFUND"><div class="betName">Refund</div><div class="betMul">‚Äî</div></div>
            </div>

            <div class="stakeRow">
              <input class="stakeInput" id="dtStake" type="number" inputmode="numeric" placeholder="Enter Bet" />
              <button class="placeBtn" id="dtPlay" type="button">Place Bet</button>
            </div>

            <div class="chipBar" id="dtChips">
              <div class="chip goldChip" data-v="50">50</div>
              <div class="chip" data-v="100">100</div>
              <div class="chip" data-v="500">500</div>
              <div class="chip" data-v="1000">1000</div>
              <div class="chip" data-v="5000">5000</div>
            </div>

            <div class="stakeRow" style="justify-content:space-between;">
              <div class="muted">Latest Result:</div>
              <div id="dtPrev" class="muted">No result</div>
            </div>

            <div class="stakeRow" style="padding-top:0;">
              <div class="muted" style="flex:1">Selected:</div>
              <div class="gold" id="dtPickShow">DRAGON</div>
            </div>

            <div class="stakeRow" style="padding-top:0; border-bottom:none;">
              <div class="muted" style="flex:1">Message:</div>
              <div class="gold" id="dtMsg">-</div>
            </div>
          </aside>
        </div>
      </div>

      <!-- OPTION 1: Last 10 table BELOW -->
      <div class="tableCard">
        <div class="tableHead">
          <div class="h">üßæ Last 10 Bets (Dragon Tiger)</div>
          <div class="tableActions"><span class="muted" id="dtWait"></span></div>
        </div>

        <div class="scroll">
          <table class="table" id="dtPast">
            <thead><tr><th>Time</th><th>Pick</th><th>Points</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="miniGrid">
          <div class="miniCard">
            <div class="miniHead">
              <div>üìå Last 5 Results</div>
              <div class="miniSub" id="dtLast5Sub">-</div>
            </div>
            <div class="miniBody">
              <table class="miniTable">
                <thead><tr><th>Seq</th><th>Result</th></tr></thead>
                <tbody id="dtLast5Body"></tbody>
              </table>
            </div>
          </div>

          <div class="miniCard">
            <div class="miniHead">
              <div>üôã My Bet</div>
              <div class="statusTag" id="dtMyBetStatus">-</div>
            </div>
            <div class="miniBody">
              <div class="miniSub" id="dtMyBetSub">-</div>
              <table class="miniTable" style="margin-top:8px">
                <thead><tr><th>Pick</th><th>Points</th></tr></thead>
                <tbody id="dtMyBetBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= TEEN PATTI ================= -->
    <section class="panel" id="tp">
      <div class="sectionBar">
        <div class="title">üÉè Teen Patti</div>
        <div class="badgeLive">üé• Live <span class="gold" id="tpView">üëÅ 212</span></div>
      </div>

      <div class="gameShell">
        <div class="gameGrid">
          <div class="liveWrap">
            <div class="liveTopLeft"><span class="dot"></span> LIVE</div>

            <div class="lockedOverlay" id="tpOverlay">
              <div class="lockedCard">
                <div class="t">üîí Bets Locked</div>
                <div class="s">Play only when timer &gt; <span class="gold">15</span> sec</div>
                <div class="lockedRow">
                  <div class="miniPill">Round: <span class="gold" id="tpOverlayRound">-</span></div>
                  <div class="miniPill">Time left: <span class="gold" id="tpOverlayTimer">0</span>s</div>
                </div>
              </div>
            </div>

            <video class="video" autoplay loop muted playsinline>
              <source src="../assets/video/teen-patti.mp4" type="video/mp4">
            </video>
          </div>

          <aside class="sideControls">
            <div class="timerLine">
              <div class="progressOuter">
                <div class="timerText">‚è≥ Round ends in: <span class="gold" id="tpTimer">30</span>s</div>
                <div class="progressBar"><div class="progressFill" id="tpFill"></div></div>
              </div>
              <div class="statusPill">Round: <span class="gold" id="tpRound">-</span></div>
              <div class="statusPill lockOpen" id="tpLock">OPEN</div>
              <div class="statusPill">Selected: <span class="gold" id="tpPickShow">PLAYER</span></div>
            </div>

            <div class="betRow cols3" id="tpBets">
              <div class="betBox active" data-pick="PLAYER"><div class="betName">Player</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="BANKER"><div class="betName">Banker</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="TIE"><div class="betName">Tie</div><div class="betMul">Refund</div></div>
            </div>

            <div class="stakeRow">
              <input class="stakeInput" id="tpStake" type="number" inputmode="numeric" placeholder="Enter points" />
              <button class="placeBtn" id="tpPlay" type="button">Place Bet</button>
            </div>

            <div class="chipBar" id="tpChips">
              <div class="chip goldChip" data-v="50">50</div>
              <div class="chip" data-v="100">100</div>
              <div class="chip" data-v="500">500</div>
              <div class="chip" data-v="1000">1000</div>
              <div class="chip" data-v="5000">5000</div>
            </div>

            <div class="stakeRow" style="justify-content:space-between;">
              <div class="muted">Latest Result:</div>
              <div id="tpPrev" class="muted">No result</div>
            </div>

            <div class="stakeRow" style="padding-top:0; border-bottom:none;">
              <div class="muted" style="flex:1">Message:</div>
              <div class="gold" id="tpMsg">-</div>
            </div>

            <div style="display:none">
              <span id="tpPickShow2">PLAYER</span>
              <span id="tpRound2">-</span>
            </div>
          </aside>
        </div>
      </div>

      <!-- OPTION 1: Last 10 table BELOW -->
      <div class="tableCard">
        <div class="tableHead">
          <div class="h">üßæ Last 10 Bets (Teen Patti)</div>
          <div class="tableActions"><span class="muted" id="tpWait"></span></div>
        </div>

        <div class="scroll">
          <table class="table" id="tpPast">
            <thead><tr><th>Time</th><th>Pick</th><th>Points</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="miniGrid">
          <div class="miniCard">
            <div class="miniHead">
              <div>üìå Last 5 Results</div>
              <div class="miniSub" id="tpLast5Sub">-</div>
            </div>
            <div class="miniBody">
              <table class="miniTable">
                <thead><tr><th>Seq</th><th>Result</th></tr></thead>
                <tbody id="tpLast5Body"></tbody>
              </table>
            </div>
          </div>

          <div class="miniCard">
            <div class="miniHead">
              <div>üôã My Bet</div>
              <div class="statusTag" id="tpMyBetStatus">-</div>
            </div>
            <div class="miniBody">
              <div class="miniSub" id="tpMyBetSub">-</div>
              <table class="miniTable" style="margin-top:8px">
                <thead><tr><th>Pick</th><th>Points</th></tr></thead>
                <tbody id="tpMyBetBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= ROULETTE ================= -->
    <section class="panel" id="rl">
      <div class="sectionBar">
        <div class="title">üé° Roulette</div>
        <div class="badgeLive">üé• Live <span class="gold" id="rView">üëÅ 156</span></div>
      </div>

      <div class="gameShell">
        <div class="gameGrid">
          <div class="liveWrap">
            <div class="liveTopLeft"><span class="dot"></span> LIVE</div>

            <div class="lockedOverlay" id="rOverlay">
              <div class="lockedCard">
                <div class="t">üîí Bets Locked</div>
                <div class="s">Play only when timer &gt; <span class="gold">15</span> sec</div>
                <div class="lockedRow">
                  <div class="miniPill">Round: <span class="gold" id="rOverlayRound">-</span></div>
                  <div class="miniPill">Time left: <span class="gold" id="rOverlayTimer">0</span>s</div>
                </div>
              </div>
            </div>

            <video class="video" autoplay loop muted playsinline>
              <source src="../assets/video/Roulette_.mp4" type="video/mp4">
            </video>
          </div>

          <aside class="sideControls">
            <div class="timerLine">
              <div class="progressOuter">
                <div class="timerText">‚è≥ Round ends in: <span class="gold" id="rTimer">30</span>s</div>
                <div class="progressBar"><div class="progressFill" id="rFill"></div></div>
              </div>
              <div class="statusPill">Round: <span class="gold" id="rRound">-</span></div>
              <div class="statusPill lockOpen" id="rLock">OPEN</div>
              <div class="statusPill">Selected: <span class="gold" id="rPickShow">RED</span></div>
            </div>

            <div class="betRow cols2" id="rBets">
              <div class="betBox active" data-pick="RED"><div class="betName">Red</div><div class="betMul">2x</div></div>
              <div class="betBox" data-pick="BLACK"><div class="betName">Black</div><div class="betMul">2x</div></div>
            </div>

            <div class="stakeRow">
              <input class="stakeInput" id="rStake" type="number" inputmode="numeric" placeholder="Enter points" />
              <button class="placeBtn" id="rPlay" type="button">Place Bet</button>
            </div>

            <div class="chipBar" id="rChips">
              <div class="chip goldChip" data-v="50">50</div>
              <div class="chip" data-v="100">100</div>
              <div class="chip" data-v="500">500</div>
              <div class="chip" data-v="1000">1000</div>
              <div class="chip" data-v="5000">5000</div>
            </div>

            <div class="stakeRow" style="justify-content:space-between;">
              <div class="muted">Latest Result:</div>
              <div id="rPrev" class="muted">No result</div>
            </div>

            <div class="stakeRow" style="padding-top:0; border-bottom:none;">
              <div class="muted" style="flex:1">Message:</div>
              <div class="gold" id="rMsg">-</div>
            </div>
          </aside>
        </div>
      </div>

      <!-- OPTION 1: Last 10 table BELOW -->
      <div class="tableCard">
        <div class="tableHead">
          <div class="h">üßæ Last 10 Bets (Roulette)</div>
          <div class="tableActions"><span class="muted" id="rWait"></span></div>
        </div>

        <div class="scroll">
          <table class="table" id="rPast">
            <thead><tr><th>Time</th><th>Pick</th><th>Points</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="miniGrid">
          <div class="miniCard">
            <div class="miniHead">
              <div>üìå Last 5 Results</div>
              <div class="miniSub" id="rLast5Sub">-</div>
            </div>
            <div class="miniBody">
              <table class="miniTable">
                <thead><tr><th>Seq</th><th>Result</th></tr></thead>
                <tbody id="rLast5Body"></tbody>
              </table>
            </div>
          </div>

          <div class="miniCard">
            <div class="miniHead">
              <div>üôã My Bet</div>
              <div class="statusTag" id="rMyBetStatus">-</div>
            </div>
            <div class="miniBody">
              <div class="miniSub" id="rMyBetSub">-</div>
              <table class="miniTable" style="margin-top:8px">
                <thead><tr><th>Pick</th><th>Points</th></tr></thead>
                <tbody id="rMyBetBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= HISTORY ================= -->
    <section class="panel" id="hist">
      <div class="sectionBar">
        <div class="title">üìú History</div>
        <div class="badgeLive">All Bets</div>
      </div>

      <div class="tableCard" style="margin-top:12px;">
        <div class="tableHead">
          <div class="h">üìú Full Play History</div>
          <div class="tableActions"><span class="muted" id="histInfo"></span></div>
        </div>
        <div class="scroll" style="max-height:420px">
          <table class="table" id="bh">
            <thead>
              <tr><th>Time</th><th>Game</th><th>Pick</th><th>Points</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- OLD compat ids -->
    <div style="display:none">
      <span id="cid">-</span>
      <span id="pts">0</span>
      <span id="w">0</span>
      <span id="l">0</span>
    </div>

  </main>

  <nav class="bottomBar" aria-label="Bottom navigation">
    <div class="bottomInner">
      <button class="bBtn active" data-tab="dt" type="button"><div class="i">üêâ</div><div class="t">Dragon</div></button>
      <button class="bBtn" data-tab="tp" type="button"><div class="i">üÉè</div><div class="t">Teen Patti</div></button>
      <button class="bBtn" data-tab="rl" type="button"><div class="i">üé°</div><div class="t">Roulette</div></button>
      <button class="bBtn" data-tab="hist" type="button"><div class="i">üìú</div><div class="t">History</div></button>
    </div>
  </nav>

  <div class="toast" id="toast">
    <div class="t" id="toastTitle">-</div>
    <div class="muted" id="toastBody">-</div>
  </div>

  <!-- ===== WIN/LOSS POPUP ===== -->
  <div class="modalBack" id="wlModal">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="wlTitle">
      <div class="modalHead">
        <div class="modalTitle" id="wlTitle">üìä Stats</div>
        <button class="modalClose" id="wlClose" type="button">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="bigCount" id="wlBig">0</div>
        <div class="bigSub" id="wlSub">-</div>

        <div class="modalGrid">
          <div class="modalMini">
            <div class="k">Total Bets (last 200)</div>
            <div class="v" id="wlTotal">0</div>
          </div>
          <div class="modalMini">
            <div class="k">Win Rate</div>
            <div class="v" id="wlRate">0%</div>
          </div>
          <div class="modalMini">
            <div class="k">Pending Bets</div>
            <div class="v" id="wlPending">0</div>
          </div>
          <div class="modalMini">
            <div class="k">Points</div>
            <div class="v gold" id="wlPoints">0</div>
          </div>
        </div>

        <div class="modalBtnRow">
          <button class="modalBtn" id="wlShowWin" type="button">Show WIN Bets</button>
          <button class="modalBtn" id="wlShowLoss" type="button">Show LOSS Bets</button>
          <button class="modalBtn primary" id="wlGoHistory" type="button">Open History Tab</button>
        </div>

        <div class="modalListCard">
          <div class="modalListHead">
            <div id="wlListTitle">Latest Bets</div>
            <div class="muted" id="wlListInfo"></div>
          </div>
          <div class="modalListScroll">
            <table class="modalTable" id="wlTable">
              <thead><tr><th>Time</th><th>Game</th><th>Pick</th><th>Points</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ===== RESULT POPUP (AUTO on round end) ===== -->
  <div class="modalBack" id="resModal">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="resTitle">
      <div class="modalHead">
        <div class="modalTitle" id="resTitle">üèÅ Round Result</div>
        <button class="modalClose" id="resClose" type="button">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="bigCount" id="resBig">-</div>
        <div class="bigSub" id="resSub">-</div>

        <div class="modalGrid" id="resGrid"></div>

        <div class="modalBtnRow">
          <button class="modalBtn primary" id="resOk" type="button">OK</button>
          <button class="modalBtn" id="resGoHistory" type="button">Open History</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

  <script>
    /* ========= TAB SYNC (top + bottom) ========= */
    function setTab(tabId){
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
      document.querySelectorAll(".bBtn").forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
      document.querySelectorAll(".panel").forEach(p => p.classList.toggle("active", p.id === tabId));
      if (tabId === "hist") renderHistoryLive();
      try{ window.scrollTo({top:0, behavior:"smooth"}); }catch(e){}
    }
    document.querySelectorAll(".tabBtn").forEach(b => b.addEventListener("click", ()=> setTab(b.dataset.tab)));
    document.querySelectorAll(".bBtn").forEach(b => b.addEventListener("click", ()=> setTab(b.dataset.tab)));

    function showToast(title, body) {
      const t = document.getElementById("toast");
      if (!t) return;
      t.className = "toast show";
      document.getElementById("toastTitle").textContent = title || "";
      document.getElementById("toastBody").textContent = body || "";
      setTimeout(() => t.className = "toast", 2200);
    }
    function vib(ms) { try { if (navigator.vibrate) navigator.vibrate(ms); } catch (e) {} }
    function qs(id){ return document.getElementById(id); }

    /* ================= FIREBASE INIT ================= */
    firebase.initializeApp({
      apiKey: "AIzaSyCAFH5_1RjVHyZLwkj26zQPCq0-8S0fSKA",
      authDomain: "jvbet-bbf90.firebaseapp.com",
      projectId: "jvbet-bbf90",
      storageBucket: "jvbet-bbf90.appspot.com",
      messagingSenderId: "824871692224",
      appId: "1:824871692224:web:f74baa642b1f43b78aca25"
    });
    const db = firebase.firestore();

    /* ================= SESSION + STORAGE ================= */
    const K_SESSION_A = "jvbet_session";
    const K_SESSION_B = "jvbet_session_v1";
    function loadJSON(k, f) { try { const r = localStorage.getItem(k); return r ? JSON.parse(r) : f; } catch (e) { return f; } }
    function getSession() { return loadJSON(K_SESSION_A, null) || loadJSON(K_SESSION_B, null); }
    function clearSession() { localStorage.removeItem(K_SESSION_A); localStorage.removeItem(K_SESSION_B); }
    function logout() { clearSession(); location.href = "../index.html"; }
    qs("logoutBtn").addEventListener("click", logout);
    function fmtDate(ts) { return new Date(ts || Date.now()).toLocaleString(); }

    /* ================= BET BOXES + CHIPS ================= */
    function bindBetBoxes(containerId, showId, showId2) {
      const cont = qs(containerId);
      const show = qs(showId);
      const show2 = showId2 ? qs(showId2) : null;
      if (!cont || !show) return () => "";

      let active = cont.querySelector(".betBox.active");
      let pick = (active && active.dataset && active.dataset.pick) ? active.dataset.pick : "";
      show.textContent = pick;
      if (show2) show2.textContent = pick;

      cont.querySelectorAll(".betBox").forEach(box => {
        box.addEventListener("click", () => {
          cont.querySelectorAll(".betBox").forEach(b => b.classList.remove("active"));
          box.classList.add("active");
          pick = box.dataset.pick || "";
          show.textContent = pick;
          if (show2) show2.textContent = pick;
        });
      });
      return () => pick;
    }
    function bindChips(scopeEl, inputEl) {
      if (!scopeEl || !inputEl) return;
      scopeEl.querySelectorAll(".chip").forEach(ch => {
        if (ch.dataset.bound === "1") return;
        ch.dataset.bound = "1";
        ch.addEventListener("click", () => {
          const v = Number(ch.dataset.v || 0);
          inputEl.value = Number(inputEl.value || 0) + v;
        });
      });
    }

    const getDTPick = bindBetBoxes("dtBets", "dtPickShow");
    const dtStake = qs("dtStake");
    bindChips(qs("dtChips"), dtStake);

    const getTPPick = bindBetBoxes("tpBets", "tpPickShow", "tpPickShow2");
    const tpStake = qs("tpStake");
    bindChips(qs("tpChips"), tpStake);

    const getRPick = bindBetBoxes("rBets", "rPickShow");
    const rStake = qs("rStake");
    bindChips(qs("rChips"), rStake);

    /* ================= CONSTANTS ================= */
    const TOTAL_SEC = 30;
    const LOCK_REMAINING = 15;
    const START_SEQ = { DragonTiger: 282, TeenPatti: 500, Roulette: 900 };

    const GAME_DOC = (g) => db.collection("gameState").doc(g);
    const USERS = db.collection("users");
    const BETS = db.collection("bets");

    /* ================= STATE ================= */
    let ME_ID = null;
    let ME_USER = null;
    const state = { DragonTiger: null, TeenPatti: null, Roulette: null };

    /* ================= ROUND ID (YYYYMMDDHHMMSS_###) ================= */
    function pad2(n) { return String(n).padStart(2, "0"); }
    function pad3(n) { return String(n).padStart(3, "0"); }
    function ymdhms(d) {
      return d.getFullYear()
        + pad2(d.getMonth() + 1)
        + pad2(d.getDate())
        + pad2(d.getHours())
        + pad2(d.getMinutes())
        + pad2(d.getSeconds());
    }
    function makeRoundIdFromSeq(seq) {
      return ymdhms(new Date()) + "_" + pad3(Number(seq || 0));
    }

    /* ================= UI HELPERS ================= */
    function setLock(el, stateStr) {
      if (!el) return;
      el.classList.remove("lockOpen", "lockPlaced", "lockLocked", "lockClosed");
      if (stateStr === "OPEN") { el.classList.add("lockOpen"); el.textContent = "OPEN"; }
      else if (stateStr === "PLACED") { el.classList.add("lockPlaced"); el.textContent = "PLAYED"; }
      else if (stateStr === "LOCKED") { el.classList.add("lockLocked"); el.textContent = "LOCKED"; }
      else { el.classList.add("lockClosed"); el.textContent = "CLOSED"; }
    }

    function setLockedOverlay(gameKey, show, roundId, left){
      const map = {
        DragonTiger: { box:"dtOverlay", rid:"dtOverlayRound", t:"dtOverlayTimer" },
        TeenPatti:   { box:"tpOverlay", rid:"tpOverlayRound", t:"tpOverlayTimer" },
        Roulette:    { box:"rOverlay",  rid:"rOverlayRound",  t:"rOverlayTimer"  }
      };
      const m = map[gameKey];
      if(!m) return;
      const box = qs(m.box);
      const rid = qs(m.rid);
      const tt  = qs(m.t);
      if(rid) rid.textContent = roundId || "-";
      if(tt) tt.textContent = String(Math.max(0, Number(left || 0)));
      if(box) box.classList.toggle("show", !!show);
    }

    /* ================= USER DEFAULTS + TOP STATS ================= */
    async function ensureUserDefaults() {
      const ref = USERS.doc(ME_ID);
      const doc = await ref.get();
      if (!doc.exists) throw new Error("User not found");
      const data = doc.data() || {};
      const patch = {};
      if (typeof data.points !== "number") patch.points = 0;
      if (typeof data.isBlocked !== "boolean") patch.isBlocked = false;
      if (!data.clientId) patch.clientId = ME_ID;
      if (!data.role) patch.role = data.isAdmin ? "admin" : "user";
      if (Object.keys(patch).length) await ref.set(patch, { merge: true });
    }

    async function calcWinLoss() {
      const qsnap = await BETS.where("clientId", "==", ME_ID).orderBy("at", "desc").limit(200).get();
      let w = 0, l = 0;
      qsnap.forEach(doc => {
        const b = doc.data() || {};
        if (b.result === "WIN") w++;
        else if (b.result === "LOSS") l++;
      });
      return { win: w, loss: l };
    }

    async function refreshTop() {
      const snap = await USERS.doc(ME_ID).get();
      if (!snap.exists) return logout();
      ME_USER = snap.data() || {};

      // old hidden compat
      qs("cid").textContent = ME_ID;
      qs("pts").textContent = Number(ME_USER.points || 0);

      // visible
      qs("roleName").textContent = String(ME_USER.role || (ME_USER.isAdmin ? "admin" : "user"));
      qs("pointsShow").textContent = String(Number(ME_USER.points || 0));

      const wl = await calcWinLoss();
      qs("w").textContent = wl.win;
      qs("l").textContent = wl.loss;

      qs("winShow").textContent = String(wl.win);
      qs("lossShow").textContent = String(wl.loss);
    }

    /* ================= RNG ================= */
    function randCard() { return 1 + Math.floor(Math.random() * 13); }
    function cardStr(v) { return (v === 1 ? "A" : v === 11 ? "J" : v === 12 ? "Q" : v === 13 ? "K" : String(v)); }
    function drawDT() {
      const d = randCard(), t = randCard();
      const res = (d === t) ? "TIE" : (d > t ? "DRAGON" : "TIGER");
      return { d, t, res };
    }
    function drawTP() { return { res: ["PLAYER", "BANKER", "TIE"][Math.floor(Math.random() * 3)] }; }
    function drawR() {
      const n = Math.floor(Math.random() * 37);
      const c = (n === 0) ? "GREEN" : (n % 2 === 0 ? "BLACK" : "RED");
      return { n, color: c, res: (c + " " + n) };
    }

    /* ================= gameState INIT / PATCH (old or fresh) ================= */
    async function ensureGameDocExists(game) {
      const ref = GAME_DOC(game);
      const snap = await ref.get();
      const now = Date.now();

      if (!snap.exists) {
        const seq = START_SEQ[game];
        const startedAt = now;
        await ref.set({
          seq,
          roundId: makeRoundIdFromSeq(seq),
          startedAt,
          endsAt: startedAt + TOTAL_SEC * 1000,
          lockAt: startedAt + LOCK_REMAINING * 1000,
          status: "OPEN",
          result: null,
          payload: null,
          last5: [],
          nextStarted: false
        }, { merge: true });
        return;
      }

      const g = snap.data() || {};
      const patch = {};
      if (typeof g.seq !== "number") patch.seq = START_SEQ[game];
      if (!g.roundId) patch.roundId = makeRoundIdFromSeq((typeof g.seq === "number") ? g.seq : START_SEQ[game]);
      if (typeof g.startedAt !== "number") patch.startedAt = now;
      if (typeof g.endsAt !== "number") patch.endsAt = now + TOTAL_SEC * 1000;
      if (typeof g.lockAt !== "number") patch.lockAt = now + LOCK_REMAINING * 1000;
      if (typeof g.nextStarted !== "boolean") patch.nextStarted = false;
      if (!Array.isArray(g.last5)) patch.last5 = [];

      if (Object.keys(patch).length) await ref.set(patch, { merge: true });
    }

    function secondsLeftFromDoc(doc) {
      const endsAt = Number(doc?.endsAt || 0);
      return Math.ceil((endsAt - Date.now()) / 1000);
    }
    function statusFromDoc(doc) {
      const left = secondsLeftFromDoc(doc);
      if (left <= 0) return "CLOSED";
      if (left <= LOCK_REMAINING) return "LOCKED";
      return "OPEN";
    }

    /* ================= FINALIZE + NEXT ROUND ================= */
    async function finalizeIfNeeded(game) {
      const ref = GAME_DOC(game);

      return db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists) return;

        const g = snap.data() || {};
        const left = Math.ceil((Number(g.endsAt || 0) - Date.now()) / 1000);
        if (left > 0) return;

        const currentSeq = (typeof g.seq === "number") ? g.seq : START_SEQ[game];

        if (!g.result) {
          let result = null;
          let payload = null;

          if (game === "DragonTiger") {
            const d = drawDT();
            result = d.res;
            payload = { d: cardStr(d.d), t: cardStr(d.t), res: d.res };
          } else if (game === "TeenPatti") {
            const d = drawTP();
            result = d.res;
            payload = { res: d.res };
          } else {
            const d = drawR();
            result = d.res;
            payload = { color: d.color, n: d.n, res: d.res };
          }

          const now = Date.now();
          const entry = { roundId: g.roundId, seq: currentSeq, result, time: now };
          const old = Array.isArray(g.last5) ? g.last5 : [];
          const cleaned = old.filter(x => x && x.roundId !== g.roundId);
          cleaned.unshift(entry);
          const last5 = cleaned.slice(0, 5);

          tx.set(ref, {
            status: "CLOSED",
            result,
            payload,
            last5,
            resultAt: now,
            nextStarted: false
          }, { merge: true });

          return;
        }

        if (g.result && !g.nextStarted) {
          const now = Date.now();
          const nextSeq = currentSeq + 1;

          tx.set(ref, {
            seq: nextSeq,
            roundId: makeRoundIdFromSeq(nextSeq),
            startedAt: now,
            endsAt: now + TOTAL_SEC * 1000,
            lockAt: now + LOCK_REMAINING * 1000,
            status: "OPEN",
            result: null,
            payload: null,
            nextStarted: true
          }, { merge: true });
        }
      });
    }

    /* ================= BETS ================= */
    async function placeBetFS({ game, pick, stake, roundId, seq }) {
      stake = Number(stake || 0);
      if (!stake || stake <= 0) throw new Error("Enter valid points");
      if (Number(ME_USER?.points || 0) < stake) throw new Error("Not enough points");

      const betKey = ME_ID + "_" + game + "_" + roundId;
      const ref = BETS.doc(betKey);

      await db.runTransaction(async (tx) => {
        const bSnap = await tx.get(ref);
        if (bSnap.exists) throw new Error("Already played");

        tx.set(USERS.doc(ME_ID), {
          points: firebase.firestore.FieldValue.increment(-stake)
        }, { merge: true });

        tx.set(ref, {
          betId: betKey,
          clientId: ME_ID,
          game,
          pick,
          stake,
          roundId,
          seq,
          at: Date.now(),
          result: "PENDING",
          settled: false
        }, { merge: true });
      });
    }

    async function settleMyBetIfNeeded(game, gameDoc) {
      if (!gameDoc?.result) return;

      const betKey = ME_ID + "_" + game + "_" + gameDoc.roundId;
      const ref = BETS.doc(betKey);

      await db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists) return;
        const b = snap.data() || {};
        if (b.settled) return;

        let out = "LOSS";

        if (game === "Roulette") {
          const color = String(gameDoc.payload?.color || "").toUpperCase();
          out = (String(b.pick).toUpperCase() === color) ? "WIN" : "LOSS";
        } else {
          if (String(gameDoc.result) === "TIE") out = "TIE";
          else out = (String(b.pick) === String(gameDoc.result)) ? "WIN" : "LOSS";
        }

        if (out === "WIN") {
          tx.set(USERS.doc(ME_ID), {
            points: firebase.firestore.FieldValue.increment(Number(b.stake || 0) * 2)
          }, { merge: true });
        } else if (out === "TIE") {
          tx.set(USERS.doc(ME_ID), {
            points: firebase.firestore.FieldValue.increment(Number(b.stake || 0))
          }, { merge: true });
        }

        tx.set(ref, {
          result: out,
          settled: true,
          settledAt: Date.now(),
          roundResult: gameDoc.result
        }, { merge: true });
      });

      await refreshTop();
    }

    /* ================= TABLES ================= */
    async function setPastTable(game, tableId, waitId) {
      const tb = document.querySelector("#" + tableId + " tbody");
      const w = qs(waitId);

      const qsnap = await BETS.where("clientId", "==", ME_ID)
        .where("game", "==", game)
        .orderBy("at", "desc").limit(10).get();

      const arr = [];
      qsnap.forEach(d => arr.push(d.data() || {}));
      const pending = arr.filter(b => b.result === "PENDING").length;
      if (w) w.textContent = pending ? ("Pending bets: " + pending) : "";

      if (!tb) return;
      tb.innerHTML = arr.map(b => (
        "<tr>" +
          "<td>" + fmtDate(b.at) + "</td>" +
          "<td>" + (b.pick || "-") + "</td>" +
          "<td class='gold'>" + Number(b.stake || 0) + "</td>" +
          "<td>" + (b.result || "-") + "</td>" +
        "</tr>"
      )).join("") || "<tr><td colspan='4' class='muted'>No bets yet</td></tr>";
    }

    let histUnsub = null;
    function renderHistoryLive(){
      if (histUnsub) { try{histUnsub();}catch(e){} histUnsub=null; }
      const tb = document.querySelector("#bh tbody");
      const info = qs("histInfo");
      if (!tb) return;

      histUnsub = BETS.where("clientId","==",ME_ID).orderBy("at","desc").limit(200)
        .onSnapshot((snap)=>{
          const arr=[];
          snap.forEach(d=>arr.push(d.data()||{}));
          if(info) info.textContent = arr.length ? ("Showing last " + arr.length) : "";
          tb.innerHTML = arr.map(b => (
            "<tr>" +
              "<td>" + fmtDate(b.at) + "</td>" +
              "<td>" + (b.game || "-") + "</td>" +
              "<td>" + (b.pick || "-") + "</td>" +
              "<td class='gold'>" + Number(b.stake || 0) + "</td>" +
              "<td>" + (b.result || "-") + "</td>" +
            "</tr>"
          )).join("") || "<tr><td colspan='5' class='muted'>No history</td></tr>";
        });
    }

    function renderLatestResult(game, gameDoc) {
      const elId = (game === "DragonTiger") ? "dtPrev" : (game === "TeenPatti") ? "tpPrev" : "rPrev";
      const el = qs(elId);
      if (!el) return;
      const v = String(gameDoc?.result || "");
      el.innerHTML = v ? ('<span class="gold">' + v + '</span>') : '<span class="muted">No result</span>';
    }

    /* ================= LAST5 RENDER ================= */
    function renderLast5(game, gdoc) {
      const arr = Array.isArray(gdoc?.last5) ? gdoc.last5 : [];
      const rows = arr.slice(0,5);

      let subId = "dtLast5Sub", bodyId = "dtLast5Body";
      if (game === "TeenPatti") { subId = "tpLast5Sub"; bodyId = "tpLast5Body"; }
      if (game === "Roulette") { subId = "rLast5Sub";  bodyId = "rLast5Body"; }

      const sub = qs(subId);
      const body = qs(bodyId);
      if (sub) sub.textContent = rows.length ? ("Rounds: " + rows.length) : "No data";
      if (!body) return;

      body.innerHTML = rows.map(x => (
        "<tr>" +
          "<td class='gold'>" + (typeof x.seq === "number" ? x.seq : "-") + "</td>" +
          "<td>" + (x.result || "-") + "</td>" +
        "</tr>"
      )).join("") || "<tr><td colspan='2' class='muted'>No results yet</td></tr>";
    }

    /* ================= MY BET LIVE ================= */
    const myBetUnsub = { DragonTiger:null, TeenPatti:null, Roulette:null };
    function setMyBetUI(game, bet, roundId){
      let subId="dtMyBetSub", stId="dtMyBetStatus", bodyId="dtMyBetBody";
      if (game === "TeenPatti") { subId="tpMyBetSub"; stId="tpMyBetStatus"; bodyId="tpMyBetBody"; }
      if (game === "Roulette")  { subId="rMyBetSub";  stId="rMyBetStatus";  bodyId="rMyBetBody";  }

      const sub = qs(subId);
      const st  = qs(stId);
      const bd  = qs(bodyId);

      if (!bet) {
        if (sub) sub.textContent = "Round: " + (roundId || "-");
        if (st) st.textContent = "NO BET";
        if (bd) bd.innerHTML = "<tr><td colspan='2' class='muted'>Not played</td></tr>";
        return;
      }

      if (sub) sub.textContent = "Round: " + (bet.roundId || roundId || "-");
      if (st) st.textContent = (bet.result || "PENDING");
      if (bd) bd.innerHTML =
        "<tr><td>" + (bet.pick || "-") + "</td><td class='gold'>" + Number(bet.stake || 0) + "</td></tr>";
    }

    function watchMyBet(game, roundId){
      if (myBetUnsub[game]) { try{ myBetUnsub[game](); }catch(e){} myBetUnsub[game]=null; }
      const betKey = ME_ID + "_" + game + "_" + roundId;
      myBetUnsub[game] = BETS.doc(betKey).onSnapshot((snap)=>{
        if (!snap.exists) setMyBetUI(game, null, roundId);
        else setMyBetUI(game, snap.data() || null, roundId);
      });
    }

    /* ================= TIMER UI UPDATE ================= */
    function updateTimerUI(game, gameDoc) {
      const left = secondsLeftFromDoc(gameDoc);
      const showLeft = Math.max(0, left);
      const pct = Math.max(0, Math.min(100, (showLeft / TOTAL_SEC) * 100)) + "%";
      const lockState = statusFromDoc(gameDoc);

      if (game === "DragonTiger") {
        qs("dtRound").textContent = gameDoc?.roundId ?? "-";
        qs("dtTimer").textContent = showLeft;
        qs("dtFill").style.width = pct;
        setLock(qs("dtLock"), lockState);
        qs("dtPlay").disabled = (lockState !== "OPEN");
        setLockedOverlay("DragonTiger", lockState === "LOCKED", gameDoc?.roundId, showLeft);
      } else if (game === "TeenPatti") {
        qs("tpRound").textContent = gameDoc?.roundId ?? "-";
        qs("tpRound2").textContent = gameDoc?.roundId ?? "-";
        qs("tpTimer").textContent = showLeft;
        qs("tpFill").style.width = pct;
        setLock(qs("tpLock"), lockState);
        qs("tpPlay").disabled = (lockState !== "OPEN");
        setLockedOverlay("TeenPatti", lockState === "LOCKED", gameDoc?.roundId, showLeft);
      } else {
        qs("rRound").textContent = gameDoc?.roundId ?? "-";
        qs("rTimer").textContent = showLeft;
        qs("rFill").style.width = pct;
        setLock(qs("rLock"), lockState);
        qs("rPlay").disabled = (lockState !== "OPEN");
        setLockedOverlay("Roulette", lockState === "LOCKED", gameDoc?.roundId, showLeft);
      }
    }

    /* ================= RESULT POPUP (AUTO on round end) ================= */
    const lastResultShown = { DragonTiger: null, TeenPatti: null, Roulette: null };

    function openResModal(){ qs("resModal").classList.add("show"); }
    function closeResModal(){ qs("resModal").classList.remove("show"); }

    function outcomeForPopup(game, gameDoc, bet){
      if (!bet) return "NO BET";
      if (bet.result && bet.result !== "PENDING") return bet.result;

      if (game === "Roulette") {
        const color = String(gameDoc?.payload?.color || "").toUpperCase();
        return (String(bet.pick).toUpperCase() === color) ? "WIN" : "LOSS";
      } else {
        if (String(gameDoc?.result) === "TIE") return "TIE";
        return (String(bet.pick) === String(gameDoc?.result)) ? "WIN" : "LOSS";
      }
    }

    function payloadLines(game, g){
      if (game === "DragonTiger") {
        const d = g?.payload?.d || "-";
        const t = g?.payload?.t || "-";
        return ["Dragon Card: " + d, "Tiger Card: " + t];
      }
      if (game === "TeenPatti") {
        const r = g?.payload?.res || g?.result || "-";
        return ["Result: " + r];
      }
      const c = g?.payload?.color || "-";
      const n = (typeof g?.payload?.n === "number") ? g.payload.n : "-";
      return ["Color: " + c, "Number: " + n];
    }

    async function showResultPopup(game, g){
      if (!g?.roundId || !g?.result) return;

      // prevent repeated popups for same round (every snapshot)
      if (lastResultShown[game] === g.roundId) return;
      lastResultShown[game] = g.roundId;

      const niceGame = (game === "DragonTiger") ? "üêâ Dragon Tiger"
                    : (game === "TeenPatti")   ? "üÉè Teen Patti"
                    : "üé° Roulette";

      qs("resTitle").textContent = "üèÅ " + niceGame + " ‚Ä¢ Result";
      qs("resBig").textContent = String(g.result || "-");
      qs("resSub").textContent = "Round: " + String(g.roundId || "-");

      // Load my bet (if any) for this round
      let bet = null;
      try{
        const betKey = ME_ID + "_" + game + "_" + g.roundId;
        const bSnap = await BETS.doc(betKey).get();
        if (bSnap.exists) bet = bSnap.data() || null;
      } catch(e){}

      const out = outcomeForPopup(game, g, bet);
      const pl = payloadLines(game, g);

      const grid = qs("resGrid");
      const betPick = bet?.pick || "-";
      const betStake = Number(bet?.stake || 0);
      const hasBet = !!bet;

      const card = (k,v,isGold) => (
        "<div class='modalMini'>" +
          "<div class='k'>" + k + "</div>" +
          "<div class='v " + (isGold ? "gold" : "") + "'>" + v + "</div>" +
        "</div>"
      );

      grid.innerHTML =
        card("Round ID", String(g.roundId || "-"), false) +
        card("Result", String(g.result || "-"), true) +
        card("Your Bet", hasBet ? (String(betPick) + " (" + betStake + ")") : "No Bet Placed", false) +
        card("Outcome", String(out), (String(out) === "WIN"));

      if (pl && pl.length){
        pl.slice(0,2).forEach((line, idx)=>{
          grid.innerHTML += card("Details " + (idx+1), String(line), false);
        });
      }

      openResModal();
      vib(60);
    }

    qs("resClose").addEventListener("click", closeResModal);
    qs("resOk").addEventListener("click", closeResModal);
    qs("resModal").addEventListener("click", (e)=>{ if(e.target===qs("resModal")) closeResModal(); });
    qs("resGoHistory").addEventListener("click", ()=>{ closeResModal(); setTab("hist"); });

    /* ================= LIVE SUBSCRIBE ================= */
    function subscribeGame(game) {
      return GAME_DOC(game).onSnapshot(async (snap) => {
        if (!snap.exists) return;
        const g = snap.data() || {};
        state[game] = g;

        updateTimerUI(game, g);
        renderLatestResult(game, g);
        renderLast5(game, g);

        if (ME_ID && g.roundId) watchMyBet(game, g.roundId);

        if (g.result) {
          await settleMyBetIfNeeded(game, g);

          if (game === "DragonTiger") qs("dtMsg").textContent = "ROUND RESULT: " + g.result;
          if (game === "TeenPatti")  qs("tpMsg").textContent = "ROUND RESULT: " + g.result;
          if (game === "Roulette")   qs("rMsg").textContent = "ROUND RESULT: " + g.result;

          await showResultPopup(game, g); // ‚úÖ auto big center popup
        }

        if (secondsLeftFromDoc(g) <= 0) await finalizeIfNeeded(game);

        if (game === "DragonTiger") await setPastTable("DragonTiger", "dtPast", "dtWait");
        if (game === "TeenPatti")  await setPastTable("TeenPatti",  "tpPast", "tpWait");
        if (game === "Roulette")   await setPastTable("Roulette",   "rPast",  "rWait");
      });
    }

    /* ================= PLAY BUTTONS ================= */
    qs("dtPlay").addEventListener("click", async () => {
      try {
        const g = state.DragonTiger;
        if (!g) return;
        if (secondsLeftFromDoc(g) <= LOCK_REMAINING) return qs("dtMsg").textContent = "Locked (play only when timer > 15)";
        await placeBetFS({ game:"DragonTiger", pick:getDTPick(), stake:dtStake.value, roundId:g.roundId, seq:g.seq });
        qs("dtMsg").textContent = "PLAY SUBMITTED";
        showToast("üïí SUBMITTED", "Result at 0 sec");
        vib(40);
        await refreshTop();
      } catch (e) { qs("dtMsg").textContent = e.message || String(e); }
    });

    qs("tpPlay").addEventListener("click", async () => {
      try {
        const g = state.TeenPatti;
        if (!g) return;
        if (secondsLeftFromDoc(g) <= LOCK_REMAINING) return qs("tpMsg").textContent = "Locked (play only when timer > 15)";
        await placeBetFS({ game:"TeenPatti", pick:getTPPick(), stake:tpStake.value, roundId:g.roundId, seq:g.seq });
        qs("tpMsg").textContent = "PLAY SUBMITTED";
        showToast("üïí SUBMITTED", "Result at 0 sec");
        vib(40);
        await refreshTop();
      } catch (e) { qs("tpMsg").textContent = e.message || String(e); }
    });

    qs("rPlay").addEventListener("click", async () => {
      try {
        const g = state.Roulette;
        if (!g) return;
        if (secondsLeftFromDoc(g) <= LOCK_REMAINING) return qs("rMsg").textContent = "Locked (play only when timer > 15)";
        await placeBetFS({ game:"Roulette", pick:getRPick(), stake:rStake.value, roundId:g.roundId, seq:g.seq });
        qs("rMsg").textContent = "PLAY SUBMITTED";
        showToast("üïí SUBMITTED", "Result at 0 sec");
        vib(40);
        await refreshTop();
      } catch (e) { qs("rMsg").textContent = e.message || String(e); }
    });

    /* ================= VIEWERS (FAKE) ================= */
    setInterval(() => {
      if (qs("dtView")) qs("dtView").textContent = "üëÅ " + (120 + Math.floor(Math.random() * 25));
      if (qs("tpView")) qs("tpView").textContent = "üëÅ " + (200 + Math.floor(Math.random() * 25));
      if (qs("rView"))  qs("rView").textContent  = "üëÅ " + (150 + Math.floor(Math.random() * 25));
    }, 2500);

    /* ================= WIN/LOSS MODAL (with bet list) ================= */
    function closeWLModal(){ qs("wlModal").classList.remove("show"); }
    function openWLModal(mode){
      qs("wlModal").classList.add("show");
      fillWLModal(mode || "ALL");
    }

    async function loadWLList(mode){
      const tbody = qs("wlTable").querySelector("tbody");
      const info = qs("wlListInfo");
      const title = qs("wlListTitle");

      const snap = await BETS.where("clientId","==",ME_ID).orderBy("at","desc").limit(50).get();
      const arr = [];
      snap.forEach(d=>arr.push(d.data()||{}));

      const filtered = arr.filter(b => (mode==="ALL") ? true : (b.result === mode));
      title.textContent = (mode==="ALL") ? "Latest Bets" : ("Latest " + mode + " Bets");
      if(info) info.textContent = filtered.length ? ("Showing " + filtered.length + " / 50") : "No data";

      tbody.innerHTML = filtered.map(b => (
        "<tr>" +
          "<td>" + fmtDate(b.at) + "</td>" +
          "<td>" + (b.game || "-") + "</td>" +
          "<td>" + (b.pick || "-") + "</td>" +
          "<td class='gold'>" + Number(b.stake || 0) + "</td>" +
          "<td>" + (b.result || "-") + "</td>" +
        "</tr>"
      )).join("") || "<tr><td colspan='5' class='muted'>No bets</td></tr>";
    }

    async function fillWLModal(mode){
      qs("wlPoints").textContent = String(Number(ME_USER?.points || 0));

      const snap = await BETS.where("clientId","==",ME_ID).orderBy("at","desc").limit(200).get();
      let win=0, loss=0, pending=0, tie=0, total=0;

      snap.forEach(d=>{
        const b=d.data()||{};
        total++;
        if(b.result==="WIN") win++;
        else if(b.result==="LOSS") loss++;
        else if(b.result==="PENDING") pending++;
        else if(b.result==="TIE") tie++;
      });

      qs("wlTotal").textContent = String(total);
      qs("wlPending").textContent = String(pending);

      const decided = Math.max(1, (win+loss+tie));
      const rate = Math.round((win/decided)*100);
      qs("wlRate").textContent = String(rate) + "%";

      if(mode==="WIN"){
        qs("wlTitle").textContent = "‚úÖ WIN Stats";
        qs("wlBig").textContent = String(win);
        qs("wlSub").textContent = "Total WIN bets (last 200)";
        await loadWLList("WIN");
      } else if(mode==="LOSS"){
        qs("wlTitle").textContent = "‚ùå LOSS Stats";
        qs("wlBig").textContent = String(loss);
        qs("wlSub").textContent = "Total LOSS bets (last 200)";
        await loadWLList("LOSS");
      } else {
        qs("wlTitle").textContent = "üìä Stats";
        qs("wlBig").textContent = String(total);
        qs("wlSub").textContent = "Total bets (last 200)";
        await loadWLList("ALL");
      }
    }

    qs("winPill").addEventListener("click", ()=> openWLModal("WIN"));
    qs("lossPill").addEventListener("click", ()=> openWLModal("LOSS"));
    qs("wlClose").addEventListener("click", closeWLModal);
    qs("wlModal").addEventListener("click", (e)=>{ if(e.target===qs("wlModal")) closeWLModal(); });
    document.addEventListener("keydown", (e)=>{
      if(e.key==="Escape"){
        try{ closeWLModal(); }catch(_){}
        try{ closeResModal(); }catch(_){}
      }
    });
    qs("wlShowWin").addEventListener("click", ()=> fillWLModal("WIN"));
    qs("wlShowLoss").addEventListener("click", ()=> fillWLModal("LOSS"));
    qs("wlGoHistory").addEventListener("click", ()=>{ closeWLModal(); setTab("hist"); });

    /* ================= INIT ================= */
    (async function init() {
      const s = getSession();
      if (!s || !s.id) return logout();
      ME_ID = s.id;

      await ensureUserDefaults();

      const snap = await USERS.doc(ME_ID).get();
      if (!snap.exists) return logout();
      if (snap.data()?.isBlocked) return logout();

      await refreshTop();
      USERS.doc(ME_ID).onSnapshot(()=> refreshTop());

      await ensureGameDocExists("DragonTiger");
      await ensureGameDocExists("TeenPatti");
      await ensureGameDocExists("Roulette");

      subscribeGame("DragonTiger");
      subscribeGame("TeenPatti");
      subscribeGame("Roulette");

      setInterval(async () => {
        await finalizeIfNeeded("DragonTiger");
        await finalizeIfNeeded("TeenPatti");
        await finalizeIfNeeded("Roulette");
      }, 1000);

      setInterval(() => {
        if (state.DragonTiger) updateTimerUI("DragonTiger", state.DragonTiger);
        if (state.TeenPatti)  updateTimerUI("TeenPatti",  state.TeenPatti);
        if (state.Roulette)   updateTimerUI("Roulette",   state.Roulette);
      }, 200);

    })().catch((e) => {
      console.error("INIT ERROR:", e);
      alert(e?.message || e);
    });
  </script>
</body>
</html>

